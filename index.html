<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trial Management System</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            color: #333;
        }
        .header h1 {
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        /* Login/Register Modal Styles */
        .auth-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        .auth-modal {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            max-width: 400px;
            width: 90%;
            text-align: center;
        }
        .auth-tabs {
            display: flex;
            margin-bottom: 30px;
        }
        .auth-tab {
            flex: 1;
            padding: 12px;
            background: #f0f0f0;
            border: none;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        .auth-tab.active {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }
        .auth-tab:first-child {
            border-radius: 8px 0 0 8px;
        }
        .auth-tab:last-child {
            border-radius: 0 8px 8px 0;
        }
        .auth-form {
            display: none;
        }
        .auth-form.active {
            display: block;
        }
        .auth-input {
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 16px;
        }
        .auth-input:focus {
            border-color: #667eea;
            outline: none;
        }
        .auth-button {
            width: 100%;
            padding: 15px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 15px;
        }
        .auth-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }
        
        /* User Info Bar */
        .user-bar {
            text-align: right;
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .user-info {
            color: #2c5aa0;
            font-weight: bold;
        }
        .logout-btn {
            padding: 8px 15px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }
        .logout-btn:hover {
            background: #c82333;
        }
        
        /* My Trials Section */
        .my-trials {
            background: #e8f4f8;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .trial-item {
            background: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .trial-info {
            flex: 1;
        }
        .trial-name {
            font-weight: bold;
            color: #2c5aa0;
            margin-bottom: 5px;
        }
        .trial-meta {
            font-size: 14px;
            color: #666;
        }
        .trial-actions {
            display: flex;
            gap: 10px;
        }
        .edit-btn, .delete-btn {
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            font-size: 12px;
        }
        .edit-btn {
            background: #28a745;
            color: white;
        }
        .delete-btn {
            background: #dc3545;
            color: white;
        }
        .edit-btn:hover {
            background: #218838;
        }
        .delete-btn:hover {
            background: #c82333;
        }
        
        .nav-tabs {
            display: flex;
            border-bottom: 2px solid #e0e0e0;
            margin-bottom: 30px;
        }
        .nav-tab {
            padding: 15px 25px;
            background: #f0f0f0;
            border: 2px solid #d0d0d0;
            cursor: pointer;
            border-radius: 10px 10px 0 0;
            margin-right: 5px;
            font-weight: bold;
            transition: all 0.3s ease;
            color: #666;
        }
        .nav-tab:hover {
            background: #e8e8e8;
            border-color: #bbb;
            color: #333;
        }
        .nav-tab.active {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            transform: translateY(-2px);
            border-color: transparent;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .initial-question {
            background: #e8f4f8;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .day-container {
            border: 2px solid #2c5aa0;
            margin: 20px 0;
            padding: 20px;
            border-radius: 8px;
            background: #f8f9fa;
        }
        .day-header {
            background: #2c5aa0;
            color: white;
            padding: 10px 15px;
            margin: -20px -20px 20px -20px;
            border-radius: 6px 6px 0 0;
            font-weight: bold;
            font-size: 18px;
        }
        .classes-section {
            background: #fff3cd;
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
            border-left: 4px solid #ffc107;
        }
        .class-container {
            border: 1px solid #28a745;
            margin: 15px 0;
            padding: 15px;
            border-radius: 6px;
            background: #f8fff8;
        }
        .class-header {
            background: #28a745;
            color: white;
            padding: 8px 12px;
            margin: -15px -15px 15px -15px;
            border-radius: 4px 4px 0 0;
            font-weight: bold;
        }
        .rounds-section {
            background: #e7f3ff;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            border-left: 3px solid #007bff;
        }
        .form-group {
            display: flex;
            align-items: center;
            gap: 15px;
            margin: 10px 0;
            flex-wrap: wrap;
        }
        .label {
            font-weight: bold;
            margin-right: 10px;
        }
        
        /* Typeahead dropdown styles */
        .typeahead-container {
            position: relative;
            display: inline-block;
        }
        .typeahead-input {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
            width: 250px;
        }
        .typeahead-input:focus {
            border-color: #667eea;
            outline: none;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        .typeahead-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #e0e0e0;
            border-top: none;
            border-radius: 0 0 8px 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }
        .typeahead-item {
            padding: 10px 12px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
        }
        .typeahead-item:hover, .typeahead-item.highlighted {
            background: #f8f9fa;
        }
        .typeahead-item:last-child {
            border-bottom: none;
        }
        
        input, select {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        input:focus, select:focus {
            border-color: #667eea;
            outline: none;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        input[type="number"] { width: 100px; }
        input[type="text"] { width: 250px; }
        input[type="date"] { width: 180px; }
        select { width: 250px; }
        .yellow-highlight {
            background-color: #ffff99 !important;
        }
        button {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }
        
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #b8daff;
        }
        
        /* Results display styles */
        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .result-column {
            background: white;
            border-radius: 10px;
            border: 2px solid #e0e0e0;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .column-header {
            padding: 15px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            text-align: center;
        }
        .column-date {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .column-judge {
            font-size: 14px;
            margin-bottom: 5px;
        }
        .column-class-round {
            font-size: 14px;
        }
        .column-entries {
            padding: 15px;
        }
        .entry-item {
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
            font-size: 14px;
        }
        .entry-item:last-child {
            border-bottom: none;
        }
        .entry-type-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 5px;
        }
        .badge-regular {
            background: #28a745;
            color: white;
        }
        .badge-feo {
            background: #ffc107;
            color: #333;
        }

        .hidden {
            display: none;
        }

        .day-group {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #e0e0e0;
            margin-bottom: 20px;
        }
        .day-group-header {
            font-weight: bold;
            font-size: 16px;
            color: #2c5aa0;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid #2c5aa0;
        }
        .class-group {
            margin-bottom: 15px;
            padding: 10px;
            background: white;
            border-radius: 8px;
            border-left: 4px solid #28a745;
        }
        .class-group-header {
            font-weight: bold;
            color: #28a745;
            margin-bottom: 10px;
        }
        .trial-option {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #e0e0e0;
            margin-bottom: 8px;
            transition: all 0.3s ease;
        }
        .trial-option:hover {
            border-color: #667eea;
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }
        .trial-option label {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
        }
        .entry-type-options {
            display: flex;
            gap: 15px;
            margin-left: 20px;
        }
        .entry-type-options label {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 14px;
        }

        /* Running Order Management Styles */
        .running-order-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border: 2px solid #17a2b8;
        }
        .running-order-header {
            background: #17a2b8;
            color: white;
            padding: 12px 15px;
            margin: -20px -20px 20px -20px;
            border-radius: 8px 8px 0 0;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .class-round-group {
            background: white;
            border-radius: 8px;
            margin: 15px 0;
            border: 1px solid #dee2e6;
            overflow: hidden;
        }
        .class-round-header {
            background: #e9ecef;
            padding: 12px 15px;
            font-weight: bold;
            color: #495057;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .running-order-list {
            min-height: 60px;
            padding: 10px;
            background: #fdfdfe;
        }
        .draggable-entry {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 12px 15px;
            margin: 8px 0;
            cursor: move;
            transition: all 0.2s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
        }
        .draggable-entry:hover {
            border-color: #17a2b8;
            box-shadow: 0 2px 8px rgba(23, 162, 184, 0.2);
            transform: translateY(-1px);
        }
        .draggable-entry.dragging {
            opacity: 0.5;
            transform: rotate(3deg);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        .draggable-entry.drag-over {
            border-color: #28a745;
            border-width: 2px;
            background: #f8fff9;
        }
        .entry-info {
            flex: 1;
        }
        .entry-details {
            font-weight: bold;
            color: #333;
            margin-bottom: 4px;
        }
        .entry-meta {
            font-size: 12px;
            color: #666;
        }
        .entry-position {
            background: #17a2b8;
            color: white;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
        }
        .drag-handle {
            color: #6c757d;
            cursor: move;
            margin-left: 10px;
            font-size: 18px;
        }
        .conflict-warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 4px;
            padding: 8px 12px;
            margin: 10px 0;
            color: #856404;
            font-size: 14px;
        }
        .conflict-item {
            background: #f8d7da;
            border-left: 4px solid #dc3545;
        }
        .shuffle-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .shuffle-btn {
            background: #ffc107;
            color: #333;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
        }
        .shuffle-btn:hover {
            background: #e0a800;
        }
        .auto-fix-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
        }
        .auto-fix-btn:hover {
            background: #218838;
        }

        /* Score Sheets Styles */
        .score-sheet-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        .date-selection {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #dee2e6;
        }
        .date-checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .date-checkbox {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 6px;
            border: 1px solid #e9ecef;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .date-checkbox:hover {
            background: #e9ecef;
            border-color: #667eea;
        }
        .date-checkbox input[type="checkbox"] {
            width: 18px;
            height: 18px;
        }
        .date-info {
            flex: 1;
        }
        .date-name {
            font-weight: bold;
            color: #333;
        }
        .date-meta {
            font-size: 12px;
            color: #666;
        }
        .print-controls {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-top: 20px;
            padding: 15px;
            background: #e8f4f8;
            border-radius: 8px;
        }
        .print-btn {
            background: #28a745;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
        }
        .print-btn:hover {
            background: #218838;
        }
        .preview-btn {
            background: #17a2b8;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
        }
        .preview-btn:hover {
            background: #138496;
        }
        
        /* Print Preview Styles */
        .preview-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10000;
            display: none;
            justify-content: center;
            align-items: center;
        }
        .preview-content {
            background: white;
            width: 90%;
            height: 90%;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
        }
        .preview-header {
            padding: 15px 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            border-radius: 10px 10px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .preview-body {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }
        
        /* Score Sheet Print Styles */
        .score-sheet {
            background: white;
            margin-bottom: 30px;
            page-break-after: always;
            border: 2px solid #333;
        }
        .score-sheet-header {
            background: #f8f9fa;
            padding: 15px 20px;
            border-bottom: 2px solid #333;
            text-align: center;
        }
        .trial-info {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin-bottom: 15px;
        }
        .info-block {
            text-align: center;
        }
        .info-label {
            font-weight: bold;
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
        }
        .info-value {
            font-size: 16px;
            font-weight: bold;
            color: #333;
            margin-top: 5px;
        }
        .running-order-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .running-order-table th,
        .running-order-table td {
            border: 1px solid #333;
            padding: 8px 12px;
            text-align: left;
        }
        .running-order-table th {
            background: #f8f9fa;
            font-weight: bold;
            font-size: 14px;
        }
        .running-order-table td {
            height: 35px;
            vertical-align: top;
        }
        .position-col {
            width: 60px;
            text-align: center;
            font-weight: bold;
        }
        .reg-col {
            width: 120px;
        }
        .name-col {
            width: 150px;
        }
        .handler-col {
            width: 150px;
        }
        .score-col {
            width: 80px;
            text-align: center;
        }
        .placement-col {
            width: 80px;
            text-align: center;
        }
        
        /* Print Media Queries */
        @media print {
            body * {
                visibility: hidden;
            }
            .score-sheets-container,
            .score-sheets-container * {
                visibility: visible;
            }
            .score-sheets-container {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
            .score-sheet {
                page-break-after: always;
                margin-bottom: 0;
            }
            .score-sheet:last-child {
                page-break-after: avoid;
            }
        }
    </style>
</head>
<body>
    <!-- Authentication Modal -->
    <div id="authOverlay" class="auth-overlay">
        <div class="auth-modal">
            <h2>Welcome to Trial Management System</h2>
            
            <div class="auth-tabs">
                <button class="auth-tab active" onclick="showAuthTab('login', this)">Login</button>
                <button class="auth-tab" onclick="showAuthTab('register', this)">Register</button>
            </div>

            <!-- Login Form -->
            <form id="loginForm" class="auth-form active" onsubmit="handleLogin(event)">
                <input type="text" id="loginUsername" class="auth-input" placeholder="Username" required>
                <input type="password" id="loginPassword" class="auth-input" placeholder="Password" required>
                <button type="submit" class="auth-button">Login</button>
            </form>

            <!-- Register Form -->
            <form id="registerForm" class="auth-form" onsubmit="handleRegister(event)">
                <input type="text" id="regUsername" class="auth-input" placeholder="Choose Username" required>
                <input type="password" id="regPassword" class="auth-input" placeholder="Choose Password" required>
                <input type="password" id="regConfirmPassword" class="auth-input" placeholder="Confirm Password" required>
                <input type="text" id="regFullName" class="auth-input" placeholder="Full Name" required>
                <input type="email" id="regEmail" class="auth-input" placeholder="Email Address" required>
                <button type="submit" class="auth-button">Register</button>
            </form>
        </div>
    </div>

    <!-- Main Application -->
    <div id="mainApp" class="hidden">
        <!-- User Bar -->
        <div class="user-bar">
            <div class="user-info" id="userInfo"></div>
            <button class="logout-btn" onclick="logout()">Logout</button>
        </div>

        <div class="container">
            <div class="header">
                <h1>Trial Management System</h1>
                <p>Track judges across multiple days, classes, and rounds</p>
            </div>

            <!-- My Trials Section -->
            <div class="my-trials">
                <h3>My Trials</h3>
                <div id="myTrialsList"></div>
                <button onclick="createNewTrial()">Create New Trial</button>
            </div>

            <div class="nav-tabs">
                <button class="nav-tab active" onclick="showTab('setup', this)">Trial Setup</button>
                <button class="nav-tab" onclick="showTab('entry', this)">Entry Form</button>
                <button class="nav-tab" onclick="showTab('results', this)">Results</button>
                <button class="nav-tab" onclick="showTab('running-order', this)">Running Order</button>
                <button class="nav-tab" onclick="showTab('score-sheets', this)">Score Sheets</button>
            </div>

            <!-- Setup Tab -->
            <div id="setup" class="tab-content active">
                <div class="initial-question">
                    <h3 id="trialTitle">New Trial Setup</h3>
                    <div class="form-group">
                        <span class="label">Trial Name:</span>
                        <input type="text" id="trialName" placeholder="Enter trial name" style="width: 300px;">
                    </div>
                    <div class="form-group">
                        <span class="label">How many days in trial?</span>
                        <input type="number" id="trialDays" min="1" max="30" placeholder="Enter number">
                        <button type="button" onclick="generateDays()">Generate Days</button>
                    </div>
                </div>

                <div id="daysContainer"></div>
                
                <!-- Save Trial Section - Moved to end -->
                <div id="saveTrialSection" style="display: none; margin-top: 30px; padding: 25px; background: linear-gradient(135deg, #e8f4f8, #f0f8ff); border-radius: 12px; text-align: center; border: 2px solid #2c5aa0;">
                    <h3 style="color: #2c5aa0; margin-bottom: 15px;">üéØ Ready to Save Your Trial?</h3>
                    <p style="margin-bottom: 20px; color: #666;">All days have been configured. Review your trial setup and save to generate the entry form link.</p>
                    
                    <div class="form-group" style="justify-content: center; margin-bottom: 20px;">
                        <button type="button" onclick="saveTrialData()" style="font-size: 16px; padding: 15px 30px; background: linear-gradient(45deg, #28a745, #20c997);">üíæ Save Trial & Generate Entry Link</button>
                    </div>
                    
                    <p style="font-size: 14px; color: #666; margin: 0;">Once saved, you'll receive a shareable link for participant registration.</p>
                </div>

                <!-- Entry Form Link Section -->
                <div id="entryFormLink" style="display: none; margin-top: 20px; padding: 20px; background: #e8f4f8; border-radius: 8px; text-align: center;">
                    <h3 style="color: #2c5aa0;">üéâ Trial Setup Complete!</h3>
                    <p><strong>Share this URL for participants to register:</strong></p>
                    <div style="margin: 15px 0;">
                        <input type="text" id="shareableURL" readonly style="width: 100%; padding: 10px; font-family: monospace; background: #fff; border: 2px solid #2c5aa0; border-radius: 5px;">
                    </div>
                    <div style="margin: 10px 0;">
                        <button onclick="copyURL()" style="margin-right: 10px;">üìã Copy URL</button>
                        <button onclick="openEntryForm()">üîó Test Entry Form</button>
                    </div>
                    <p style="font-size: 14px; color: #666;">Participants can use this link to register for your trial. You can also copy this link from your trial dashboard.</p>
                </div>
            </div>

            <!-- Entry Form Tab -->
            <div id="entry" class="tab-content">
                <div class="initial-question">
                    <h3>Dog Entry Form</h3>
                    <form id="entryForm">
                        <div class="form-group">
                            <span class="label">Registration Number:</span>
                            <div class="typeahead-container">
                                <input type="text" id="regNumber" class="typeahead-input" 
                                       placeholder="Type registration number" 
                                       onkeyup="handleRegNumberTypeahead(this)" 
                                       onblur="hideRegNumberDropdown()" 
                                       onfocus="showRegNumberDropdown()">
                                <div id="regNumberDropdown" class="typeahead-dropdown"></div>
                            </div>
                            <span id="callName" style="margin-left: 15px; font-weight: bold; color: #666;">Call Name will appear here</span>
                        </div>

                        <div class="form-group">
                            <span class="label">Handler Name:</span>
                            <input type="text" id="handlerName" placeholder="Enter handler name">
                        </div>

                        <div class="form-group">
                            <span class="label">Select Trial(s):</span>
                            <div style="font-size: 12px; color: #666; margin-bottom: 10px;">You can select multiple trials for the same dog</div>
                        </div>

                        <div id="trialOptions"></div>

                        <div class="form-group">
                            <button type="button" onclick="submitEntry()">Submit Entry</button>
                            <button type="button" onclick="clearSelections()" style="background: #6c757d; margin-left: 10px;">Clear Selections</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Results Tab -->
            <div id="results" class="tab-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3>Trial Results</h3>
                    <button type="button" onclick="exportToCSV()">Export to CSV</button>
                </div>
                <div id="resultsContainer"></div>
            </div>

            <!-- Score Sheets Tab -->
            <div id="score-sheets" class="tab-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3>Score Sheets</h3>
                    <div>
                        <button type="button" onclick="selectAllDates()" style="background: #6c757d; margin-right: 10px;">Select All</button>
                        <button type="button" onclick="clearAllDates()" style="background: #6c757d;">Clear All</button>
                    </div>
                </div>
                
                <div class="score-sheet-section">
                    <div class="date-selection">
                        <h4>Select Dates to Print</h4>
                        <p>Choose which trial dates you want to generate score sheets for:</p>
                        <div id="dateSelectionContainer" class="date-checkbox-group"></div>
                        
                        <div class="print-controls">
                            <button class="preview-btn" onclick="previewScoreSheets()">üìÑ Preview Score Sheets</button>
                            <button class="print-btn" onclick="printScoreSheets()">üñ®Ô∏è Print Selected Sheets</button>
                            <div style="margin-left: auto; color: #666; font-size: 14px;">
                                <span id="selectedDatesCount">0 dates selected</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Running Order Tab -->
            <div id="running-order" class="tab-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3>Manage Running Order</h3>
                    <div>
                        <button type="button" onclick="resetAllRunningOrders()" style="background: #dc3545; margin-right: 10px;">Reset All Orders</button>
                        <button type="button" onclick="saveAllRunningOrders()">Save All Orders</button>
                    </div>
                </div>
                <div id="runningOrderContainer"></div>
            </div>
        </div>
    </div>

    <!-- Print Preview Modal -->
    <div id="previewModal" class="preview-modal">
        <div class="preview-content">
            <div class="preview-header">
                <h4>Score Sheets Preview</h4>
                <div>
                    <button onclick="printFromPreview()" class="print-btn" style="margin-right: 10px;">üñ®Ô∏è Print</button>
                    <button onclick="closePreview()" style="background: #6c757d; color: white; padding: 8px 15px; border: none; border-radius: 4px; cursor: pointer;">Close</button>
                </div>
            </div>
            <div class="preview-body">
                <div id="previewContent" class="score-sheets-container"></div>
            </div>
        </div>
    </div>
</body>
<script>
        // Global variables
        var currentUser = null;
        var currentTrialId = null;
        var dogData = [];
        var availableClasses = [];
        var availableJudges = [];
        var trialConfig = [];
        var entryResults = [];
        var runningOrders = {}; // New: Store custom running orders
        var totalDays = 0;
        var savedDays = 0;

        // Load JSON data automatically on page load
        function loadDogData() {
            var xhr = new XMLHttpRequest();
            xhr.open('GET', './data.json', true);
            xhr.onreadystatechange = function() {
                if (xhr.readyState === 4) {
                    if (xhr.status === 200) {
                        try {
                            var data = JSON.parse(xhr.responseText);
                            
                            if (Array.isArray(data) && data.length > 0) {
                                dogData = data;
                                availableClasses = getUniqueValues(data, 'className', 'class');
                                availableJudges = getUniqueValues(data, 'judge');
                                console.log('Dog data loaded successfully:', dogData.length, 'records');
                                showStatusMessage('Dog data loaded successfully!', 'success');
                            } else {
                                console.warn('JSON file appears to be empty or invalid format');
                                loadFallbackData();
                            }
                        } catch (error) {
                            console.error('Error parsing JSON data:', error);
                            loadFallbackData();
                        }
                    } else {
                        console.error('Could not load data.json');
                        loadFallbackData();
                    }
                }
            };
            xhr.send();
        }

        function getUniqueValues(data, field1, field2) {
            var values = [];
            for (var i = 0; i < data.length; i++) {
                var value = data[i][field1] || data[i][field2];
                if (value && values.indexOf(value) === -1) {
                    values.push(value);
                }
            }
            return values;
        }

        function loadFallbackData() {
            dogData = [
                { regNumber: "12345", callName: "Buddy" },
                { regNumber: "67890", callName: "Luna" },
                { regNumber: "11111", callName: "Max" },
                { regNumber: "22222", callName: "Bella" }
            ];
            availableClasses = ["Novice A", "Novice B", "Open A", "Open B", "Utility A", "Utility B"];
            availableJudges = ["Judge Smith", "Judge Johnson", "Judge Williams", "Judge Brown", "Judge Davis"];
            showStatusMessage('Using default data - could not load data.json', 'warning');
        }

        // Authentication functions
        function showAuthTab(tab, element) {
            var tabs = document.querySelectorAll('.auth-tab');
            for (var i = 0; i < tabs.length; i++) {
                tabs[i].classList.remove('active');
            }
            element.classList.add('active');
            
            var forms = document.querySelectorAll('.auth-form');
            for (var i = 0; i < forms.length; i++) {
                forms[i].classList.remove('active');
            }
            document.getElementById(tab + 'Form').classList.add('active');
        }

        function handleLogin(event) {
            event.preventDefault();
            
            var username = document.getElementById('loginUsername').value;
            var password = document.getElementById('loginPassword').value;
            var users = JSON.parse(localStorage.getItem('trialUsers') || '{}');
            
            if (users[username] && users[username].password === password) {
                currentUser = users[username];
                showMainApp();
                loadUserTrials();
            } else {
                alert('Invalid username or password');
            }
        }

        function handleRegister(event) {
            event.preventDefault();
            
            var username = document.getElementById('regUsername').value;
            var password = document.getElementById('regPassword').value;
            var confirmPassword = document.getElementById('regConfirmPassword').value;
            var fullName = document.getElementById('regFullName').value;
            var email = document.getElementById('regEmail').value;
            
            if (password !== confirmPassword) {
                alert('Passwords do not match');
                return;
            }
            
            var users = JSON.parse(localStorage.getItem('trialUsers') || '{}');
            
            if (users[username]) {
                alert('Username already exists');
                return;
            }
            
            users[username] = {
                username: username,
                password: password,
                fullName: fullName,
                email: email,
                created: new Date().toISOString()
            };
            
            localStorage.setItem('trialUsers', JSON.stringify(users));
            alert('Registration successful! Please login.');
            showAuthTab('login', document.querySelector('.auth-tab'));
        }

        function showMainApp() {
            document.getElementById('authOverlay').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            document.getElementById('userInfo').textContent = 'Welcome, ' + currentUser.fullName;
        }

        function logout() {
            currentUser = null;
            currentTrialId = null;
            document.getElementById('authOverlay').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');
            
            var inputs = document.querySelectorAll('input');
            for (var i = 0; i < inputs.length; i++) {
                inputs[i].value = '';
            }
        }

        // Trial management functions
        function loadUserTrials() {
            var userTrials = JSON.parse(localStorage.getItem('trials_' + currentUser.username) || '{}');
            var container = document.getElementById('myTrialsList');
            
            if (Object.keys(userTrials).length === 0) {
                container.innerHTML = '<p style="color: #666; font-style: italic;">No trials yet. Create your first trial!</p>';
                return;
            }
            
            var html = '';
            for (var trialId in userTrials) {
                if (userTrials.hasOwnProperty(trialId)) {
                    var trial = userTrials[trialId];
                    var created = new Date(trial.created).toLocaleDateString();
                    var days = trial.config ? getUniqueDays(trial.config).length : 0;
                    
                    // Get current entry count by syncing with public storage
                    var publicTrials = JSON.parse(localStorage.getItem('publicTrials') || '{}');
                    var userEntries = trial.results || [];
                    var publicEntries = (publicTrials[trialId] && publicTrials[trialId].results) ? publicTrials[trialId].results : [];
                    var totalEntries = mergeEntries(userEntries, publicEntries).length;
                    
                    var trialName = trial.name || 'Untitled Trial';
                    var trialStatus = (trial.config && trial.config.length > 0) ? 'Configured' : 'Setup Incomplete';
                    var statusColor = (trial.config && trial.config.length > 0) ? '#28a745' : '#ffc107';
                    
                    html += '<div class="trial-item">' +
                        '<div class="trial-info">' +
                        '<div class="trial-name">' + trialName + '</div>' +
                        '<div class="trial-meta">Created: ' + created + ' | Days: ' + days + ' | Entries: ' + totalEntries + '</div>' +
                        '<div class="trial-status" style="color: ' + statusColor + '; font-size: 12px; font-weight: bold;">' + trialStatus + '</div>' +
                        '</div>' +
                        '<div class="trial-actions">' +
                        '<button class="edit-btn" onclick="editTrial(\'' + trialId + '\')">Edit</button>';
                    
                    // Add Copy Link button if trial is configured
                    if (trial.config && trial.config.length > 0) {
                        html += '<button class="edit-btn" onclick="copyTrialLink(\'' + trialId + '\')" style="background: #17a2b8;">Copy Link</button>';
                    }
                    
                    html += '<button class="delete-btn" onclick="deleteTrial(\'' + trialId + '\')">Delete</button>' +
                        '</div>' +
                        '</div>';
                }
            }
            container.innerHTML = html;
        }

        function copyTrialLink(trialId) {
            var baseURL = window.location.origin + window.location.pathname;
            var shareableURL = baseURL + '?trial=' + trialId + '&mode=entry';
            
            // Create temporary input to copy text
            var tempInput = document.createElement('input');
            tempInput.value = shareableURL;
            document.body.appendChild(tempInput);
            tempInput.select();
            tempInput.setSelectionRange(0, 99999);
            
            try {
                document.execCommand('copy');
                showStatusMessage('Entry form link copied to clipboard!', 'success');
            } catch (err) {
                showStatusMessage('Could not copy link. URL: ' + shareableURL, 'warning');
            }
            
            document.body.removeChild(tempInput);
        }

        function getUniqueDays(config) {
            var days = [];
            for (var i = 0; i < config.length; i++) {
                if (days.indexOf(config[i].day) === -1) {
                    days.push(config[i].day);
                }
            }
            return days;
        }

        function createNewTrial() {
            currentTrialId = 'trial_' + Date.now();
            document.getElementById('trialTitle').textContent = 'New Trial Setup';
            document.getElementById('trialName').value = '';
            document.getElementById('trialDays').value = '';
            document.getElementById('daysContainer').innerHTML = '';
            trialConfig = [];
            entryResults = [];
            updateTrialOptions();
            updateResultsDisplay();
            showTab('setup', document.querySelector('.nav-tab'));
        }

        function editTrial(trialId) {
            var userTrials = JSON.parse(localStorage.getItem('trials_' + currentUser.username) || '{}');
            var trial = userTrials[trialId];
            
            if (!trial) {
                alert('Trial not found');
                return;
            }
            
            currentTrialId = trialId;
            document.getElementById('trialTitle').textContent = 'Editing: ' + (trial.name || 'Untitled Trial');
            document.getElementById('trialName').value = trial.name || '';
            
            trialConfig = trial.config || [];
            runningOrders = trial.runningOrders || {}; // Load saved running orders
            
            // Load entries from both user storage and public storage, then merge
            var userEntries = trial.results || [];
            var publicTrials = JSON.parse(localStorage.getItem('publicTrials') || '{}');
            var publicEntries = (publicTrials[trialId] && publicTrials[trialId].results) ? publicTrials[trialId].results : [];
            
            // Merge entries and remove duplicates based on timestamp
            entryResults = mergeEntries(userEntries, publicEntries);
            
            // Save merged entries back to user storage
            userTrials[trialId].results = entryResults;
            localStorage.setItem('trials_' + currentUser.username, JSON.stringify(userTrials));
            
            if (trialConfig.length > 0) {
                var maxDay = getMaxDay(trialConfig);
                document.getElementById('trialDays').value = maxDay;
                generateDays();
                
                setTimeout(function() {
                    populateExistingTrialData();
                }, 100);
            }
            
            updateTrialOptions();
            updateResultsDisplay();
            showTab('setup', document.querySelector('.nav-tab'));
        }

        function mergeEntries(userEntries, publicEntries) {
            var merged = [];
            var timestamps = {};
            
            // Add user entries first
            for (var i = 0; i < userEntries.length; i++) {
                merged.push(userEntries[i]);
                timestamps[userEntries[i].timestamp] = true;
            }
            
            // Add public entries that don't already exist
            for (var i = 0; i < publicEntries.length; i++) {
                if (!timestamps[publicEntries[i].timestamp]) {
                    merged.push(publicEntries[i]);
                    timestamps[publicEntries[i].timestamp] = true;
                }
            }
            
            return merged;
        }

        function getMaxDay(config) {
            var max = 0;
            for (var i = 0; i < config.length; i++) {
                if (config[i].day > max) {
                    max = config[i].day;
                }
            }
            return max;
        }

        function populateExistingTrialData() {
            for (var i = 0; i < trialConfig.length; i++) {
                var config = trialConfig[i];
                var dayNum = config.day;
                var dateInput = document.getElementById('date_' + dayNum);
                if (dateInput) {
                    dateInput.value = config.date;
                }
                
                var classInput = document.getElementById('class_' + dayNum + '_' + config.classNum);
                if (classInput) {
                    classInput.value = config.className;
                }
                
                var judgeInput = document.getElementById('judge_' + dayNum + '_' + config.classNum + '_' + config.roundNum);
                if (judgeInput) {
                    judgeInput.value = config.judge;
                }
                
                var feoInput = document.getElementById('feo_' + dayNum + '_' + config.classNum + '_' + config.roundNum);
                if (feoInput) {
                    feoInput.checked = config.feoOffered || false;
                }
            }
        }

        function deleteTrial(trialId) {
            if (confirm('Are you sure you want to delete this trial? This action cannot be undone.')) {
                var userTrials = JSON.parse(localStorage.getItem('trials_' + currentUser.username) || '{}');
                delete userTrials[trialId];
                localStorage.setItem('trials_' + currentUser.username, JSON.stringify(userTrials));
                loadUserTrials();
            }
        }

        function saveTrialData() {
            if (!currentUser) {
                alert("Please log in first.");
                return;
            }
            
            if (!currentTrialId) {
                alert("Please create a new trial first.");
                return;
            }
            
            var trialName = document.getElementById('trialName').value.trim();
            if (!trialName) {
                alert("Please enter a trial name.");
                return;
            }

            if (trialConfig.length === 0) {
                alert("Please configure at least one day before saving the trial.");
                return;
            }
            
            var userTrials = JSON.parse(localStorage.getItem('trials_' + currentUser.username) || '{}');
            
            var trialData = {
                name: trialName,
                config: trialConfig,
                results: entryResults,
                owner: currentUser.username,
                created: userTrials[currentTrialId] && userTrials[currentTrialId].created ? userTrials[currentTrialId].created : new Date().toISOString(),
                updated: new Date().toISOString()
            };
            
            userTrials[currentTrialId] = trialData;
            localStorage.setItem('trials_' + currentUser.username, JSON.stringify(userTrials));
            
            var publicTrials = JSON.parse(localStorage.getItem('publicTrials') || '{}');
            publicTrials[currentTrialId] = trialData;
            localStorage.setItem('publicTrials', JSON.stringify(publicTrials));
            
            generateShareableURL();
            document.getElementById('entryFormLink').style.display = 'block';
            showStatusMessage("Trial saved successfully!", "success");
            loadUserTrials();
        }

        // Tab functions
        function showTab(tabName, element) {
            var tabs = document.querySelectorAll('.nav-tab');
            for (var i = 0; i < tabs.length; i++) {
                tabs[i].classList.remove('active');
            }
            if (element) {
                element.classList.add('active');
            }
            
            var contents = document.querySelectorAll('.tab-content');
            for (var i = 0; i < contents.length; i++) {
                contents[i].classList.remove('active');
            }
            document.getElementById(tabName).classList.add('active');
            
            // If switching to Results tab, sync entries from public storage
            if (tabName === 'results' && currentTrialId && currentUser) {
                syncEntriesFromPublic();
            }
            
            // If switching to Running Order tab, load running orders
            if (tabName === 'running-order' && currentTrialId) {
                loadRunningOrderManagement();
            }
            
            // If switching to Score Sheets tab, load date selection
            if (tabName === 'score-sheets' && currentTrialId) {
                loadScoreSheetsManagement();
            }
        }

        function syncEntriesFromPublic() {
            if (!currentTrialId || !currentUser) return;
            
            var userTrials = JSON.parse(localStorage.getItem('trials_' + currentUser.username) || '{}');
            var publicTrials = JSON.parse(localStorage.getItem('publicTrials') || '{}');
            
            if (userTrials[currentTrialId] && publicTrials[currentTrialId]) {
                var userEntries = userTrials[currentTrialId].results || [];
                var publicEntries = publicTrials[currentTrialId].results || [];
                
                // Merge entries
                entryResults = mergeEntries(userEntries, publicEntries);
                
                // Save back to user storage
                userTrials[currentTrialId].results = entryResults;
                userTrials[currentTrialId].updated = new Date().toISOString();
                localStorage.setItem('trials_' + currentUser.username, JSON.stringify(userTrials));
                
                // Update display
                updateResultsDisplay();
                
                // Update trial count in dashboard
                loadUserTrials();
            }
        }

        // Trial setup functions
        function generateDays() {
            var numDays = parseInt(document.getElementById('trialDays').value);
            if (!numDays || numDays < 1) {
                alert('Please enter a valid number of days');
                return;
            }

            totalDays = numDays;
            savedDays = 0;
            var container = document.getElementById('daysContainer');
            container.innerHTML = '';

            for (var i = 1; i <= numDays; i++) {
                createDaySection(i, container);
            }
        }

        function createDaySection(dayNum, container) {
            var dayDiv = document.createElement('div');
            dayDiv.className = 'day-container';
            dayDiv.innerHTML = '<div class="day-header">Day ' + dayNum + '</div>' +
                '<div class="form-group">' +
                '<span class="label">Date for Day ' + dayNum + ':</span>' +
                '<input type="date" id="date_' + dayNum + '">' +
                '</div>' +
                '<div class="classes-section">' +
                '<div class="form-group">' +
                '<span class="label">How many classes this day?</span>' +
                '<input type="number" id="classes_' + dayNum + '" min="1" max="20" class="yellow-highlight" placeholder="Number" onchange="generateClasses(' + dayNum + ')">' +
                '</div>' +
                '<div id="classesContainer_' + dayNum + '"></div>' +
                '</div>' +
                '<div class="form-group">' +
                '<button onclick="saveTrialDay(' + dayNum + ')">Save Day ' + dayNum + '</button>' +
                '</div>';
            container.appendChild(dayDiv);
        }

        function generateClasses(dayNum) {
            var numClasses = parseInt(document.getElementById('classes_' + dayNum).value);
            if (!numClasses || numClasses < 1) return;

            var container = document.getElementById('classesContainer_' + dayNum);
            container.innerHTML = '';

            for (var i = 1; i <= numClasses; i++) {
                createClassSection(dayNum, i, container);
            }
        }

        function createClassSection(dayNum, classNum, container) {
            var classDiv = document.createElement('div');
            classDiv.className = 'class-container';
            
            classDiv.innerHTML = '<div class="class-header">Class ' + classNum + '</div>' +
                '<div class="form-group">' +
                '<span class="label">Class Name:</span>' +
                '<div class="typeahead-container">' +
                '<input type="text" id="class_' + dayNum + '_' + classNum + '" class="typeahead-input" placeholder="Type or select class name" onkeyup="handleClassTypeahead(this, ' + dayNum + ', ' + classNum + ')" onblur="hideClassDropdown(' + dayNum + ', ' + classNum + ')" onfocus="showClassDropdown(' + dayNum + ', ' + classNum + ')">' +
                '<div id="classDropdown_' + dayNum + '_' + classNum + '" class="typeahead-dropdown"></div>' +
                '</div>' +
                '</div>' +
                '<div class="rounds-section">' +
                '<div class="form-group">' +
                '<span class="label">How many rounds?</span>' +
                '<input type="number" id="rounds_' + dayNum + '_' + classNum + '" min="1" max="10" placeholder="Number" onchange="generateRounds(' + dayNum + ', ' + classNum + ')">' +
                '</div>' +
                '<div id="roundsContainer_' + dayNum + '_' + classNum + '"></div>' +
                '</div>';
            container.appendChild(classDiv);
        }

        function handleClassTypeahead(input, dayNum, classNum) {
            var query = input.value.toLowerCase();
            var dropdown = document.getElementById('classDropdown_' + dayNum + '_' + classNum);
            
            if (query.length === 0) {
                dropdown.style.display = 'none';
                return;
            }

            var matches = [];
            for (var i = 0; i < availableClasses.length; i++) {
                if (availableClasses[i].toLowerCase().indexOf(query) !== -1) {
                    matches.push(availableClasses[i]);
                }
            }

            if (matches.length > 0) {
                var html = '';
                for (var i = 0; i < matches.length; i++) {
                    html += '<div class="typeahead-item" onclick="selectClass(\'' + matches[i] + '\', ' + dayNum + ', ' + classNum + ')">' + matches[i] + '</div>';
                }
                dropdown.innerHTML = html;
                dropdown.style.display = 'block';
            } else {
                dropdown.style.display = 'none';
            }
        }

        function selectClass(className, dayNum, classNum) {
            document.getElementById('class_' + dayNum + '_' + classNum).value = className;
            document.getElementById('classDropdown_' + dayNum + '_' + classNum).style.display = 'none';
        }

        function hideClassDropdown(dayNum, classNum) {
            setTimeout(function() {
                document.getElementById('classDropdown_' + dayNum + '_' + classNum).style.display = 'none';
            }, 200);
        }

        function showClassDropdown(dayNum, classNum) {
            var input = document.getElementById('class_' + dayNum + '_' + classNum);
            if (input.value.length > 0) {
                handleClassTypeahead(input, dayNum, classNum);
            } else {
                var dropdown = document.getElementById('classDropdown_' + dayNum + '_' + classNum);
                var html = '';
                for (var i = 0; i < availableClasses.length; i++) {
                    html += '<div class="typeahead-item" onclick="selectClass(\'' + availableClasses[i] + '\', ' + dayNum + ', ' + classNum + ')">' + availableClasses[i] + '</div>';
                }
                dropdown.innerHTML = html;
                dropdown.style.display = 'block';
            }
        }

        function updateClassSelect(input, dayNum, classNum) {
            // This function is no longer needed since we're using typeahead
        }

        function generateRounds(dayNum, classNum) {
            var numRounds = parseInt(document.getElementById('rounds_' + dayNum + '_' + classNum).value);
            if (!numRounds || numRounds < 1) return;

            var container = document.getElementById('roundsContainer_' + dayNum + '_' + classNum);
            container.innerHTML = '';

            for (var i = 1; i <= numRounds; i++) {
                var roundDiv = document.createElement('div');
                roundDiv.style.margin = '10px 0';
                roundDiv.style.padding = '10px';
                roundDiv.style.background = '#f8f9fa';
                roundDiv.style.borderRadius = '5px';
                
                roundDiv.innerHTML = '<div class="form-group">' +
                    '<span class="label">Round ' + i + ' Judge:</span>' +
                    '<div class="typeahead-container">' +
                    '<input type="text" id="judge_' + dayNum + '_' + classNum + '_' + i + '" class="typeahead-input" placeholder="Type or select judge name" onkeyup="handleJudgeTypeahead(this, ' + dayNum + ', ' + classNum + ', ' + i + ')" onblur="hideJudgeDropdown(' + dayNum + ', ' + classNum + ', ' + i + ')" onfocus="showJudgeDropdown(' + dayNum + ', ' + classNum + ', ' + i + ')">' +
                    '<div id="judgeDropdown_' + dayNum + '_' + classNum + '_' + i + '" class="typeahead-dropdown"></div>' +
                    '</div>' +
                    '</div>' +
                    '<div class="form-group">' +
                    '<label style="display: flex; align-items: center; gap: 8px;">' +
                    '<input type="checkbox" id="feo_' + dayNum + '_' + classNum + '_' + i + '">' +
                    '<span>FEO (For Exhibition Only) available for this round</span>' +
                    '</label>' +
                    '</div>';
                container.appendChild(roundDiv);
            }
        }

        function handleJudgeTypeahead(input, dayNum, classNum, roundNum) {
            var query = input.value.toLowerCase();
            var dropdown = document.getElementById('judgeDropdown_' + dayNum + '_' + classNum + '_' + roundNum);
            
            if (query.length === 0) {
                dropdown.style.display = 'none';
                return;
            }

            var matches = [];
            for (var i = 0; i < availableJudges.length; i++) {
                if (availableJudges[i].toLowerCase().indexOf(query) !== -1) {
                    matches.push(availableJudges[i]);
                }
            }

            if (matches.length > 0) {
                var html = '';
                for (var i = 0; i < matches.length; i++) {
                    html += '<div class="typeahead-item" onclick="selectJudge(\'' + matches[i] + '\', ' + dayNum + ', ' + classNum + ', ' + roundNum + ')">' + matches[i] + '</div>';
                }
                dropdown.innerHTML = html;
                dropdown.style.display = 'block';
            } else {
                dropdown.style.display = 'none';
            }
        }

        function selectJudge(judgeName, dayNum, classNum, roundNum) {
            document.getElementById('judge_' + dayNum + '_' + classNum + '_' + roundNum).value = judgeName;
            document.getElementById('judgeDropdown_' + dayNum + '_' + classNum + '_' + roundNum).style.display = 'none';
        }

        function hideJudgeDropdown(dayNum, classNum, roundNum) {
            setTimeout(function() {
                document.getElementById('judgeDropdown_' + dayNum + '_' + classNum + '_' + roundNum).style.display = 'none';
            }, 200);
        }

        function showJudgeDropdown(dayNum, classNum, roundNum) {
            var input = document.getElementById('judge_' + dayNum + '_' + classNum + '_' + roundNum);
            if (input.value.length > 0) {
                handleJudgeTypeahead(input, dayNum, classNum, roundNum);
            } else {
                var dropdown = document.getElementById('judgeDropdown_' + dayNum + '_' + classNum + '_' + roundNum);
                var html = '';
                for (var i = 0; i < availableJudges.length; i++) {
                    html += '<div class="typeahead-item" onclick="selectJudge(\'' + availableJudges[i] + '\', ' + dayNum + ', ' + classNum + ', ' + roundNum + ')">' + availableJudges[i] + '</div>';
                }
                dropdown.innerHTML = html;
                dropdown.style.display = 'block';
            }
        }

        function updateJudgeSelect(input, dayNum, classNum, roundNum) {
            // This function is no longer needed since we're using typeahead
        }

        function saveTrialDay(dayNum) {
            var date = document.getElementById('date_' + dayNum).value;
            if (!date) {
                alert('Please set the date for Day ' + dayNum);
                return;
            }

            var numClasses = parseInt(document.getElementById('classes_' + dayNum).value);
            if (!numClasses) {
                alert('Please set the number of classes for Day ' + dayNum);
                return;
            }

            trialConfig = trialConfig.filter(function(config) {
                return config.day !== dayNum;
            });

            for (var classNum = 1; classNum <= numClasses; classNum++) {
                var className = document.getElementById('class_' + dayNum + '_' + classNum).value.trim();
                if (!className) {
                    alert('Please enter a class name for Day ' + dayNum + ', Class ' + classNum);
                    return;
                }

                var numRounds = parseInt(document.getElementById('rounds_' + dayNum + '_' + classNum).value);
                if (!numRounds) {
                    alert('Please set the number of rounds for Day ' + dayNum + ', Class ' + classNum);
                    return;
                }

                for (var roundNum = 1; roundNum <= numRounds; roundNum++) {
                    var judge = document.getElementById('judge_' + dayNum + '_' + classNum + '_' + roundNum).value.trim();
                    if (!judge) {
                        alert('Please enter a judge name for Day ' + dayNum + ', Class ' + classNum + ', Round ' + roundNum);
                        return;
                    }

                    var feoOffered = document.getElementById('feo_' + dayNum + '_' + classNum + '_' + roundNum).checked;

                    trialConfig.push({
                        day: dayNum,
                        date: date,
                        classNum: classNum,
                        className: className,
                        roundNum: roundNum,
                        judge: judge,
                        feoOffered: feoOffered
                    });
                }
            }

            savedDays++;
            updateTrialOptions();
            showStatusMessage('Day ' + dayNum + ' configuration saved!', 'success');

            // Check if all days are saved and show save trial button
            if (savedDays === totalDays) {
                document.getElementById('saveTrialSection').style.display = 'block';
                showStatusMessage('All days configured! Please review and save your trial.', 'info');
            }
        }

        function updateTrialOptions() {
            var container = document.getElementById('trialOptions');
            
            if (trialConfig.length === 0) {
                container.innerHTML = '<p style="color: #666; font-style: italic;">Please complete trial setup first.</p>';
                return;
            }
            
            var groupedByDay = {};
            for (var i = 0; i < trialConfig.length; i++) {
                var config = trialConfig[i];
                if (!groupedByDay[config.day]) {
                    groupedByDay[config.day] = {};
                }
                if (!groupedByDay[config.day][config.className]) {
                    groupedByDay[config.day][config.className] = [];
                }
                groupedByDay[config.day][config.className].push(config);
            }

            for (var day in groupedByDay) {
                for (var className in groupedByDay[day]) {
                    groupedByDay[day][className].sort(function(a, b) {
                        return a.roundNum - b.roundNum;
                    });
                }
            }

            var html = '';
            var sortedDays = Object.keys(groupedByDay).sort(function(a, b) {
                return parseInt(a) - parseInt(b);
            });
            
            for (var d = 0; d < sortedDays.length; d++) {
                var day = sortedDays[d];
                var firstClass = Object.keys(groupedByDay[day])[0];
                var firstConfig = groupedByDay[day][firstClass][0];
                
                html += '<div class="day-group">';
                html += '<div class="day-group-header">Day ' + day + ' - ' + firstConfig.date + '</div>';
                
                var sortedClasses = Object.keys(groupedByDay[day]).sort();
                
                for (var c = 0; c < sortedClasses.length; c++) {
                    var className = sortedClasses[c];
                    html += '<div class="class-group">';
                    html += '<div class="class-group-header">' + className + '</div>';
                    
                    var configs = groupedByDay[day][className];
                    for (var i = 0; i < configs.length; i++) {
                        var config = configs[i];
                        var configIndex = -1;
                        for (var j = 0; j < trialConfig.length; j++) {
                            if (trialConfig[j].day === config.day && 
                                trialConfig[j].classNum === config.classNum && 
                                trialConfig[j].roundNum === config.roundNum) {
                                configIndex = j;
                                break;
                            }
                        }
                        
                        html += '<div class="trial-option">' +
                            '<div style="font-weight: bold; margin-bottom: 8px;">' +
                            'Round ' + config.roundNum + ' - ' + config.judge +
                            '</div>' +
                            '<div style="margin-bottom: 10px;">' +
                            '<label style="margin-right: 15px;">' +
                            '<input type="checkbox" name="trialSelection" value="' + configIndex + '-regular"> Regular Entry' +
                            '</label>';
                        
                        if (config.feoOffered) {
                            html += '<label>' +
                                '<input type="checkbox" name="trialSelection" value="' + configIndex + '-feo"> FEO Entry' +
                                '</label>';
                        }
                        
                        html += '</div></div>';
                    }
                    html += '</div>';
                }
                html += '</div>';
            }
            container.innerHTML = html;
        }

        // Entry form functions
        function handleRegNumberTypeahead(input) {
            var query = input.value.toLowerCase();
            var dropdown = document.getElementById('regNumberDropdown');
            
            if (query.length === 0) {
                dropdown.style.display = 'none';
                document.getElementById('callName').textContent = 'Call Name will appear here';
                document.getElementById('callName').style.color = '#666';
                return;
            }

            var matches = [];
            for (var i = 0; i < dogData.length; i++) {
                var dog = dogData[i];
                if (dog.regNumber.toLowerCase().indexOf(query) !== -1 || 
                    dog.callName.toLowerCase().indexOf(query) !== -1) {
                    matches.push(dog);
                }
            }

            if (matches.length > 0) {
                var html = '';
                for (var i = 0; i < matches.length; i++) {
                    var dog = matches[i];
                    html += '<div class="typeahead-item" onclick="selectRegNumber(\'' + dog.regNumber + '\', \'' + dog.callName + '\')">' + dog.regNumber + ' - ' + dog.callName + '</div>';
                }
                dropdown.innerHTML = html;
                dropdown.style.display = 'block';

                for (var i = 0; i < matches.length; i++) {
                    if (matches[i].regNumber.toLowerCase() === query) {
                        document.getElementById('callName').textContent = matches[i].callName;
                        document.getElementById('callName').style.color = '#28a745';
                        break;
                    }
                }
            } else {
                dropdown.style.display = 'none';
                document.getElementById('callName').textContent = 'Not found';
                document.getElementById('callName').style.color = '#dc3545';
            }
        }

        function selectRegNumber(regNumber, callName) {
            document.getElementById('regNumber').value = regNumber;
            document.getElementById('callName').textContent = callName;
            document.getElementById('callName').style.color = '#28a745';
            document.getElementById('regNumberDropdown').style.display = 'none';
        }

        function hideRegNumberDropdown() {
            setTimeout(function() {
                document.getElementById('regNumberDropdown').style.display = 'none';
            }, 200);
        }

        function showRegNumberDropdown() {
            var input = document.getElementById('regNumber');
            if (input.value.length > 0) {
                handleRegNumberTypeahead(input);
            }
        }

        function submitEntry() {
            var regNumber = document.getElementById('regNumber').value.trim();
            var handlerName = document.getElementById('handlerName').value.trim();
            var selectedTrials = document.querySelectorAll('input[name="trialSelection"]:checked');

            if (!regNumber) {
                alert('Please enter a registration number');
                return;
            }

            if (!handlerName) {
                alert('Please enter handler name');
                return;
            }

            if (selectedTrials.length === 0) {
                alert('Please select at least one trial');
                return;
            }

            var dog = null;
            for (var i = 0; i < dogData.length; i++) {
                if (dogData[i].regNumber === regNumber) {
                    dog = dogData[i];
                    break;
                }
            }
            var callName = dog ? dog.callName : 'Unknown';

            for (var i = 0; i < selectedTrials.length; i++) {
                var selectionValue = selectedTrials[i].value;
                var parts = selectionValue.split('-');
                var configIndex = parseInt(parts[0]);
                var entryType = parts[1];
                var config = trialConfig[configIndex];

                var entry = {
                    regNumber: regNumber,
                    callName: callName,
                    handler: handlerName,
                    day: config.day,
                    date: config.date,
                    className: config.className,
                    round: config.roundNum,
                    judge: config.judge,
                    entryType: entryType,
                    timestamp: new Date().toISOString()
                };

                entryResults.push(entry);
            }

            // Save entries back to trial data immediately
            saveEntriesToTrial();
            updateResultsDisplay();
            
            document.getElementById('regNumber').value = '';
            document.getElementById('handlerName').value = '';
            document.getElementById('callName').textContent = 'Call Name will appear here';
            document.getElementById('callName').style.color = '#666';
            clearSelections();

            showStatusMessage('Entry(s) submitted successfully! (' + selectedTrials.length + ' trial(s))', 'success');
        }

        function saveEntriesToTrial() {
            if (!currentTrialId) return;
            
            // Save to user's trials if logged in
            if (currentUser) {
                var userTrials = JSON.parse(localStorage.getItem('trials_' + currentUser.username) || '{}');
                if (userTrials[currentTrialId]) {
                    userTrials[currentTrialId].results = entryResults;
                    userTrials[currentTrialId].updated = new Date().toISOString();
                    localStorage.setItem('trials_' + currentUser.username, JSON.stringify(userTrials));
                }
            }
            
            // Always save to public trials for entry form access
            var publicTrials = JSON.parse(localStorage.getItem('publicTrials') || '{}');
            if (publicTrials[currentTrialId]) {
                publicTrials[currentTrialId].results = entryResults;
                publicTrials[currentTrialId].updated = new Date().toISOString();
                localStorage.setItem('publicTrials', JSON.stringify(publicTrials));
            }
        }

        function clearSelections() {
            var checkboxes = document.querySelectorAll('input[name="trialSelection"]');
            for (var i = 0; i < checkboxes.length; i++) {
                checkboxes[i].checked = false;
            }
        }

        // URL Generation and sharing functions
        function generateShareableURL() {
            if (!currentTrialId) return;
            
            var baseURL = window.location.origin + window.location.pathname;
            var shareableURL = baseURL + '?trial=' + currentTrialId + '&mode=entry';
            
            var urlInput = document.getElementById('shareableURL');
            if (urlInput) {
                urlInput.value = shareableURL;
            }
        }

        function copyURL() {
            var urlInput = document.getElementById('shareableURL');
            urlInput.select();
            urlInput.setSelectionRange(0, 99999);
            
            try {
                document.execCommand('copy');
                showStatusMessage('URL copied to clipboard!', 'success');
            } catch (err) {
                showStatusMessage('Could not copy URL. Please copy manually.', 'warning');
            }
        }

        function openEntryForm() {
            var urlInput = document.getElementById('shareableURL');
            if (urlInput.value) {
                window.open(urlInput.value, '_blank');
            }
        }

        // Handle URL parameters for direct entry form access
        function handleURLParameters() {
            var urlParams = new URLSearchParams(window.location.search);
            var trialId = urlParams.get('trial');
            var mode = urlParams.get('mode');
            
            if (trialId && mode === 'entry') {
                loadTrialForEntry(trialId);
                return true;
            }
            return false;
        }

        function loadTrialForEntry(trialId) {
            var publicTrials = JSON.parse(localStorage.getItem('publicTrials') || '{}');
            var trial = publicTrials[trialId];
            
            if (!trial) {
                alert('Trial not found or no longer available');
                return;
            }
            
            currentTrialId = trialId;
            trialConfig = trial.config || [];
            entryResults = trial.results || [];
            
            document.getElementById('authOverlay').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            document.getElementById('userInfo').textContent = 'Entry Form: ' + (trial.name || 'Trial');
            
            document.querySelector('.my-trials').style.display = 'none';
            document.querySelector('.logout-btn').style.display = 'none';
            
            updateTrialOptions();
            showTab('entry', document.querySelectorAll('.nav-tab')[1]);
            
            document.querySelectorAll('.nav-tab')[0].style.display = 'none';
            document.querySelectorAll('.nav-tab')[2].style.display = 'none';
            
            // Add a refresh button for public users to see updated entry counts
            var entryFormHeader = document.querySelector('#entry .initial-question h3');
            if (entryFormHeader && !document.getElementById('refreshEntriesBtn')) {
                var refreshBtn = document.createElement('button');
                refreshBtn.id = 'refreshEntriesBtn';
                refreshBtn.textContent = 'Refresh Entry Count';
                refreshBtn.style.marginLeft = '20px';
                refreshBtn.style.fontSize = '12px';
                refreshBtn.style.padding = '5px 10px';
                refreshBtn.onclick = function() {
                    var publicTrials = JSON.parse(localStorage.getItem('publicTrials') || '{}');
                    if (publicTrials[currentTrialId]) {
                        entryResults = publicTrials[currentTrialId].results || [];
                        showStatusMessage('Entry count updated: ' + entryResults.length + ' total entries', 'info');
                    }
                };
                entryFormHeader.appendChild(refreshBtn);
            }
        }

        // Results functions
        function updateResultsDisplay() {
            var container = document.getElementById('resultsContainer');
            
            if (entryResults.length === 0) {
                container.innerHTML = '<p style="color: #666; font-style: italic;">No entries yet.</p>';
                return;
            }

            var groupedResults = {};
            for (var i = 0; i < entryResults.length; i++) {
                var entry = entryResults[i];
                var key = entry.date + '-' + entry.className + '-' + entry.round;
                if (!groupedResults[key]) {
                    groupedResults[key] = {
                        date: entry.date,
                        className: entry.className,
                        round: entry.round,
                        judge: entry.judge,
                        entries: []
                    };
                }
                groupedResults[key].entries.push(entry);
            }

            var html = '<div class="results-grid">';
            
            var sortedGroups = [];
            for (var key in groupedResults) {
                sortedGroups.push(groupedResults[key]);
            }
            
            sortedGroups.sort(function(a, b) {
                if (a.date !== b.date) return new Date(a.date) - new Date(b.date);
                if (a.className !== b.className) return a.className.localeCompare(b.className);
                return a.round - b.round;
            });

            for (var g = 0; g < sortedGroups.length; g++) {
                var group = sortedGroups[g];
                html += '<div class="result-column">' +
                    '<div class="column-header">' +
                    '<div class="column-date">' + group.date + '</div>' +
                    '<div class="column-judge">' + group.judge + '</div>' +
                    '<div class="column-class-round">' + group.className + ' - Round ' + group.round + '</div>' +
                    '</div>' +
                    '<div class="column-entries">';

                group.entries.sort(function(a, b) {
                    return a.handler.localeCompare(b.handler);
                });

                for (var e = 0; e < group.entries.length; e++) {
                    var entry = group.entries[e];
                    html += '<div class="entry-item">' +
                        entry.handler + ' - ' + entry.callName +
                        '<span class="entry-type-badge badge-' + entry.entryType + '">' + entry.entryType.toUpperCase() + '</span>' +
                        '</div>';
                }

                html += '</div></div>';
            }

            html += '</div>';
            container.innerHTML = html;
        }

        // Export functions
        function exportToCSV() {
            if (entryResults.length === 0) {
                alert('No data to export');
                return;
            }

            var csv = 'Registration,Call Name,Handler,Date,Class,Round,Judge,Entry Type,Timestamp\n';
            
            for (var i = 0; i < entryResults.length; i++) {
                var entry = entryResults[i];
                csv += entry.regNumber + ',' + entry.callName + ',' + entry.handler + ',' + entry.date + ',' + entry.className + ',' + entry.round + ',' + entry.judge + ',' + entry.entryType + ',' + entry.timestamp + '\n';
            }

            downloadFile(csv, 'trial_entries.csv', 'text/csv');
            showStatusMessage('CSV exported successfully!', 'success');
        }

        // Helper functions
        function downloadFile(content, filename, contentType) {
            var blob = new Blob([content], { type: contentType });
            var url = URL.createObjectURL(blob);
            var a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }

        function showStatusMessage(message, type) {
            var statusDiv = document.createElement('div');
            statusDiv.className = 'alert alert-' + type;
            statusDiv.textContent = message;
            statusDiv.style.position = 'fixed';
            statusDiv.style.top = '20px';
            statusDiv.style.right = '20px';
            statusDiv.style.zIndex = '10000';
            statusDiv.style.maxWidth = '300px';
            
            document.body.appendChild(statusDiv);
            
            setTimeout(function() {
                if (statusDiv.parentNode) {
                    document.body.removeChild(statusDiv);
                }
            }, 3000);
        }

        // Initialize the application
        window.onload = function() {
            console.log('Initializing Trial Management System...');
            
            if (handleURLParameters()) {
                loadDogData();
                return;
            }
            
            loadDogData();
            console.log('Application ready');
        };
    </script>
</body>
</html>
