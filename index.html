<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trial Management System</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            color: #333;
        }
        .header h1 {
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        /* Login/Register Modal Styles */
        .auth-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        .auth-modal {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            max-width: 400px;
            width: 90%;
            text-align: center;
        }
        .auth-tabs {
            display: flex;
            margin-bottom: 30px;
        }
        .auth-tab {
            flex: 1;
            padding: 12px;
            background: #f0f0f0;
            border: none;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        .auth-tab.active {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }
        .auth-tab:first-child {
            border-radius: 8px 0 0 8px;
        }
        .auth-tab:last-child {
            border-radius: 0 8px 8px 0;
        }
        .auth-form {
            display: none;
        }
        .auth-form.active {
            display: block;
        }
        .auth-input {
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 16px;
        }
        .auth-input:focus {
            border-color: #667eea;
            outline: none;
        }
        .auth-button {
            width: 100%;
            padding: 15px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 15px;
        }
        .auth-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }
        
        /* User Info Bar */
        .user-bar {
            text-align: right;
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .user-info {
            color: #2c5aa0;
            font-weight: bold;
        }
        .logout-btn {
            padding: 8px 15px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }
        .logout-btn:hover {
            background: #c82333;
        }
        
        /* My Trials Section */
        .my-trials {
            background: #e8f4f8;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .trial-item {
            background: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .trial-info {
            flex: 1;
        }
        .trial-name {
            font-weight: bold;
            color: #2c5aa0;
            margin-bottom: 5px;
        }
        .trial-meta {
            font-size: 14px;
            color: #666;
        }
        .trial-actions {
            display: flex;
            gap: 10px;
        }
        .edit-btn, .delete-btn {
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            font-size: 12px;
        }
        .edit-btn {
            background: #28a745;
            color: white;
        }
        .delete-btn {
            background: #dc3545;
            color: white;
        }
        .edit-btn:hover {
            background: #218838;
        }
        .delete-btn:hover {
            background: #c82333;
        }
        
        .nav-tabs {
            display: flex;
            border-bottom: 2px solid #e0e0e0;
            margin-bottom: 30px;
        }
        .nav-tab {
            padding: 15px 25px;
            background: #f0f0f0;
            border: 2px solid #d0d0d0;
            cursor: pointer;
            border-radius: 10px 10px 0 0;
            margin-right: 5px;
            font-weight: bold;
            transition: all 0.3s ease;
            color: #666;
        }
        .nav-tab:hover {
            background: #e8e8e8;
            border-color: #bbb;
            color: #333;
        }
        .nav-tab.active {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            transform: translateY(-2px);
            border-color: transparent;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .initial-question {
            background: #e8f4f8;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .day-container {
            border: 2px solid #2c5aa0;
            margin: 20px 0;
            padding: 20px;
            border-radius: 8px;
            background: #f8f9fa;
        }
        .day-header {
            background: #2c5aa0;
            color: white;
            padding: 10px 15px;
            margin: -20px -20px 20px -20px;
            border-radius: 6px 6px 0 0;
            font-weight: bold;
            font-size: 18px;
        }
        .classes-section {
            background: #fff3cd;
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
            border-left: 4px solid #ffc107;
        }
        .class-container {
            border: 1px solid #28a745;
            margin: 15px 0;
            padding: 15px;
            border-radius: 6px;
            background: #f8fff8;
        }
        .class-header {
            background: #28a745;
            color: white;
            padding: 8px 12px;
            margin: -15px -15px 15px -15px;
            border-radius: 4px 4px 0 0;
            font-weight: bold;
        }
        .rounds-section {
            background: #e7f3ff;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            border-left: 3px solid #007bff;
        }
        .form-group {
            display: flex;
            align-items: center;
            gap: 15px;
            margin: 10px 0;
            flex-wrap: wrap;
        }
        .label {
            font-weight: bold;
            margin-right: 10px;
        }
        
        /* Typeahead dropdown styles */
        .typeahead-container {
            position: relative;
            display: inline-block;
        }
        .typeahead-input {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
            width: 250px;
        }
        .typeahead-input:focus {
            border-color: #667eea;
            outline: none;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        .typeahead-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #e0e0e0;
            border-top: none;
            border-radius: 0 0 8px 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }
        .typeahead-item {
            padding: 10px 12px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
        }
        .typeahead-item:hover, .typeahead-item.highlighted {
            background: #f8f9fa;
        }
        .typeahead-item:last-child {
            border-bottom: none;
        }
        
        input, select {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        input:focus, select:focus {
            border-color: #667eea;
            outline: none;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        input[type="number"] { width: 100px; }
        input[type="text"] { width: 250px; }
        input[type="date"] { width: 180px; }
        select { width: 250px; }
        .yellow-highlight {
            background-color: #ffff99 !important;
        }
        button {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }
        
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #b8daff;
        }
        
        /* Results display styles */
        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .result-column {
            background: white;
            border-radius: 10px;
            border: 2px solid #e0e0e0;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .column-header {
            padding: 15px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            text-align: center;
        }
        .column-date {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .column-judge {
            font-size: 14px;
            margin-bottom: 5px;
        }
        .column-class-round {
            font-size: 14px;
        }
        .column-entries {
            padding: 15px;
        }
        .entry-item {
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
            font-size: 14px;
        }
        .entry-item:last-child {
            border-bottom: none;
        }
        .entry-type-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 5px;
        }
        .badge-regular {
            background: #28a745;
            color: white;
        }
        .badge-feo {
            background: #ffc107;
            color: #333;
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <!-- Authentication Modal -->
    <div id="authOverlay" class="auth-overlay">
        <div class="auth-modal">
            <h2>Welcome to Trial Management System</h2>
            
            <div class="auth-tabs">
                <button class="auth-tab active" onclick="showAuthTab('login')">Login</button>
                <button class="auth-tab" onclick="showAuthTab('register')">Register</button>
            </div>

            <!-- Login Form -->
            <form id="loginForm" class="auth-form active" onsubmit="handleLogin(event)">
                <input type="text" id="loginUsername" class="auth-input" placeholder="Username" required>
                <input type="password" id="loginPassword" class="auth-input" placeholder="Password" required>
                <button type="submit" class="auth-button">Login</button>
            </form>

            <!-- Register Form -->
            <form id="registerForm" class="auth-form" onsubmit="handleRegister(event)">
                <input type="text" id="regUsername" class="auth-input" placeholder="Choose Username" required>
                <input type="password" id="regPassword" class="auth-input" placeholder="Choose Password" required>
                <input type="password" id="regConfirmPassword" class="auth-input" placeholder="Confirm Password" required>
                <input type="text" id="regFullName" class="auth-input" placeholder="Full Name" required>
                <input type="email" id="regEmail" class="auth-input" placeholder="Email Address" required>
                <button type="submit" class="auth-button">Register</button>
            </form>
        </div>
    </div>

    <!-- Main Application -->
    <div id="mainApp" class="hidden">
        <!-- User Bar -->
        <div class="user-bar">
            <div class="user-info" id="userInfo"></div>
            <button class="logout-btn" onclick="logout()">Logout</button>
        </div>

        <div class="container">
            <div class="header">
                <h1>Trial Management System</h1>
                <p>Track judges across multiple days, classes, and rounds</p>
            </div>

            <!-- My Trials Section -->
            <div class="my-trials">
                <h3>My Trials</h3>
                <div id="myTrialsList"></div>
                <button onclick="createNewTrial()">Create New Trial</button>
            </div>

            <div class="nav-tabs">
                <button class="nav-tab active" onclick="showTab('setup', event)">Trial Setup</button>
                <button class="nav-tab" onclick="showTab('entry', event)">Entry Form</button>
                <button class="nav-tab" onclick="showTab('results', event)">Results</button>
            </div>

            <!-- Setup Tab -->
            <div id="setup" class="tab-content active">
                <div class="initial-question">
                    <h3 id="trialTitle">New Trial Setup</h3>
                    <div class="form-group">
                        <span class="label">Trial Name:</span>
                        <input type="text" id="trialName" placeholder="Enter trial name" style="width: 300px;">
                    </div>
                    <div class="form-group">
                        <span class="label">How many days in trial?</span>
                        <input type="number" id="trialDays" min="1" max="30" placeholder="Enter number">
                        <button onclick="generateDays()">Generate Days</button>
                    </div>
                </div>

                <div class="form-group">
                    <button onclick="saveTrialData()">Save Trial</button>
                </div>

                <div id="daysContainer"></div>
                <div id="entryFormLink" style="display: none; margin-top: 20px; padding: 20px; background: #e8f4f8; border-radius: 8px; text-align: center;">
                    <h3 style="color: #2c5aa0;">Trial Setup Complete!</h3>
                    <p>You can now use the Entry Form to register participants</p>
                </div>
            </div>

            <!-- Entry Form Tab -->
            <div id="entry" class="tab-content">
                <div class="initial-question">
                    <h3>Dog Entry Form</h3>
                    <form id="entryForm">
                        <div class="form-group">
                            <span class="label">Registration Number:</span>
                            <div class="typeahead-container">
                                <input type="text" id="regNumber" class="typeahead-input" 
                                       placeholder="Type registration number" 
                                       onkeyup="handleRegNumberTypeahead(this)" 
                                       onblur="hideRegNumberDropdown()" 
                                       onfocus="showRegNumberDropdown()">
                                <div id="regNumberDropdown" class="typeahead-dropdown"></div>
                            </div>
                            <span id="callName" style="margin-left: 15px; font-weight: bold; color: #666;">Call Name will appear here</span>
                        </div>

                        <div class="form-group">
                            <span class="label">Handler Name:</span>
                            <input type="text" id="handlerName" placeholder="Enter handler name">
                        </div>

                        <div id="trialOptions"></div>

                        <div class="form-group">
                            <button type="button" onclick="submitEntry()">Submit Entry</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Results Tab -->
            <div id="results" class="tab-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3>Trial Results</h3>
                    <button onclick="exportToCSV()">Export to CSV</button>
                </div>
                <div id="resultsContainer"></div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentUser = null;
        let currentTrialId = null;
        let dogData = [];
        let availableClasses = [];
        let availableJudges = [];
        let trialConfig = [];
        let entryResults = [];
        let totalDays = 0;
        let savedDays = 0;

        // Load JSON data automatically on page load
        async function loadDogData() {
            try {
                const response = await fetch('./data.json');
                if (!response.ok) {
                    throw new Error('Could not load data.json');
                }
                const data = await response.json();
                
                if (Array.isArray(data) && data.length > 0) {
                    dogData = data;
                    
                    // Extract unique classes and judges from the data
                    availableClasses = [...new Set(data.map(item => item.className || item.class).filter(Boolean))];
                    availableJudges = [...new Set(data.map(item => item.judge).filter(Boolean))];
                    
                    console.log('Dog data loaded successfully:', dogData.length, 'records');
                    return true;
                } else {
                    console.warn('JSON file appears to be empty or invalid format');
                    return false;
                }
            } catch (error) {
                console.error('Error loading JSON data:', error);
                // Fallback to default data
                dogData = [
                    { regNumber: "12345", callName: "Buddy" },
                    { regNumber: "67890", callName: "Luna" },
                    { regNumber: "11111", callName: "Max" },
                    { regNumber: "22222", callName: "Bella" }
                ];
                availableClasses = ["Novice A", "Novice B", "Open A", "Open B", "Utility A", "Utility B"];
                availableJudges = ["Judge Smith", "Judge Johnson", "Judge Williams", "Judge Brown", "Judge Davis"];
                return false;
            }
        }

        // Authentication functions
        function showAuthTab(tab) {
            // Update tab buttons
            document.querySelectorAll('.auth-tab').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // Update forms
            document.querySelectorAll('.auth-form').forEach(form => form.classList.remove('active'));
            document.getElementById(tab + 'Form').classList.add('active');
        }

        function handleLogin(event) {
            event.preventDefault();
            
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            
            // Get stored users
            const users = JSON.parse(localStorage.getItem('trialUsers') || '{}');
            
            if (users[username] && users[username].password === password) {
                currentUser = users[username];
                showMainApp();
                loadUserTrials();
            } else {
                alert('Invalid username or password');
            }
        }

        function handleRegister(event) {
            event.preventDefault();
            
            const username = document.getElementById('regUsername').value;
            const password = document.getElementById('regPassword').value;
            const confirmPassword = document.getElementById('regConfirmPassword').value;
            const fullName = document.getElementById('regFullName').value;
            const email = document.getElementById('regEmail').value;
            
            if (password !== confirmPassword) {
                alert('Passwords do not match');
                return;
            }
            
            // Get existing users
            const users = JSON.parse(localStorage.getItem('trialUsers') || '{}');
            
            if (users[username]) {
                alert('Username already exists');
                return;
            }
            
            // Create new user
            users[username] = {
                username: username,
                password: password, // In a real app, this would be hashed
                fullName: fullName,
                email: email,
                created: new Date().toISOString()
            };
            
            localStorage.setItem('trialUsers', JSON.stringify(users));
            
            alert('Registration successful! Please login.');
            showAuthTab('login');
        }

        function showMainApp() {
            document.getElementById('authOverlay').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            document.getElementById('userInfo').textContent = `Welcome, ${currentUser.fullName}`;
        }

        function logout() {
            currentUser = null;
            currentTrialId = null;
            document.getElementById('authOverlay').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');
            
            // Clear forms
            document.querySelectorAll('input').forEach(input => input.value = '');
        }

        // Trial management functions
        function loadUserTrials() {
            const userTrials = JSON.parse(localStorage.getItem(`trials_${currentUser.username}`) || '{}');
            
            userTrials[currentTrialId] = {
                name: trialName,
                config: trialConfig,
                results: entryResults,
                created: userTrials[currentTrialId]?.created || new Date().toISOString(),
                updated: new Date().toISOString()
            };
            
            localStorage.setItem(`trials_${currentUser.username}`, JSON.stringify(userTrials));
            showStatusMessage("Trial saved successfully!", "success");
            loadUserTrials();
        }

        // Tab functions
        function showTab(tabName, event) {
            // Update tab buttons
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            if (event && event.target) {
                event.target.classList.add('active');
            }
            
            // Update content
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
        }

        // Trial setup functions
        function generateDays() {
            const numDays = parseInt(document.getElementById('trialDays').value);
            if (!numDays || numDays < 1) {
                alert('Please enter a valid number of days');
                return;
            }

            totalDays = numDays;
            savedDays = 0;
            const container = document.getElementById('daysContainer');
            container.innerHTML = '';

            for (let i = 1; i <= numDays; i++) {
                createDaySection(i, container);
            }
        }

        function createDaySection(dayNum, container) {
            const dayDiv = document.createElement('div');
            dayDiv.className = 'day-container';
            dayDiv.innerHTML = `
                <div class="day-header">Day ${dayNum}</div>
                <div class="form-group">
                    <span class="label">Date for Day ${dayNum}:</span>
                    <input type="date" id="date_${dayNum}">
                </div>
                <div class="classes-section">
                    <div class="form-group">
                        <span class="label">How many classes this day?</span>
                        <input type="number" id="classes_${dayNum}" min="1" max="20" class="yellow-highlight" 
                               placeholder="Number" onchange="generateClasses(${dayNum})">
                    </div>
                    <div id="classesContainer_${dayNum}"></div>
                </div>
                <div class="form-group">
                    <button onclick="saveTrialDay(${dayNum})">Save Day ${dayNum}</button>
                </div>
            `;
            container.appendChild(dayDiv);
        }

        function generateClasses(dayNum) {
            const numClasses = parseInt(document.getElementById(`classes_${dayNum}`).value);
            if (!numClasses || numClasses < 1) return;

            const container = document.getElementById(`classesContainer_${dayNum}`);
            container.innerHTML = '';

            for (let i = 1; i <= numClasses; i++) {
                createClassSection(dayNum, i, container);
            }
        }

        function createClassSection(dayNum, classNum, container) {
            const classDiv = document.createElement('div');
            classDiv.className = 'class-container';
            classDiv.innerHTML = `
                <div class="class-header">Class ${classNum}</div>
                <div class="form-group">
                    <span class="label">Class Name:</span>
                    <select id="class_${dayNum}_${classNum}">
                        <option value="">Select Class</option>
                        ${availableClasses.map(cls => `<option value="${cls}">${cls}</option>`).join('')}
                    </select>
                    <span class="label">or</span>
                    <input type="text" placeholder="Custom class name" onchange="updateClassSelect(this, ${dayNum}, ${classNum})">
                </div>
                <div class="rounds-section">
                    <div class="form-group">
                        <span class="label">How many rounds?</span>
                        <input type="number" id="rounds_${dayNum}_${classNum}" min="1" max="10" 
                               placeholder="Number" onchange="generateRounds(${dayNum}, ${classNum})">
                    </div>
                    <div id="roundsContainer_${dayNum}_${classNum}"></div>
                </div>
            `;
            container.appendChild(classDiv);
        }

        function updateClassSelect(input, dayNum, classNum) {
            if (input.value.trim()) {
                const select = document.getElementById(`class_${dayNum}_${classNum}`);
                select.value = '';
                const option = document.createElement('option');
                option.value = input.value.trim();
                option.textContent = input.value.trim();
                option.selected = true;
                select.appendChild(option);
            }
        }

        function generateRounds(dayNum, classNum) {
            const numRounds = parseInt(document.getElementById(`rounds_${dayNum}_${classNum}`).value);
            if (!numRounds || numRounds < 1) return;

            const container = document.getElementById(`roundsContainer_${dayNum}_${classNum}`);
            container.innerHTML = '';

            for (let i = 1; i <= numRounds; i++) {
                const roundDiv = document.createElement('div');
                roundDiv.style.margin = '10px 0';
                roundDiv.innerHTML = `
                    <div class="form-group">
                        <span class="label">Round ${i} Judge:</span>
                        <select id="judge_${dayNum}_${classNum}_${i}">
                            <option value="">Select Judge</option>
                            ${availableJudges.map(judge => `<option value="${judge}">${judge}</option>`).join('')}
                        </select>
                        <span class="label">or</span>
                        <input type="text" placeholder="Custom judge name" onchange="updateJudgeSelect(this, ${dayNum}, ${classNum}, ${i})">
                    </div>
                `;
                container.appendChild(roundDiv);
            }
        }

        function updateJudgeSelect(input, dayNum, classNum, roundNum) {
            if (input.value.trim()) {
                const select = document.getElementById(`judge_${dayNum}_${classNum}_${roundNum}`);
                select.value = '';
                const option = document.createElement('option');
                option.value = input.value.trim();
                option.textContent = input.value.trim();
                option.selected = true;
                select.appendChild(option);
            }
        }

        function saveTrialDay(dayNum) {
            const date = document.getElementById(`date_${dayNum}`).value;
            if (!date) {
                alert(`Please set the date for Day ${dayNum}`);
                return;
            }

            const numClasses = parseInt(document.getElementById(`classes_${dayNum}`).value);
            if (!numClasses) {
                alert(`Please set the number of classes for Day ${dayNum}`);
                return;
            }

            // Remove existing configurations for this day
            trialConfig = trialConfig.filter(config => config.day !== dayNum);

            for (let classNum = 1; classNum <= numClasses; classNum++) {
                const className = document.getElementById(`class_${dayNum}_${classNum}`).value;
                if (!className) {
                    alert(`Please select a class name for Day ${dayNum}, Class ${classNum}`);
                    return;
                }

                const numRounds = parseInt(document.getElementById(`rounds_${dayNum}_${classNum}`).value);
                if (!numRounds) {
                    alert(`Please set the number of rounds for Day ${dayNum}, Class ${classNum}`);
                    return;
                }

                for (let roundNum = 1; roundNum <= numRounds; roundNum++) {
                    const judge = document.getElementById(`judge_${dayNum}_${classNum}_${roundNum}`).value;
                    if (!judge) {
                        alert(`Please select a judge for Day ${dayNum}, Class ${classNum}, Round ${roundNum}`);
                        return;
                    }

                    trialConfig.push({
                        day: dayNum,
                        date: date,
                        classNum: classNum,
                        className: className,
                        roundNum: roundNum,
                        judge: judge
                    });
                }
            }

            savedDays++;
            updateTrialOptions();
            showStatusMessage(`Day ${dayNum} configuration saved!`, 'success');

            // Check if all days are saved
            if (savedDays === totalDays) {
                document.getElementById('entryFormLink').style.display = 'block';
            }
        }

        function updateTrialOptions() {
            const container = document.getElementById('trialOptions');
            
            if (trialConfig.length === 0) {
                container.innerHTML = '<p style="color: #666; font-style: italic;">Please complete trial setup first.</p>';
                return;
            }
            
            // Group by day, then by class, then sort by round
            const groupedByDay = {};
            trialConfig.forEach(config => {
                if (!groupedByDay[config.day]) {
                    groupedByDay[config.day] = {};
                }
                if (!groupedByDay[config.day][config.className]) {
                    groupedByDay[config.day][config.className] = [];
                }
                groupedByDay[config.day][config.className].push(config);
            });

            // Sort rounds within each class
            Object.keys(groupedByDay).forEach(day => {
                Object.keys(groupedByDay[day]).forEach(className => {
                    groupedByDay[day][className].sort((a, b) => a.roundNum - b.roundNum);
                });
            });

            let html = '';
            
            // Sort days numerically
            const sortedDays = Object.keys(groupedByDay).sort((a, b) => parseInt(a) - parseInt(b));
            
            sortedDays.forEach(day => {
                html += `<div class="day-group">`;
                html += `<div class="day-group-header">Day ${day} - ${groupedByDay[day][Object.keys(groupedByDay[day])[0]][0].date}</div>`;
                
                // Sort classes alphabetically
                const sortedClasses = Object.keys(groupedByDay[day]).sort();
                
                sortedClasses.forEach(className => {
                    html += `<div class="class-group">`;
                    html += `<div class="class-group-header">${className}</div>`;
                    
                    groupedByDay[day][className].forEach((config, index) => {
                        const configIndex = trialConfig.findIndex(c => 
                            c.day === config.day && 
                            c.classNum === config.classNum && 
                            c.roundNum === config.roundNum
                        );
                        
                        html += `
                            <div class="trial-option">
                                <div style="font-weight: bold; margin-bottom: 8px;">
                                    Round ${config.roundNum} - ${config.judge}
                                </div>
                                <label>
                                    <input type="radio" name="trialSelection" value="${configIndex}" onchange="updateEntryTypes()">
                                    Select this trial
                                </label>
                            </div>
                        `;
                    });
                    
                    html += `</div>`;
                });
                
                html += `</div>`;
            });

            html += `
                <div id="entryTypeSection" style="display: none; margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                    <div class="form-group">
                        <span class="label">Entry Type:</span>
                        <div class="entry-type-options">
                            <label><input type="radio" name="entryType" value="regular" checked> Regular</label>
                            <label><input type="radio" name="entryType" value="feo"> FEO (For Exhibition Only)</label>
                        </div>
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
        }

        function updateEntryTypes() {
            const entryTypeSection = document.getElementById('entryTypeSection');
            entryTypeSection.style.display = 'block';
        }

        // Entry form functions
        function handleRegNumberTypeahead(input) {
            const query = input.value.toLowerCase();
            const dropdown = document.getElementById('regNumberDropdown');
            
            if (query.length === 0) {
                dropdown.style.display = 'none';
                document.getElementById('callName').textContent = 'Call Name will appear here';
                document.getElementById('callName').style.color = '#666';
                return;
            }

            const matches = dogData.filter(dog => 
                dog.regNumber.toLowerCase().includes(query) || 
                dog.callName.toLowerCase().includes(query)
            );

            if (matches.length > 0) {
                let html = '';
                matches.forEach(dog => {
                    html += `<div class="typeahead-item" onclick="selectRegNumber('${dog.regNumber}', '${dog.callName}')">${dog.regNumber} - ${dog.callName}</div>`;
                });
                dropdown.innerHTML = html;
                dropdown.style.display = 'block';

                // Auto-select if exact match
                const exactMatch = matches.find(dog => dog.regNumber.toLowerCase() === query);
                if (exactMatch) {
                    document.getElementById('callName').textContent = exactMatch.callName;
                    document.getElementById('callName').style.color = '#28a745';
                }
            } else {
                dropdown.style.display = 'none';
                document.getElementById('callName').textContent = 'Not found';
                document.getElementById('callName').style.color = '#dc3545';
            }
        }

        function selectRegNumber(regNumber, callName) {
            document.getElementById('regNumber').value = regNumber;
            document.getElementById('callName').textContent = callName;
            document.getElementById('callName').style.color = '#28a745';
            document.getElementById('regNumberDropdown').style.display = 'none';
        }

        function hideRegNumberDropdown() {
            setTimeout(() => {
                document.getElementById('regNumberDropdown').style.display = 'none';
            }, 200);
        }

        function showRegNumberDropdown() {
            const input = document.getElementById('regNumber');
            if (input.value.length > 0) {
                handleRegNumberTypeahead(input);
            }
        }

        function submitEntry() {
            const regNumber = document.getElementById('regNumber').value.trim();
            const handlerName = document.getElementById('handlerName').value.trim();
            const selectedTrial = document.querySelector('input[name="trialSelection"]:checked');
            const entryType = document.querySelector('input[name="entryType"]:checked');

            if (!regNumber) {
                alert('Please enter a registration number');
                return;
            }

            if (!handlerName) {
                alert('Please enter handler name');
                return;
            }

            if (!selectedTrial) {
                alert('Please select a trial');
                return;
            }

            if (!entryType) {
                alert('Please select entry type');
                return;
            }

            const config = trialConfig[parseInt(selectedTrial.value)];
            const dog = dogData.find(d => d.regNumber === regNumber);
            const callName = dog ? dog.callName : 'Unknown';

            const entry = {
                regNumber: regNumber,
                callName: callName,
                handler: handlerName,
                day: config.day,
                date: config.date,
                className: config.className,
                round: config.roundNum,
                judge: config.judge,
                entryType: entryType.value,
                timestamp: new Date().toISOString()
            };

            entryResults.push(entry);
            updateResultsDisplay();
            
            // Clear form
            document.getElementById('regNumber').value = '';
            document.getElementById('handlerName').value = '';
            document.getElementById('callName').textContent = 'Call Name will appear here';
            document.getElementById('callName').style.color = '#666';
            document.querySelectorAll('input[name="trialSelection"]').forEach(radio => radio.checked = false);
            document.querySelector('input[name="entryType"][value="regular"]').checked = true;
            document.getElementById('entryTypeSection').style.display = 'none';

            showStatusMessage('Entry submitted successfully!', 'success');
        }

        // Results functions
        function updateResultsDisplay() {
            const container = document.getElementById('resultsContainer');
            
            if (entryResults.length === 0) {
                container.innerHTML = '<p style="color: #666; font-style: italic;">No entries yet.</p>';
                return;
            }

            // Group results by date, class, and round
            const groupedResults = {};
            entryResults.forEach(entry => {
                const key = `${entry.date}-${entry.className}-${entry.round}`;
                if (!groupedResults[key]) {
                    groupedResults[key] = {
                        date: entry.date,
                        className: entry.className,
                        round: entry.round,
                        judge: entry.judge,
                        entries: []
                    };
                }
                groupedResults[key].entries.push(entry);
            });

            let html = '<div class="results-grid">';
            
            // Sort groups by date, then class, then round
            const sortedGroups = Object.values(groupedResults).sort((a, b) => {
                if (a.date !== b.date) return new Date(a.date) - new Date(b.date);
                if (a.className !== b.className) return a.className.localeCompare(b.className);
                return a.round - b.round;
            });

            sortedGroups.forEach(group => {
                html += `
                    <div class="result-column">
                        <div class="column-header">
                            <div class="column-date">${group.date}</div>
                            <div class="column-judge">${group.judge}</div>
                            <div class="column-class-round">${group.className} - Round ${group.round}</div>
                        </div>
                        <div class="column-entries">
                `;

                // Sort entries within group by handler name
                group.entries.sort((a, b) => a.handler.localeCompare(b.handler));

                group.entries.forEach(entry => {
                    html += `
                        <div class="entry-item">
                            ${entry.handler} - ${entry.callName}
                            <span class="entry-type-badge badge-${entry.entryType}">${entry.entryType.toUpperCase()}</span>
                        </div>
                    `;
                });

                html += `
                        </div>
                    </div>
                `;
            });

            html += '</div>';
            container.innerHTML = html;
        }

        // Export functions
        function exportToCSV() {
            if (entryResults.length === 0) {
                alert('No data to export');
                return;
            }

            let csv = 'Registration,Call Name,Handler,Date,Class,Round,Judge,Entry Type,Timestamp\n';
            
            entryResults.forEach(entry => {
                csv += `${entry.regNumber},${entry.callName},${entry.handler},${entry.date},${entry.className},${entry.round},${entry.judge},${entry.entryType},${entry.timestamp}\n`;
            });

            downloadFile(csv, 'trial_entries.csv', 'text/csv');
            showStatusMessage('CSV exported successfully!', 'success');
        }

        // Helper functions
        function downloadFile(content, filename, contentType) {
            const blob = new Blob([content], { type: contentType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }

        function showStatusMessage(message, type) {
            // Create a temporary status message
            const statusDiv = document.createElement('div');
            statusDiv.className = `alert alert-${type}`;
            statusDiv.textContent = message;
            statusDiv.style.position = 'fixed';
            statusDiv.style.top = '20px';
            statusDiv.style.right = '20px';
            statusDiv.style.zIndex = '10000';
            statusDiv.style.maxWidth = '300px';
            
            document.body.appendChild(statusDiv);
            
            setTimeout(() => {
                document.body.removeChild(statusDiv);
            }, 3000);
        }

        // Initialize the application
        window.onload = async function() {
            console.log('Initializing Trial Management System...');
            
            // Load dog data from JSON file
            await loadDogData();
            
            console.log('Application ready');
        };
    </script>
</body>
</html>`) || '{}');
            const container = document.getElementById('myTrialsList');
            
            if (Object.keys(userTrials).length === 0) {
                container.innerHTML = '<p style="color: #666; font-style: italic;">No trials yet. Create your first trial!</p>';
                return;
            }
            
            let html = '';
            for (const [trialId, trial] of Object.entries(userTrials)) {
                const created = new Date(trial.created).toLocaleDateString();
                const days = trial.config ? trial.config.filter((c, i, arr) => arr.findIndex(x => x.day === c.day) === i).length : 0;
                
                html += `
                    <div class="trial-item">
                        <div class="trial-info">
                            <div class="trial-name">${trial.name || 'Untitled Trial'}</div>
                            <div class="trial-meta">Created: ${created} | Days: ${days} | Entries: ${trial.results ? trial.results.length : 0}</div>
                        </div>
                        <div class="trial-actions">
                            <button class="edit-btn" onclick="editTrial('${trialId}')">Edit</button>
                            <button class="delete-btn" onclick="deleteTrial('${trialId}')">Delete</button>
                        </div>
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }

        function createNewTrial() {
            currentTrialId = 'trial_' + Date.now();
            document.getElementById('trialTitle').textContent = 'New Trial Setup';
            document.getElementById('trialName').value = '';
            document.getElementById('trialDays').value = '';
            document.getElementById('daysContainer').innerHTML = '';
            trialConfig = [];
            entryResults = [];
            updateTrialOptions();
            updateResultsDisplay();
            showTab('setup', { target: document.querySelector('.nav-tab') });
        }

        function editTrial(trialId) {
            const userTrials = JSON.parse(localStorage.getItem(`trials_${currentUser.username}`) || '{}');
            const trial = userTrials[trialId];
            
            if (!trial) {
                alert('Trial not found');
                return;
            }
            
            currentTrialId = trialId;
            document.getElementById('trialTitle').textContent = `Editing: ${trial.name || 'Untitled Trial'}`;
            document.getElementById('trialName').value = trial.name || '';
            
            // Load trial data
            trialConfig = trial.config || [];
            entryResults = trial.results || [];
            
            // Rebuild the setup interface
            if (trialConfig.length > 0) {
                const maxDay = Math.max(...trialConfig.map(c => c.day));
                document.getElementById('trialDays').value = maxDay;
                generateDays();
                
                // Populate existing data
                setTimeout(() => {
                    populateExistingTrialData();
                }, 100);
            }
            
            updateTrialOptions();
            updateResultsDisplay();
            showTab('setup', { target: document.querySelector('.nav-tab') });
        }

        function populateExistingTrialData() {
            trialConfig.forEach(config => {
                const dayNum = config.day;
                const dateInput = document.getElementById(`date_${dayNum}`);
                if (dateInput) {
                    dateInput.value = config.date;
                }
                
                const classInput = document.getElementById(`class_${dayNum}_${config.classNum}`);
                if (classInput) {
                    classInput.value = config.className;
                }
                
                const judgeInput = document.getElementById(`judge_${dayNum}_${config.classNum}_${config.roundNum}`);
                if (judgeInput) {
                    judgeInput.value = config.judge;
                }
            });
        }

        function deleteTrial(trialId) {
            if (confirm('Are you sure you want to delete this trial? This action cannot be undone.')) {
                const userTrials = JSON.parse(localStorage.getItem(`trials_${currentUser.username}`) || '{}');
                delete userTrials[trialId];
                localStorage.setItem(`trials_${currentUser.username}`, JSON.stringify(userTrials));
                loadUserTrials();
            }
        }

        function saveTrialData() {
            if (!currentUser) {
                alert("Please log in first.");
                return;
            }
            
            if (!currentTrialId) {
                alert("Please create a new trial first.");
                return;
            }
            
            const trialName = document.getElementById('trialName').value.trim();
            if (!trialName) {
                alert("Please enter a trial name.");
                return;
            }
            
            const userTrials = JSON.parse(localStorage.getItem(`trials_${currentUser.username}
