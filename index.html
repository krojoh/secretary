<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trial Management System</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }
        /* Enhanced Preview Modal Styles - ADD TO YOUR CSS SECTION */
        .preview-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10000;
            display: none;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(3px);
        }
        .preview-modal.show {
            display: flex;
        }
        .preview-content {
            background: white;
            width: 95%;
            height: 95%;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        }
        .preview-header {
            padding: 15px 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            border-radius: 10px 10px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .preview-header h4 {
            margin: 0;
            color: #333;
        }
        .preview-body {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #f8f9fa;
        }
        
        /* Digital Score Entry Styles */
        .digital-score-sheet {
            background: white;
            border: 2px solid #333;
            border-radius: 8px;
            margin: 20px 0;
            overflow: hidden;
        }
        .digital-sheet-header {
            background: #f8f9fa;
            padding: 15px 20px;
            border-bottom: 2px solid #333;
            text-align: center;
        }
        .digital-sheet-controls {
            background: #e8f4f8;
            padding: 10px 20px;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .digital-score-input {
            width: 60px;
            padding: 4px;
            border: 1px solid #ccc;
            border-radius: 3px;
            text-align: center;
            font-weight: bold;
            background: #fff;
        }
        .digital-score-input:focus {
            border-color: #667eea;
            outline: none;
            background: #f0f8ff;
        }
        .digital-fault-input {
            width: 70px;
            padding: 4px;
            border: 1px solid #ccc;
            border-radius: 3px;
            text-align: center;
            background: #fff;
        }
        .digital-time-input {
            width: 70px;
            padding: 4px;
            border: 1px solid #ccc;
            border-radius: 3px;
            text-align: center;
            background: #fff;
        }
        .digital-pass-fail-select {
            width: 70px;
            padding: 4px;
            border: 1px solid #ccc;
            border-radius: 3px;
            text-align: center;
            background: #fff;
        }
        .scent-checkbox {
            width: 18px;
            height: 18px;
            margin: 2px;
        }
        .score-entry-row {
            transition: all 0.2s ease;
        }
        .score-entry-row:hover {
            background: #f8f9fa;
        }
        .score-entry-row.completed {
            background: #d4edda;
        }
        .save-indicator {
            display: inline-block;
            margin-left: 10px;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: bold;
        }
        .save-indicator.saved {
            background: #28a745;
            color: white;
        }
        .save-indicator.unsaved {
            background: #ffc107;
            color: #333;
        }
        
        /* Sheet Selection Styles */
        .sheet-selector {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #dee2e6;
        }
        .sheet-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .sheet-option {
            padding: 15px;
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
        }
        .sheet-option:hover {
            border-color: #667eea;
            background: #f0f8ff;
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }
        .sheet-option.selected {
            border-color: #28a745;
            background: #f8fff9;
            box-shadow: 0 3px 10px rgba(40,167,69,0.2);
        }
        .sheet-option-title {
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
            font-size: 16px;
        }
        .sheet-option-meta {
            font-size: 12px;
            color: #666;
            margin-bottom: 8px;
        }
        .sheet-option-stats {
            font-size: 11px;
            color: #888;
            font-style: italic;
        }
        
        /* Auto-save Styles */
        .auto-save-status {
            position: fixed;
            top: 70px;
            right: 20px;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            z-index: 1000;
            transition: all 0.3s ease;
        }
        .auto-save-status.saving {
            background: #ffc107;
            color: #333;
        }
        .auto-save-status.saved {
            background: #28a745;
            color: white;
        }
        .auto-save-status.error {
            background: #dc3545;
            color: white;
        }
        
        /* Enhanced Button Styles */
        .score-control-btn {
            padding: 8px 15px;
            margin: 0 5px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            font-size: 12px;
            transition: all 0.2s ease;
        }
        .score-control-btn.save {
            background: #28a745;
            color: white;
        }
        .score-control-btn.save:hover {
            background: #218838;
        }
        .score-control-btn.clear {
            background: #dc3545;
            color: white;
        }
        .score-control-btn.clear:hover {
            background: #c82333;
        }
        .score-control-btn.print {
            background: #17a2b8;
            color: white;
        }
        .score-control-btn.print:hover {
            background: #138496;
        }
        .score-control-btn.export {
            background: #6f42c1;
            color: white;
        }
        .score-control-btn.export:hover {
            background: #5a359a;
        }
        
        /* Progress Indicators */
        .completion-progress {
            width: 100%;
            height: 6px;
            background: #e9ecef;
            border-radius: 3px;
            overflow: hidden;
            margin: 10px 0;
        }
        .completion-bar {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #20c997);
            width: 0%;
            transition: width 0.3s ease;
        }
        .completion-text {
            font-size: 12px;
            color: #666;
            text-align: center;
            margin-top: 5px;
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .preview-content {
                width: 98%;
                height: 98%;
            }
            .sheet-grid {
                grid-template-columns: 1fr;
            }
            .digital-score-input,
            .digital-fault-input,
            .digital-time-input {
                width: 50px;
            }
            .scent-score-table {
                font-size: 9px;
            }
            .scent-score-table th,
            .scent-score-table td {
                padding: 2px;
            }
        }
        
        /* Print Styles for Digital Sheets */
        @media print {
            .digital-sheet-controls,
            .score-control-btn,
            .auto-save-status {
                display: none !important;
            }
            .digital-score-sheet {
                page-break-after: always;
                margin: 0;
                border: 2px solid #000;
            }
            .digital-score-input,
            .digital-fault-input,
            .digital-time-input,
            .digital-pass-fail-select {
                border: none;
                background: transparent;
                font-weight: bold;
            }
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            color: #333;
        }
        .header h1 {
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        /* Login/Register Modal Styles */
        .auth-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        .auth-modal {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            max-width: 400px;
            width: 90%;
            text-align: center;
        }
        .auth-tabs {
            display: flex;
            margin-bottom: 30px;
        }
        .auth-tab {
            flex: 1;
            padding: 12px;
            background: #f0f0f0;
            border: none;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        .auth-tab.active {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }
        .auth-tab:first-child {
            border-radius: 8px 0 0 8px;
        }
        .auth-tab:last-child {
            border-radius: 0 8px 8px 0;
        }
        .auth-form {
            display: none;
        }
        .auth-form.active {
            display: block;
        }
        .auth-input {
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 16px;
        }
        .auth-input:focus {
            border-color: #667eea;
            outline: none;
        }
        .auth-button {
            width: 100%;
            padding: 15px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 15px;
        }
        .auth-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }
        
        /* User Info Bar */
        .user-bar {
            text-align: right;
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .user-info {
            color: #2c5aa0;
            font-weight: bold;
        }
        .logout-btn {
            padding: 8px 15px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }
        .logout-btn:hover {
            background: #c82333;
        }
        
        /* My Trials Section */
        .my-trials {
            background: #e8f4f8;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .trial-item {
            background: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .trial-info {
            flex: 1;
        }
        .trial-name {
            font-weight: bold;
            color: #2c5aa0;
            margin-bottom: 5px;
        }
        .trial-meta {
            font-size: 14px;
            color: #666;
        }
        .trial-actions {
            display: flex;
            gap: 10px;
        }
        .edit-btn, .delete-btn {
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            font-size: 12px;
        }
        .edit-btn {
            background: #28a745;
            color: white;
        }
        .delete-btn {
            background: #dc3545;
            color: white;
        }
        .edit-btn:hover {
            background: #218838;
        }
        .delete-btn:hover {
            background: #c82333;
        }
        
        .nav-tabs {
            display: flex;
            border-bottom: 2px solid #e0e0e0;
            margin-bottom: 30px;
        }
        .nav-tab {
            padding: 15px 25px;
            background: #f0f0f0;
            border: 2px solid #d0d0d0;
            cursor: pointer;
            border-radius: 10px 10px 0 0;
            margin-right: 5px;
            font-weight: bold;
            transition: all 0.3s ease;
            color: #666;
        }
        .nav-tab:hover {
            background: #e8e8e8;
            border-color: #bbb;
            color: #333;
        }
        .nav-tab.active {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            transform: translateY(-2px);
            border-color: transparent;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .initial-question {
            background: #e8f4f8;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .day-container {
            border: 2px solid #2c5aa0;
            margin: 20px 0;
            padding: 20px;
            border-radius: 8px;
            background: #f8f9fa;
        }
        .day-header {
            background: #2c5aa0;
            color: white;
            padding: 10px 15px;
            margin: -20px -20px 20px -20px;
            border-radius: 6px 6px 0 0;
            font-weight: bold;
            font-size: 18px;
        }
        .classes-section {
            background: #fff3cd;
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
            border-left: 4px solid #ffc107;
        }
        .class-container {
            border: 1px solid #28a745;
            margin: 15px 0;
            padding: 15px;
            border-radius: 6px;
            background: #f8fff8;
        }
        .class-header {
            background: #28a745;
            color: white;
            padding: 8px 12px;
            margin: -15px -15px 15px -15px;
            border-radius: 4px 4px 0 0;
            font-weight: bold;
        }
        .rounds-section {
            background: #e7f3ff;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            border-left: 3px solid #007bff;
        }
        .form-group {
            display: flex;
            align-items: center;
            gap: 15px;
            margin: 10px 0;
            flex-wrap: wrap;
        }
        .label {
            font-weight: bold;
            margin-right: 10px;
        }
        
        /* Typeahead dropdown styles */
        .typeahead-container {
            position: relative;
            display: inline-block;
        }
        .typeahead-input {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
            width: 250px;
        }
        .typeahead-input:focus {
            border-color: #667eea;
            outline: none;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        .typeahead-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #e0e0e0;
            border-top: none;
            border-radius: 0 0 8px 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }
        .typeahead-item {
            padding: 10px 12px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
        }
        .typeahead-item:hover, .typeahead-item.highlighted {
            background: #f8f9fa;
        }
        .typeahead-item:last-child {
            border-bottom: none;
        }
        
        input, select {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        input:focus, select:focus {
            border-color: #667eea;
            outline: none;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        input[type="number"] { width: 100px; }
        input[type="text"] { width: 250px; }
        input[type="date"] { width: 180px; }
        select { width: 250px; }
        .yellow-highlight {
            background-color: #ffff99 !important;
        }
        button {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }
        
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #b8daff;
        }
        
        /* Results display styles */
        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .result-column {
            background: white;
            border-radius: 10px;
            border: 2px solid #e0e0e0;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .column-header {
            padding: 15px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            text-align: center;
        }
        .column-date {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .column-judge {
            font-size: 14px;
            margin-bottom: 5px;
        }
        .column-class-round {
            font-size: 14px;
        }
        .column-entries {
            padding: 15px;
        }
        .entry-item {
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
            font-size: 14px;
        }
        .entry-item:last-child {
            border-bottom: none;
        }
        .entry-type-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 5px;
        }
        .badge-regular {
            background: #28a745;
            color: white;
        }
        .badge-feo {
            background: #ffc107;
            color: #333;
        }

        .hidden {
            display: none;
        }

        /* Add these new CSS styles to your existing stylesheet (in Part 1 or 2) */
        
        /* Scent Detective Score Sheet Styles */
        .scent-score-sheet {
            background: white;
            margin: 20px 0;
            page-break-after: always;
            border: 2px solid #000;
            padding: 15px;
            font-family: 'Times New Roman', serif;
        }
        .scent-sheet-header {
            text-align: center;
            margin-bottom: 20px;
        }
        .scent-sheet-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .scent-sheet-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            font-weight: bold;
        }
        .scent-round-boxes {
            text-align: center;
            margin: 15px 0;
        }
        .scent-round-box {
            display: inline-block;
            width: 30px;
            height: 30px;
            border: 2px solid #000;
            margin: 0 10px;
            line-height: 26px;
            font-weight: bold;
            font-size: 16px;
        }
        .scent-round-box.selected {
            background: #000;
            color: white;
        }
        .scent-locations {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin: 15px 0;
            border: 2px solid #000;
            padding: 10px;
        }
        .scent-location {
            text-align: center;
            border: 1px solid #000;
            padding: 8px;
            min-height: 40px;
        }
        .scent-faults-section {
            border: 1px solid #000;
            padding: 10px;
            margin: 15px 0;
            font-size: 11px;
        }
        .scent-score-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 10px;
        }
        .scent-score-table th,
        .scent-score-table td {
            border: 1px solid #000;
            padding: 4px;
            text-align: center;
        }
        .scent-score-table th {
            background: #f0f0f0;
            font-weight: bold;
        }
        .scent-team-col { width: 60px; }
        .scent-dog-handler-col { width: 120px; text-align: left; }
        .scent-scent-col { width: 50px; }
        .scent-fault-col { width: 80px; }
        .scent-time-col { width: 60px; }
        .scent-pass-fail-col { width: 60px; }
        
        .sheet-type-selector {
            background: #e8f4f8;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .sheet-type-option {
            display: inline-block;
            margin: 5px 10px;
            padding: 10px 15px;
            background: #f0f0f0;
            border: 2px solid #ddd;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .sheet-type-option:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }
        .sheet-type-option.selected {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        .day-group {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #e0e0e0;
            margin-bottom: 20px;
        }
        .day-group-header {
            font-weight: bold;
            font-size: 16px;
            color: #2c5aa0;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid #2c5aa0;
        }
        .class-group {
            margin-bottom: 15px;
            padding: 10px;
            background: white;
            border-radius: 8px;
            border-left: 4px solid #28a745;
        }
        .class-group-header {
            font-weight: bold;
            color: #28a745;
            margin-bottom: 10px;
        }
        .trial-option {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #e0e0e0;
            margin-bottom: 8px;
            transition: all 0.3s ease;
        }
        .trial-option:hover {
            border-color: #667eea;
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }
        .trial-option label {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
        }
        .entry-type-options {
            display: flex;
            gap: 15px;
            margin-left: 20px;
        }
        .entry-type-options label {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 14px;
        }
/* Cross-Reference Grid Styles */
        .cross-reference-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border: 2px solid #17a2b8;
        }
        .cross-reference-header {
            background: #17a2b8;
            color: white;
            padding: 12px 15px;
            margin: -20px -20px 20px -20px;
            border-radius: 8px 8px 0 0;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .grid-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 20px;
        }
        .cross-reference-grid {
            background: white;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            overflow: auto;
            max-height: 600px;
        }
        .grid-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }
        .grid-table th {
            background: #e9ecef;
            padding: 8px 6px;
            border: 1px solid #dee2e6;
            font-size: 11px;
            font-weight: bold;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .grid-table td {
            padding: 6px;
            border: 1px solid #dee2e6;
            text-align: center;
            font-size: 12px;
            vertical-align: middle;
        }
        .grid-table .dog-info {
            text-align: left;
            font-weight: bold;
            color: #333;
            white-space: nowrap;
            position: sticky;
            left: 0;
            background: #f8f9fa;
            z-index: 5;
            min-width: 120px;
        }
        .grid-table .handler-info {
            text-align: left;
            color: #666;
            font-size: 11px;
            white-space: nowrap;
            position: sticky;
            left: 120px;
            background: #f8f9fa;
            z-index: 5;
            min-width: 100px;
        }
        .entry-cell {
            width: 60px;
            height: 30px;
        }
        .entry-marker {
            display: inline-block;
            width: 20px;
            height: 20px;
            border-radius: 3px;
            margin: 1px;
            font-size: 10px;
            line-height: 20px;
            text-align: center;
            font-weight: bold;
            color: white;
        }
        .marker-regular {
            background: #28a745;
        }
        .marker-feo {
            background: #ffc107;
            color: #333;
        }
        .marker-both {
            background: linear-gradient(45deg, #28a745 50%, #ffc107 50%);
            color: white;
        }
        .date-header-group {
            background: #343a40;
            color: white;
            font-weight: bold;
        }
        .class-header-group {
            background: #6c757d;
            color: white;
        }
        .judge-header {
            background: #dee2e6;
            color: #333;
            font-size: 10px;
        }
        .grid-legend {
            display: flex;
            gap: 15px;
            margin-top: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 6px;
            font-size: 12px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .filter-section {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 1px solid #dee2e6;
        }
        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 10px;
        }
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .filter-group label {
            font-weight: bold;
            font-size: 12px;
            color: #666;
        }
        .filter-input {
            padding: 6px 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 12px;
        }

        /* Running Order Management Styles */
        .running-order-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border: 2px solid #17a2b8;
        }
        .running-order-header {
            background: #17a2b8;
            color: white;
            padding: 12px 15px;
            margin: -20px -20px 20px -20px;
            border-radius: 8px 8px 0 0;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .class-round-group {
            background: white;
            border-radius: 8px;
            margin: 15px 0;
            border: 1px solid #dee2e6;
            overflow: hidden;
        }
        .class-round-header {
            background: #e9ecef;
            padding: 12px 15px;
            font-weight: bold;
            color: #495057;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .running-order-list {
            min-height: 60px;
            padding: 10px;
            background: #fdfdfe;
        }
        .draggable-entry {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 12px 15px;
            margin: 8px 0;
            cursor: move;
            transition: all 0.2s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            user-select: none;
        }
        .draggable-entry:hover {
            border-color: #17a2b8;
            box-shadow: 0 2px 8px rgba(23, 162, 184, 0.2);
            transform: translateY(-1px);
        }
        .draggable-entry.dragging {
            opacity: 0.5;
            transform: rotate(3deg);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 1000;
        }
        .draggable-entry.drag-over {
            border-color: #28a745;
            border-width: 2px;
            background: #f8fff9;
        }
        .entry-info {
            flex: 1;
        }
        .entry-details {
            font-weight: bold;
            color: #333;
            margin-bottom: 4px;
        }
        .entry-meta {
            font-size: 12px;
            color: #666;
        }
        .entry-position {
            background: #17a2b8;
            color: white;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
        }
        .drag-handle {
            color: #6c757d;
            cursor: move;
            margin-left: 10px;
            font-size: 18px;
        }
        .conflict-warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 4px;
            padding: 8px 12px;
            margin: 10px 0;
            color: #856404;
            font-size: 14px;
        }
        .conflict-item {
            background: #f8d7da;
            border-left: 4px solid #dc3545;
        }
        .shuffle-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .shuffle-btn {
            background: #ffc107;
            color: #333;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
        }
        .shuffle-btn:hover {
            background: #e0a800;
        }
        .auto-fix-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
        }
        .auto-fix-btn:hover {
            background: #218838;
        }

        /* Score Sheets Styles */
        .score-sheet-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        .date-selection {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #dee2e6;
        }
        .date-checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .date-checkbox {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 6px;
            border: 1px solid #e9ecef;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .date-checkbox:hover {
            background: #e9ecef;
            border-color: #667eea;
        }
        .date-checkbox input[type="checkbox"] {
            width: 18px;
            height: 18px;
        }
        .date-info {
            flex: 1;
        }
        .date-name {
            font-weight: bold;
            color: #333;
        }
        .date-meta {
            font-size: 12px;
            color: #666;
        }
        .print-controls {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-top: 20px;
            padding: 15px;
            background: #e8f4f8;
            border-radius: 8px;
        }
        .print-btn {
            background: #28a745;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
        }
        .print-btn:hover {
            background: #218838;
        }
        .preview-btn {
            background: #17a2b8;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
        }
        .preview-btn:hover {
            background: #138496;
        }
        
        /* Print Preview Styles */
        .preview-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10000;
            display: none;
            justify-content: center;
            align-items: center;
        }
        .preview-content {
            background: white;
            width: 90%;
            height: 90%;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
        }
        .preview-header {
    padding: 15px 20px;
    background: #f8f9fa; /* <-- semicolon added here */
    border-bottom: 1px solid #dee2e6;
    border-radius: 10px 10px 0 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

        
        .preview-body {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }
        
        .score-sheet {
            background: white;
            margin-bottom: 30px;
            page-break-after: always;
            border: 2px solid #333;
        }
        .score-sheet-header {
            background: #f8f9fa;
            padding: 15px 20px;
            border-bottom: 2px solid #333;
            text-align: center;
        }
        .trial-info {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin-bottom: 15px;
        }
        .info-block {
            text-align: center;
        }
        .info-label {
            font-weight: bold;
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
        }
        .info-value {
            font-size: 16px;
            font-weight: bold;
            color: #333;
            margin-top: 5px;
        }
        .running-order-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .running-order-table th,
        .running-order-table td {
            border: 1px solid #333;
            padding: 8px 12px;
            text-align: left;
        }
        .running-order-table th {
            background: #f8f9fa;
            font-weight: bold;
            font-size: 14px;
        }
        .running-order-table td {
            height: 35px;
            vertical-align: top;
        }
        .position-col {
            width: 60px;
            text-align: center;
            font-weight: bold;
        }
        .reg-col {
            width: 120px;
        }
        .name-col {
            width: 150px;
        }
        .handler-col {
            width: 150px;
        }
        .score-col {
            width: 80px;
            text-align: center;
        }
        .placement-col {
            width: 80px;
            text-align: center;
        }
        
        /* Print Media Queries */
        @media print {
            body * {
                visibility: hidden;
            }
            .score-sheets-container,
            .score-sheets-container * {
                visibility: visible;
            }
            .score-sheets-container {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
            .score-sheet {
                page-break-after: always;
                margin-bottom: 0;
            }
            .score-sheet:last-child {
                page-break-after: avoid;
            }
        }

        /* Digital Score Entry Styles */
        .digital-score-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        .class-round-selector {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #dee2e6;
        }
        .selector-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .selector-item {
            padding: 12px;
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
        }
        .selector-item:hover {
            border-color: #667eea;
            background: #f0f8ff;
        }
        .selector-item.selected {
            border-color: #28a745;
            background: #f8fff9;
        }
        .selector-title {
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }
        .selector-meta {
            font-size: 12px;
            color: #666;
        }
    </style>
</head>
<body>
    <!-- Authentication Modal -->
    <div id="authOverlay" class="auth-overlay">
        <div class="auth-modal">
            <h2>Welcome to Trial Management System</h2>
            
            <div class="auth-tabs">
                <button class="auth-tab active" onclick="showAuthTab('login', this)">Login</button>
                <button class="auth-tab" onclick="showAuthTab('register', this)">Register</button>
            </div>

            <!-- Login Form -->
            <form id="loginForm" class="auth-form active" onsubmit="handleLogin(event)">
                <input type="text" id="loginUsername" class="auth-input" placeholder="Username" required>
                <input type="password" id="loginPassword" class="auth-input" placeholder="Password" required>
                <button type="submit" class="auth-button">Login</button>
            </form>

            <!-- Register Form -->
            <form id="registerForm" class="auth-form" onsubmit="handleRegister(event)">
                <input type="text" id="regUsername" class="auth-input" placeholder="Choose Username" required>
                <input type="password" id="regPassword" class="auth-input" placeholder="Choose Password" required>
                <input type="password" id="regConfirmPassword" class="auth-input" placeholder="Confirm Password" required>
                <input type="text" id="regFullName" class="auth-input" placeholder="Full Name" required>
                <input type="email" id="regEmail" class="auth-input" placeholder="Email Address" required>
                <button type="submit" class="auth-button">Register</button>
            </form>
        </div>
    </div>

    <!-- Main Application -->
    <div id="mainApp" class="hidden">
        <!-- User Bar -->
        <div class="user-bar">
            <div class="user-info" id="userInfo"></div>
            <button class="logout-btn" onclick="logout()">Logout</button>
        </div>

        <div class="container">
            <div class="header">
                <h1>Trial Management System</h1>
                <p>Track judges across multiple days, classes, and rounds</p>
            </div>

            <!-- My Trials Section -->
            <div class="my-trials">
                <h3>My Trials</h3>
                <div id="myTrialsList"></div>
                <button onclick="createNewTrial()">Create New Trial</button>
            </div>

            <div class="nav-tabs">
                <button class="nav-tab active" onclick="showTab('setup', this)">Trial Setup</button>
                <button class="nav-tab" onclick="showTab('entry', this)">Entry Form</button>
                <button class="nav-tab" onclick="showTab('results', this)">Results</button>
                <button class="nav-tab" onclick="showTab('cross-reference', this)">Cross-Reference</button>
                <button class="nav-tab" onclick="showTab('running-order', this)">Running Order</button>
                <button class="nav-tab" onclick="showTab('score-sheets', this)">Score Sheets</button>
                <button class="nav-tab" onclick="showTab('score-entry', this)">Score Entry</button>
            </div>

            <!-- Setup Tab -->
            <div id="setup" class="tab-content active">
                <div class="initial-question">
                    <h3 id="trialTitle">New Trial Setup</h3>
                    <div class="form-group">
                        <span class="label">Trial Name:</span>
                        <input type="text" id="trialName" placeholder="Enter trial name" style="width: 300px;">
                    </div>
                    <div class="form-group">
                        <span class="label">How many days in trial?</span>
                        <input type="number" id="trialDays" min="1" max="30" placeholder="Enter number">
                        <button type="button" onclick="generateDays()">Generate Days</button>
                    </div>
                </div>

                <div id="daysContainer"></div>
                
                <!-- Save Trial Section -->
                <div id="saveTrialSection" style="display: none; margin-top: 30px; padding: 25px; background: linear-gradient(135deg, #e8f4f8, #f0f8ff); border-radius: 12px; text-align: center; border: 2px solid #2c5aa0;">
                    <h3 style="color: #2c5aa0; margin-bottom: 15px;">ðŸŽ¯ Ready to Save Your Trial?</h3>
                    <p style="margin-bottom: 20px; color: #666;">All days have been configured. Review your trial setup and save to generate the entry form link.</p>
                    
                    <div class="form-group" style="justify-content: center; margin-bottom: 20px;">
                        <button type="button" onclick="saveTrialData()" style="font-size: 16px; padding: 15px 30px; background: linear-gradient(45deg, #28a745, #20c997);">ðŸ’¾ Save Trial & Generate Entry Link</button>
                    </div>
                    
                    <p style="font-size: 14px; color: #666; margin: 0;">Once saved, you'll receive a shareable link for participant registration.</p>
                </div>

                <!-- Entry Form Link Section -->
                <div id="entryFormLink" style="display: none; margin-top: 20px; padding: 20px; background: #e8f4f8; border-radius: 8px; text-align: center;">
                    <h3 style="color: #2c5aa0;">ðŸŽ‰ Trial Setup Complete!</h3>
                    <p><strong>Share this URL for participants to register:</strong></p>
                    <div style="margin: 15px 0;">
                        <input type="text" id="shareableURL" readonly style="width: 100%; padding: 10px; font-family: monospace; background: #fff; border: 2px solid #2c5aa0; border-radius: 5px;">
                    </div>
                    <div style="margin: 10px 0;">
                        <button onclick="copyURL()" style="margin-right: 10px;">ðŸ“‹ Copy URL</button>
                        <button onclick="openEntryForm()">ðŸ”— Test Entry Form</button>
                    </div>
                    <p style="font-size: 14px; color: #666;">Participants can use this link to register for your trial. You can also copy this link from your trial dashboard.</p>
                </div>
            </div>

            <!-- Entry Form Tab -->
            <div id="entry" class="tab-content">
                <div class="initial-question">
                    <h3>Dog Entry Form</h3>
                    <form id="entryForm">
                        <div class="form-group">
                            <span class="label">Registration Number:</span>
                            <div class="typeahead-container">
                                <input type="text" id="regNumber" class="typeahead-input" 
                                       placeholder="Type registration number" 
                                       onkeyup="handleRegNumberTypeahead(this)" 
                                       onblur="hideRegNumberDropdown()" 
                                       onfocus="showRegNumberDropdown()">
                                <div id="regNumberDropdown" class="typeahead-dropdown"></div>
                            </div>
                            <span id="callName" style="margin-left: 15px; font-weight: bold; color: #666;">Call Name will appear here</span>
                        </div>

                        <div class="form-group">
                            <span class="label">Handler Name:</span>
                            <input type="text" id="handlerName" placeholder="Enter handler name">
                        </div>

                        <div class="form-group">
                            <span class="label">Select Trial(s):</span>
                            <div style="font-size: 12px; color: #666; margin-bottom: 10px;">You can select multiple trials for the same dog</div>
                        </div>

                        <div id="trialOptions"></div>

                        <div class="form-group">
                            <button type="button" onclick="submitEntry()">Submit Entry</button>
                            <button type="button" onclick="clearSelections()" style="background: #6c757d; margin-left: 10px;">Clear Selections</button>
                        </div>
                    </form>
                </div>
            </div>
            <!-- Results Tab -->
            <div id="results" class="tab-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3>Trial Results</h3>
                    <button type="button" onclick="exportToCSV()">Export to CSV</button>
                </div>
                <div id="resultsContainer"></div>
            </div>

            <!-- Cross-Reference Tab -->
            <div id="cross-reference" class="tab-content">
                <div class="cross-reference-section">
                    <div class="cross-reference-header">
                        <h3>ðŸ” Cross-Reference Grid</h3>
                        <div>
                            <button type="button" onclick="refreshCrossReference()" style="background: #28a745; margin-right: 10px;">ðŸ”„ Refresh</button>
                            <button type="button" onclick="exportCrossReference()" style="background: #17a2b8;">ðŸ“Š Export Grid</button>
                        </div>
                    </div>
                    
                    <!-- Filter Section -->
                    <div class="filter-section">
                        <h4>Filter Options</h4>
                        <div class="filter-grid">
                            <div class="filter-group">
                                <label>Search Registration:</label>
                                <input type="text" id="filterReg" class="filter-input" placeholder="Registration number" onkeyup="applyFilters()">
                            </div>
                            <div class="filter-group">
                                <label>Search Handler:</label>
                                <input type="text" id="filterHandler" class="filter-input" placeholder="Handler name" onkeyup="applyFilters()">
                            </div>
                            <div class="filter-group">
                                <label>Filter by Date:</label>
                                <select id="filterDate" class="filter-input" onchange="applyFilters()">
                                    <option value="">All Dates</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label>Filter by Class:</label>
                                <select id="filterClass" class="filter-input" onchange="applyFilters()">
                                    <option value="">All Classes</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label>Entry Type:</label>
                                <select id="filterEntryType" class="filter-input" onchange="applyFilters()">
                                    <option value="">All Types</option>
                                    <option value="regular">Regular Only</option>
                                    <option value="feo">FEO Only</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label>Show Scored Only:</label>
                                <select id="filterScored" class="filter-input" onchange="applyFilters()">
                                    <option value="">All Entries</option>
                                    <option value="scored">Scored Only</option>
                                    <option value="unscored">Unscored Only</option>
                                </select>
                            </div>
                        </div>
                        <div style="margin-top: 10px;">
                            <button onclick="clearFilters()" style="background: #6c757d; padding: 6px 12px; font-size: 12px;">Clear All Filters</button>
                        </div>
                    </div>

                    <!-- Grid Controls -->
                    <div class="grid-controls">
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <label style="font-size: 12px;">
                                <input type="checkbox" id="autoPopulateScores" checked onchange="updateCrossReferenceDisplay()"> Auto-populate from digital scores
                            </label>
                            <label style="font-size: 12px;">
                                <input type="checkbox" id="showRunningOrder" onchange="updateCrossReferenceDisplay()"> Show running order numbers
                            </label>
                            <label style="font-size: 12px;">
                                <input type="checkbox" id="highlightConflicts" checked onchange="updateCrossReferenceDisplay()"> Highlight time conflicts
                            </label>
                        </div>
                        <div style="margin-left: auto; font-size: 12px; color: #666;">
                            <span id="gridEntryCount">0 entries displayed</span>
                        </div>
                    </div>

                    <!-- Cross-Reference Grid -->
                    <div class="cross-reference-grid" id="crossReferenceGrid">
                        <p style="text-align: center; color: #666; padding: 40px;">No trial data available. Please complete trial setup first.</p>
                    </div>

                    <!-- Legend -->
                    <div class="grid-legend">
                        <div class="legend-item">
                            <span class="entry-marker marker-regular">R</span>
                            <span>Regular Entry</span>
                        </div>
                        <div class="legend-item">
                            <span class="entry-marker marker-feo">F</span>
                            <span>FEO Entry</span>
                        </div>
                        <div class="legend-item">
                            <span class="entry-marker marker-both">B</span>
                            <span>Both Regular & FEO</span>
                        </div>
                        <div class="legend-item">
                            <span style="background: #dc3545; color: white; padding: 2px 6px; border-radius: 3px; font-size: 10px;">âš </span>
                            <span>Time Conflict</span>
                        </div>
                        <div class="legend-item">
                            <span style="background: #28a745; color: white; padding: 2px 6px; border-radius: 3px; font-size: 10px;">âœ“</span>
                            <span>Scored</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- REPLACE THE EXISTING SCORE ENTRY TAB WITH THIS -->
            <div id="score-entry" class="tab-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3>Digital Score Entry</h3>
                    <div>
                        <button type="button" class="score-control-btn export" onclick="exportAllScores()">ðŸ“Š Export All Scores</button>
                        <button type="button" class="score-control-btn print" onclick="printCurrentSheet()">ðŸ–¨ï¸ Print Current</button>
                        <button type="button" class="score-control-btn clear" onclick="clearAllScores()">ðŸ—‘ï¸ Clear All Scores</button>
                    </div>
                </div>
                
                <!-- Auto-save Status Indicator -->
                <div id="autoSaveStatus" class="auto-save-status" style="display: none;"></div>
                
                <div class="digital-score-section">
                    <!-- Sheet Selection -->
                    <div class="sheet-selector">
                        <h4>Select Class & Round to Score</h4>
                        <p>Choose a class and round to enter digital scores:</p>
                        
                        <!-- Progress Indicator -->
                        <div class="completion-progress">
                            <div class="completion-bar" id="completionBar"></div>
                        </div>
                        <div class="completion-text" id="completionText">0% Complete</div>
                        
                        <div id="digitalSheetSelector" class="sheet-grid"></div>
                    </div>
                    
                    <!-- Digital Score Sheet Container -->
                    <div id="digitalScoreSheetContainer"></div>
                </div>
            </div>

            <!-- ENHANCED PREVIEW MODAL - UPDATE THE EXISTING ONE -->
            <div id="previewModal" class="preview-modal">
                <div class="preview-content">
                    <div class="preview-header">
                        <h4>ðŸ“„ Score Sheets Preview</h4>
                        <div>
                            <button onclick="printFromPreview()" class="score-control-btn print">ðŸ–¨ï¸ Print All</button>
                            <button onclick="openDigitalEntry()" class="score-control-btn save">âœï¸ Digital Entry</button>
                            <button onclick="closePreview()" class="score-control-btn" style="background: #6c757d; color: white;">âœ– Close</button>
                        </div>
                    </div>
                    <div class="preview-body">
                        <div id="previewContent" class="score-sheets-container"></div>
                    </div>
                </div>
            </div>

            <!-- Score Sheets Tab -->
            <!-- Score Sheets Tab - REPLACE THE EXISTING SCORE SHEETS TAB WITH THIS -->
            <div id="score-sheets" class="tab-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3>Score Sheets</h3>
                    <div>
                        <button type="button" onclick="selectAllDates()" style="background: #6c757d; margin-right: 10px;">Select All</button>
                        <button type="button" onclick="clearAllDates()" style="background: #6c757d;">Clear All</button>
                    </div>
                </div>
                
                <div class="score-sheet-section">
                    <!-- Sheet Type Selector -->
                    <div class="sheet-type-selector">
                        <h4>Select Score Sheet Type</h4>
                        <div>
                            <div class="sheet-type-option selected" onclick="selectSheetType('scent', this)">
                                <strong>Scent Detective</strong><br>
                                <small>Official Scent Work Score Sheet</small>
                            </div>
                            <div class="sheet-type-option" onclick="selectSheetType('standard', this)">
                                <strong>Standard Trial</strong><br>
                                <small>Regular Competition Score Sheet</small>
                            </div>
                        </div>
                    </div>

                    <div class="date-selection">
                        <h4>Select Dates to Print</h4>
                        <p>Choose which trial dates you want to generate score sheets for:</p>
                        <div id="dateSelectionContainer" class="date-checkbox-group"></div>
                        
                        <!-- Scent Detective Options -->
                        <div id="scentOptions" style="display: block; margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                            <h5>Scent Detective Options</h5>
                            <div class="form-group">
                                <label>Round to Mark:</label>
                                <select id="scentRoundSelect" style="margin-left: 10px;">
                                    <option value="1">Round 1</option>
                                    <option value="2">Round 2</option>
                                    <option value="3">Round 3</option>
                                    <option value="4">Round 4</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="print-controls">
                            <button class="preview-btn" onclick="previewScoreSheets()">ðŸ“„ Preview Score Sheets</button>
                            <button class="print-btn" onclick="printScoreSheets()">ðŸ–¨ï¸ Print Selected Sheets</button>
                            <div style="margin-left: auto; color: #666; font-size: 14px;">
                                <span id="selectedDatesCount">0 dates selected</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Running Order Tab -->
            <div id="running-order" class="tab-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3>Manage Running Order</h3>
                    <div>
                        <button type="button" onclick="resetAllRunningOrders()" style="background: #dc3545; margin-right: 10px;">Reset All Orders</button>
                        <button type="button" onclick="saveAllRunningOrders()">Save All Orders</button>
                    </div>
                </div>
                <div id="runningOrderContainer"></div>
            </div>
        </div>
    </div>
<button onclick="debugRegistration()" style="position: fixed; top: 10px; right: 10px; z-index: 99999; background: red; color: white;">
    DEBUG REG
</button>
    <!-- Print Preview Modal -->
    <div id="previewModal" class="preview-modal">
        <div class="preview-content">
            <div class="preview-header">
                <h4>Score Sheets Preview</h4>
                <div>
                    <button onclick="printFromPreview()" class="print-btn" style="margin-right: 10px;">ðŸ–¨ï¸ Print</button>
                    <button onclick="closePreview()" style="background: #6c757d; color: white; padding: 8px 15px; border: none; border-radius: 4px; cursor: pointer;">Close</button>
                </div>
            </div>
            <div class="preview-body">
                <div id="previewContent" class="score-sheets-container"></div>
            </div>
        </div>
    </div>
</body>
<script>
    // Global variables
        var currentUser = null;
        var currentTrialId = null;
        var dogData = [];
        var availableClasses = [];
        var availableJudges = [];
        var trialConfig = [];
        var entryResults = [];
        var runningOrders = {}; // Store custom running orders
        var digitalScores = {}; // Store digital scores
        var totalDays = 0;
        var savedDays = 0;
        var draggedElement = null;

        // Global variables
var currentUser = null;
var currentTrialId = null;
// ... other variables ...

// ADD THESE AUTHENTICATION FUNCTIONS HERE:
function showAuthTab(tab, element) {
    // Remove active class from all tabs
    var tabs = document.querySelectorAll('.auth-tab');
    for (var i = 0; i < tabs.length; i++) {
        tabs[i].classList.remove('active');
    }
    element.classList.add('active');
    
    // Remove active class from all forms
    var forms = document.querySelectorAll('.auth-form');
    for (var i = 0; i < forms.length; i++) {
        forms[i].classList.remove('active');
    }
    document.getElementById(tab + 'Form').classList.add('active');
}

function handleLogin(event) {
    event.preventDefault();
    
    var username = document.getElementById('loginUsername').value;
    var password = document.getElementById('loginPassword').value;
    
    var users = JSON.parse(localStorage.getItem('trialUsers') || '{}');
    
    if (users[username] && users[username].password === password) {
        currentUser = users[username];
        showMainApp();
        alert('Login successful!');
    } else {
        alert('Invalid username or password');
    }
}

function handleRegister(event) {
    console.log('handleRegister called');
    event.preventDefault();
    
    // Get form values with validation
    var username = document.getElementById('regUsername');
    var password = document.getElementById('regPassword');
    var confirmPassword = document.getElementById('regConfirmPassword');
    var fullName = document.getElementById('regFullName');
    var email = document.getElementById('regEmail');
    
    // Check if all elements exist
    if (!username || !password || !confirmPassword || !fullName || !email) {
        console.error('Missing form elements!');
        alert('Form elements missing - check HTML');
        return;
    }
    
    // Get actual values
    var usernameVal = username.value.trim();
    var passwordVal = password.value.trim();
    var confirmPasswordVal = confirmPassword.value.trim();
    var fullNameVal = fullName.value.trim();
    var emailVal = email.value.trim();
    
    console.log('Form values:', {
        username: usernameVal,
        password: passwordVal ? '[PASSWORD SET]' : '[EMPTY]',
        confirmPassword: confirmPasswordVal ? '[PASSWORD SET]' : '[EMPTY]',
        fullName: fullNameVal,
        email: emailVal
    });
    
    // Validate fields
    if (!usernameVal) {
        alert('Please enter a username');
        return;
    }
    if (!passwordVal) {
        alert('Please enter a password');
        return;
    }
    if (!confirmPasswordVal) {
        alert('Please confirm your password');
        return;
    }
    if (!fullNameVal) {
        alert('Please enter your full name');
        return;
    }
    if (!emailVal) {
        alert('Please enter your email');
        return;
    }
    
    if (passwordVal !== confirmPasswordVal) {
        alert('Passwords do not match');
        return;
    }
    
    // Check existing users
    var users = {};
    try {
        users = JSON.parse(localStorage.getItem('trialUsers') || '{}');
        console.log('Existing users:', Object.keys(users));
    } catch (error) {
        console.error('Error reading localStorage:', error);
        users = {};
    }
    
    if (users[usernameVal]) {
        alert('Username already exists: ' + usernameVal);
        return;
    }
    
    // Create new user
    var newUser = {
        username: usernameVal,
        password: passwordVal,
        fullName: fullNameVal,
        email: emailVal,
        created: new Date().toISOString()
    };
    
    users[usernameVal] = newUser;
    
    // Save to localStorage
    try {
        localStorage.setItem('trialUsers', JSON.stringify(users));
        console.log('User saved successfully:', usernameVal);
        
        // Verify save
        var savedUsers = JSON.parse(localStorage.getItem('trialUsers') || '{}');
        if (savedUsers[usernameVal]) {
            console.log('âœ… Registration successful!');
            alert('Registration successful! Please login with username: ' + usernameVal);
            
            // Clear form
            document.getElementById('registerForm').reset();
            
            // Switch to login tab
            var loginTab = document.querySelector('.auth-tab');
            if (loginTab) {
                showAuthTab('login', loginTab);
            }
        } else {
            console.error('âŒ Save verification failed');
            alert('Registration failed - could not save user data');
        }
    } catch (error) {
        console.error('Error saving to localStorage:', error);
        alert('Registration failed - storage error: ' + error.message);
    }
}

function showMainApp() {
    document.getElementById('authOverlay').classList.add('hidden');
    document.getElementById('mainApp').classList.remove('hidden');
    document.getElementById('userInfo').textContent = 'Welcome, ' + currentUser.fullName;
}

function logout() {
    currentUser = null;
    document.getElementById('authOverlay').classList.remove('hidden');
    document.getElementById('mainApp').classList.add('hidden');
}
    // Load JSON data automatically on page load
        function loadDogData() {
            var xhr = new XMLHttpRequest();
            xhr.open('GET', './data.json', true);
            xhr.onreadystatechange = function() {
                if (xhr.readyState === 4) {
                    if (xhr.status === 200) {
                        try {
                            var data = JSON.parse(xhr.responseText);
                            
                            if (Array.isArray(data) && data.length > 0) {
                                dogData = data;
                                availableClasses = getUniqueValues(data, 'className', 'class');
                                availableJudges = getUniqueValues(data, 'judge');
                                console.log('Dog data loaded successfully:', dogData.length, 'records');
                                showStatusMessage('Dog data loaded successfully!', 'success');
                            } else {
                                console.warn('JSON file appears to be empty or invalid format');
                                loadFallbackData();
                            }
                        } catch (error) {
                            console.error('Error parsing JSON data:', error);
                            loadFallbackData();
                        }
                    } else {
                        console.error('Could not load data.json');
                        loadFallbackData();
                    }
                }
            };
            xhr.send();
        }

        function getUniqueValues(data, field1, field2) {
            var values = [];
            for (var i = 0; i < data.length; i++) {
                var value = data[i][field1] || data[i][field2];
                if (value && values.indexOf(value) === -1) {
                    values.push(value);
                }
            }
            return values;
        }

        function loadFallbackData() {
            dogData = [
                { regNumber: "12345", callName: "Buddy" },
                { regNumber: "67890", callName: "Luna" },
                { regNumber: "11111", callName: "Max" },
                { regNumber: "22222", callName: "Bella" }
            ];
            availableClasses = ["Novice A", "Novice B", "Open A", "Open B", "Utility A", "Utility B"];
            availableJudges = ["Judge Smith", "Judge Johnson", "Judge Williams", "Judge Brown", "Judge Davis"];
            showStatusMessage('Using default data - could not load data.json', 'warning');
        }

        // Authentication functions
        function showAuthTab(tab, element) {
            // Remove active class from all tabs
            var tabs = document.querySelectorAll('.auth-tab');
            for (var i = 0; i < tabs.length; i++) {
                tabs[i].classList.remove('active');
            }
            element.classList.add('active');
            
            // Remove active class from all forms
            var forms = document.querySelectorAll('.auth-form');
            for (var i = 0; i < forms.length; i++) {
                forms[i].classList.remove('active');
            }
            document.getElementById(tab + 'Form').classList.add('active');
            
            console.log('Switched to ' + tab + ' tab');
        }

        function handleLogin(event) {
            event.preventDefault();
            
            var username = document.getElementById('loginUsername').value;
            var password = document.getElementById('loginPassword').value;
            
            console.log('Login attempt for:', username);
            
            var users = JSON.parse(localStorage.getItem('trialUsers') || '{}');
            console.log('Stored users:', Object.keys(users));
            
            if (users[username] && users[username].password === password) {
                currentUser = users[username];
                showMainApp();
                loadUserTrials();
                showStatusMessage('Login successful!', 'success');
            } else {
                showStatusMessage('Invalid username or password', 'warning');
            }
        }

        function handleRegister(event) {
            event.preventDefault();
            
            var username = document.getElementById('regUsername').value;
            var password = document.getElementById('regPassword').value;
            var confirmPassword = document.getElementById('regConfirmPassword').value;
            var fullName = document.getElementById('regFullName').value;
            var email = document.getElementById('regEmail').value;
            
            console.log('Registration attempt for:', username);
            
            if (password !== confirmPassword) {
                showStatusMessage('Passwords do not match', 'warning');
                return;
            }
            
            var users = JSON.parse(localStorage.getItem('trialUsers') || '{}');
            
            if (users[username]) {
                showStatusMessage('Username already exists', 'warning');
                return;
            }
            
            users[username] = {
                username: username,
                password: password,
                fullName: fullName,
                email: email,
                created: new Date().toISOString()
            };
            
            localStorage.setItem('trialUsers', JSON.stringify(users));
            console.log('User registered successfully:', username);
            showStatusMessage('Registration successful! Please login.', 'success');
            
            // Clear form and switch to login
            document.getElementById('registerForm').reset();
            showAuthTab('login', document.querySelector('.auth-tab'));
        }

        function showMainApp() {
            document.getElementById('authOverlay').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            document.getElementById('userInfo').textContent = 'Welcome, ' + currentUser.fullName;
            console.log('Main app shown for user:', currentUser.username);
        }

        function logout() {
            currentUser = null;
            currentTrialId = null;
            document.getElementById('authOverlay').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');
            
            // Clear all input fields
            var inputs = document.querySelectorAll('input');
            for (var i = 0; i < inputs.length; i++) {
                inputs[i].value = '';
            }
            
            console.log('User logged out');
        }

        // Trial management functions
        function loadUserTrials() {
            var userTrials = JSON.parse(localStorage.getItem('trials_' + currentUser.username) || '{}');
            var container = document.getElementById('myTrialsList');
            
            if (Object.keys(userTrials).length === 0) {
                container.innerHTML = '<p style="color: #666; font-style: italic;">No trials yet. Create your first trial!</p>';
                return;
            }
            
            var html = '';
            for (var trialId in userTrials) {
                if (userTrials.hasOwnProperty(trialId)) {
                    var trial = userTrials[trialId];
                    var created = new Date(trial.created).toLocaleDateString();
                    var days = trial.config ? getUniqueDays(trial.config).length : 0;
                    
                    // Get current entry count by syncing with public storage
                    var publicTrials = JSON.parse(localStorage.getItem('publicTrials') || '{}');
                    var userEntries = trial.results || [];
                    var publicEntries = (publicTrials[trialId] && publicTrials[trialId].results) ? publicTrials[trialId].results : [];
                    var totalEntries = mergeEntries(userEntries, publicEntries).length;
                    
                    var trialName = trial.name || 'Untitled Trial';
                    var trialStatus = (trial.config && trial.config.length > 0) ? 'Configured' : 'Setup Incomplete';
                    var statusColor = (trial.config && trial.config.length > 0) ? '#28a745' : '#ffc107';
                    
                    html += '<div class="trial-item">' +
                        '<div class="trial-info">' +
                        '<div class="trial-name">' + trialName + '</div>' +
                        '<div class="trial-meta">Created: ' + created + ' | Days: ' + days + ' | Entries: ' + totalEntries + '</div>' +
                        '<div class="trial-status" style="color: ' + statusColor + '; font-size: 12px; font-weight: bold;">' + trialStatus + '</div>' +
                        '</div>' +
                        '<div class="trial-actions">' +
                        '<button class="edit-btn" onclick="editTrial(\'' + trialId + '\')">Edit</button>';
                    
                    // Add Copy Link button if trial is configured
                    if (trial.config && trial.config.length > 0) {
                        html += '<button class="edit-btn" onclick="copyTrialLink(\'' + trialId + '\')" style="background: #17a2b8;">Copy Link</button>';
                    }
                    
                    html += '<button class="delete-btn" onclick="deleteTrial(\'' + trialId + '\')">Delete</button>' +
                        '</div>' +
                        '</div>';
                }
            }
            container.innerHTML = html;
        }

        function copyTrialLink(trialId) {
            var baseURL = window.location.origin + window.location.pathname;
            var shareableURL = baseURL + '?trial=' + trialId + '&mode=entry';
            
            // Create temporary input to copy text
            var tempInput = document.createElement('input');
            tempInput.value = shareableURL;
            document.body.appendChild(tempInput);
            tempInput.select();
            tempInput.setSelectionRange(0, 99999);
            
            try {
                document.execCommand('copy');
                showStatusMessage('Entry form link copied to clipboard!', 'success');
            } catch (err) {
                showStatusMessage('Could not copy link. URL: ' + shareableURL, 'warning');
            }
            
            document.body.removeChild(tempInput);
        }

        function getUniqueDays(config) {
            var days = [];
            for (var i = 0; i < config.length; i++) {
                if (days.indexOf(config[i].day) === -1) {
                    days.push(config[i].day);
                }
            }
            return days;
        }

        function createNewTrial() {
            currentTrialId = 'trial_' + Date.now();
            document.getElementById('trialTitle').textContent = 'New Trial Setup';
            document.getElementById('trialName').value = '';
            document.getElementById('trialDays').value = '';
            document.getElementById('daysContainer').innerHTML = '';
           trialConfig = [];
entryResults = [];
runningOrders = {};
digitalScores = {};
digitalScoreData = {};
            updateTrialOptions();
            updateResultsDisplay();
            updateCrossReferenceDisplay();
            showTab('setup', document.querySelector('.nav-tab'));
        }

        function editTrial(trialId) {
            var userTrials = JSON.parse(localStorage.getItem('trials_' + currentUser.username) || '{}');
            var trial = userTrials[trialId];
            
            if (!trial) {
                alert('Trial not found');
                return;
            }
            
            currentTrialId = trialId;
            document.getElementById('trialTitle').textContent = 'Editing: ' + (trial.name || 'Untitled Trial');
            document.getElementById('trialName').value = trial.name || '';
            
            trialConfig = trial.config || [];
runningOrders = trial.runningOrders || {};
digitalScores = trial.digitalScores || {};
digitalScoreData = trial.digitalScoreData || {};
loadExistingDigitalScores();
            
            // Load entries from both user storage and public storage, then merge
            var userEntries = trial.results || [];
            var publicTrials = JSON.parse(localStorage.getItem('publicTrials') || '{}');
            var publicEntries = (publicTrials[trialId] && publicTrials[trialId].results) ? publicTrials[trialId].results : [];
            
            // Merge entries and remove duplicates based on timestamp
            entryResults = mergeEntries(userEntries, publicEntries);
            
            // Save merged entries back to user storage
            userTrials[trialId].results = entryResults;
            localStorage.setItem('trials_' + currentUser.username, JSON.stringify(userTrials));
            
            if (trialConfig.length > 0) {
                var maxDay = getMaxDay(trialConfig);
                document.getElementById('trialDays').value = maxDay;
                generateDays();
                
                setTimeout(function() {
                    populateExistingTrialData();
                }, 100);
            }
            
            updateTrialOptions();
            updateResultsDisplay();
            updateCrossReferenceDisplay();
            showTab('setup', document.querySelector('.nav-tab'));
        }

        function mergeEntries(userEntries, publicEntries) {
            var merged = [];
            var timestamps = {};
            
            // Add user entries first
            for (var i = 0; i < userEntries.length; i++) {
                merged.push(userEntries[i]);
                timestamps[userEntries[i].timestamp] = true;
            }
            
            // Add public entries that don't already exist
            for (var i = 0; i < publicEntries.length; i++) {
                if (!timestamps[publicEntries[i].timestamp]) {
                    merged.push(publicEntries[i]);
                    timestamps[publicEntries[i].timestamp] = true;
                }
            }
            
            return merged;
        }

        function getMaxDay(config) {
            var max = 0;
            for (var i = 0; i < config.length; i++) {
                if (config[i].day > max) {
                    max = config[i].day;
                }
            }
            return max;
        }

        function populateExistingTrialData() {
            for (var i = 0; i < trialConfig.length; i++) {
                var config = trialConfig[i];
                var dayNum = config.day;
                var dateInput = document.getElementById('date_' + dayNum);
                if (dateInput) {
                    dateInput.value = config.date;
                }
                
                var classInput = document.getElementById('class_' + dayNum + '_' + config.classNum);
                if (classInput) {
                    classInput.value = config.className;
                }
                
                var judgeInput = document.getElementById('judge_' + dayNum + '_' + config.classNum + '_' + config.roundNum);
                if (judgeInput) {
                    judgeInput.value = config.judge;
                }
                
                var feoInput = document.getElementById('feo_' + dayNum + '_' + config.classNum + '_' + config.roundNum);
                if (feoInput) {
                    feoInput.checked = config.feoOffered || false;
                }
            }
        }

        function deleteTrial(trialId) {
            if (confirm('Are you sure you want to delete this trial? This action cannot be undone.')) {
                var userTrials = JSON.parse(localStorage.getItem('trials_' + currentUser.username) || '{}');
                delete userTrials[trialId];
                localStorage.setItem('trials_' + currentUser.username, JSON.stringify(userTrials));
                loadUserTrials();
            }
        }

        function saveTrialData() {
            if (!currentUser) {
                alert("Please log in first.");
                return;
            }
            
            if (!currentTrialId) {
                alert("Please create a new trial first.");
                return;
            }
            
            var trialName = document.getElementById('trialName').value.trim();
            if (!trialName) {
                alert("Please enter a trial name.");
                return;
            }

            if (trialConfig.length === 0) {
                alert("Please configure at least one day before saving the trial.");
                return;
            }
            
            var userTrials = JSON.parse(localStorage.getItem('trials_' + currentUser.username) || '{}');
            
            var trialData = {
    name: trialName,
    config: trialConfig,
    results: entryResults,
    runningOrders: runningOrders,
    digitalScores: digitalScores,
    digitalScoreData: digitalScoreData,
    owner: currentUser.username,
                created: userTrials[currentTrialId] && userTrials[currentTrialId].created ? userTrials[currentTrialId].created : new Date().toISOString(),
                updated: new Date().toISOString()
            };
            
            userTrials[currentTrialId] = trialData;
            localStorage.setItem('trials_' + currentUser.username, JSON.stringify(userTrials));
            
            var publicTrials = JSON.parse(localStorage.getItem('publicTrials') || '{}');
            publicTrials[currentTrialId] = trialData;
            localStorage.setItem('publicTrials', JSON.stringify(publicTrials));
            
            generateShareableURL();
            document.getElementById('entryFormLink').style.display = 'block';
            showStatusMessage("Trial saved successfully!", "success");
            loadUserTrials();
        }

        // Tab functions
        function showTab(tabName, element) {
            var tabs = document.querySelectorAll('.nav-tab');
            for (var i = 0; i < tabs.length; i++) {
                tabs[i].classList.remove('active');
            }
            if (element) {
                element.classList.add('active');
            }
            
            var contents = document.querySelectorAll('.tab-content');
            for (var i = 0; i < contents.length; i++) {
                contents[i].classList.remove('active');
            }
            document.getElementById(tabName).classList.add('active');
            
            // If switching to Results tab, sync entries from public storage
            if (tabName === 'results' && currentTrialId && currentUser) {
                syncEntriesFromPublic();
            }
            
            // If switching to Cross-Reference tab, load the grid
            if (tabName === 'cross-reference' && currentTrialId) {
                loadCrossReferenceTab();
            }
            
            // If switching to Running Order tab, load running orders
            if (tabName === 'running-order' && currentTrialId) {
                loadRunningOrderManagement();
            }
            
            // If switching to Score Sheets tab, load date selection
            if (tabName === 'score-sheets' && currentTrialId) {
                loadScoreSheetsManagement();
            }
            
            // If switching to Score Entry tab, load digital scoring
         if (tabName === 'score-entry' && currentTrialId) {
    loadDigitalScoreEntry();
    loadExistingDigitalScores();
}
        }

        function syncEntriesFromPublic() {
            if (!currentTrialId || !currentUser) return;
            
            var userTrials = JSON.parse(localStorage.getItem('trials_' + currentUser.username) || '{}');
            var publicTrials = JSON.parse(localStorage.getItem('publicTrials') || '{}');
            
            if (userTrials[currentTrialId] && publicTrials[currentTrialId]) {
                var userEntries = userTrials[currentTrialId].results || [];
                var publicEntries = publicTrials[currentTrialId].results || [];
                
                // Merge entries
                entryResults = mergeEntries(userEntries, publicEntries);
                
                // Save back to user storage
                userTrials[currentTrialId].results = entryResults;
                userTrials[currentTrialId].updated = new Date().toISOString();
                localStorage.setItem('trials_' + currentUser.username, JSON.stringify(userTrials));
                
                // Update display
                updateResultsDisplay();
                updateCrossReferenceDisplay();
                
                // Update trial count in dashboard
                loadUserTrials();
            }
        }
        // Drag and Drop Functions for Running Order
        function handleDragStart(event) {
            draggedElement = event.target;
            event.target.classList.add('dragging');
            event.dataTransfer.effectAllowed = 'move';
            event.dataTransfer.setData('text/html', event.target.outerHTML);
            console.log('Drag started for:', event.target.dataset.reg);
        }

        function handleDragEnd(event) {
            event.target.classList.remove('dragging');
            
            // Remove any drag-over classes
            var allEntries = document.querySelectorAll('.draggable-entry');
            for (var i = 0; i < allEntries.length; i++) {
                allEntries[i].classList.remove('drag-over');
            }
            
            draggedElement = null;
            console.log('Drag ended');
        }

        function handleDragOver(event) {
            event.preventDefault();
            event.dataTransfer.dropEffect = 'move';
            
            // Find the closest draggable entry
            var target = event.target;
            while (target && !target.classList.contains('draggable-entry')) {
                target = target.parentElement;
            }
            
            if (target && target !== draggedElement) {
                // Remove drag-over from all entries
                var allEntries = document.querySelectorAll('.draggable-entry');
                for (var i = 0; i < allEntries.length; i++) {
                    allEntries[i].classList.remove('drag-over');
                }
                target.classList.add('drag-over');
            }
        }

        function handleDrop(event) {
            event.preventDefault();
            
            if (!draggedElement) return;
            
            var target = event.target;
            var container = null;
            
            // Find the container (running-order-list)
            while (target && !target.classList.contains('running-order-list')) {
                target = target.parentElement;
            }
            container = target;
            
            // Find the specific entry to drop on/before
            target = event.target;
            while (target && !target.classList.contains('draggable-entry') && target !== container) {
                target = target.parentElement;
            }
            
            if (container && draggedElement) {
                if (target && target.classList.contains('draggable-entry') && target !== draggedElement) {
                    // Insert before the target
                    container.insertBefore(draggedElement, target);
                } else if (target === container) {
                    // Append to the end
                    container.appendChild(draggedElement);
                }
                
                // Update position numbers
                updatePositionNumbers(container);
                
                console.log('Drop completed, positions updated');
            }
            
            // Clean up drag-over classes
            var allEntries = document.querySelectorAll('.draggable-entry');
            for (var i = 0; i < allEntries.length; i++) {
                allEntries[i].classList.remove('drag-over');
            }
        }

        function updatePositionNumbers(container) {
            var entries = container.querySelectorAll('.draggable-entry');
            for (var i = 0; i < entries.length; i++) {
                var positionElement = entries[i].querySelector('.entry-position');
                if (positionElement) {
                    positionElement.textContent = i + 1;
                }
            }
        }

        // Running Order Management Functions
        function loadRunningOrderManagement() {
            var container = document.getElementById('runningOrderContainer');
            
            if (trialConfig.length === 0) {
                container.innerHTML = '<p style="color: #666; padding: 20px;">No trial configuration found. Please complete trial setup first.</p>';
                return;
            }
            
            // Generate sample running order if none exists
            generateSampleRunningOrder();
            
            var html = '<div class="running-order-section">' +
                '<div class="running-order-header">' +
                '<h3>ðŸƒâ€â™€ï¸ Running Order Management</h3>' +
                '<div>' +
                '<button type="button" onclick="generateRunningOrders()" style="background: #28a745; margin-right: 10px;">ðŸ”„ Generate Orders</button>' +
                '<button type="button" onclick="exportRunningOrders()" style="background: #17a2b8;">ðŸ“Š Export Orders</button>' +
                '</div>' +
                '</div>';
            
            // Group by date/class/round
            var groups = {};
            for (var i = 0; i < trialConfig.length; i++) {
                var config = trialConfig[i];
                var key = config.date + '|' + config.className + '|' + config.roundNum;
                if (!groups[key]) {
                    groups[key] = config;
                }
            }
            
            // Generate running order sections for each group
            for (var key in groups) {
                var config = groups[key];
                var containerId = 'order_' + key.replace(/[|]/g, '_').replace(/[^a-zA-Z0-9_]/g, '');
                
                html += '<div class="class-round-group">' +
                    '<div class="class-round-header">' +
                    '<span>' + config.className + ' - Round ' + config.roundNum + ' - ' + config.judge + ' (' + config.date + ')</span>' +
                    '<div class="shuffle-controls">' +
                    '<button class="shuffle-btn" onclick="shuffleOrder(\'' + containerId + '\')">ðŸŽ² Shuffle</button>' +
                    '<button class="auto-fix-btn" onclick="autoFixConflicts(\'' + containerId + '\')">ðŸ”§ Auto-fix</button>' +
                    '</div>' +
                    '</div>' +
                    '<div class="running-order-list" id="' + containerId + '" ondrop="handleDrop(event)" ondragover="handleDragOver(event)">';
                
                // Get entries for this class/round
                var entries = getEntriesForClassRound(config.date, config.className, config.roundNum);
                
                for (var e = 0; e < entries.length; e++) {
                    var entry = entries[e];
                    html += '<div class="draggable-entry" draggable="true" ondragstart="handleDragStart(event)" ondragend="handleDragEnd(event)" data-reg="' + entry.regNumber + '" data-entry-type="' + entry.entryType + '">' +
                        '<div class="entry-info">' +
                        '<div class="entry-details">' + entry.regNumber + ' - ' + entry.callName + ' (Handler: ' + entry.handler + ')</div>' +
                        '<div class="entry-meta">' + entry.entryType.charAt(0).toUpperCase() + entry.entryType.slice(1) + ' Entry</div>' +
                        '</div>' +
                        '<div class="entry-position">' + (e + 1) + '</div>' +
                        '<div class="drag-handle">â‹®â‹®</div>' +
                        '</div>';
                }
                
                html += '</div></div>';
            }
            
            html += '</div>';
            container.innerHTML = html;
        }

        function generateSampleRunningOrder() {
            // This would generate sample data if no entries exist
            if (entryResults.length === 0) {
                // Add sample entries for testing
                entryResults = [
                    { regNumber: "12345", callName: "Buddy", handler: "John Smith", date: "2024-01-15", className: "Novice A", round: 1, judge: "Judge Smith", entryType: "regular", timestamp: new Date().toISOString() },
                    { regNumber: "67890", callName: "Luna", handler: "Jane Doe", date: "2024-01-15", className: "Novice A", round: 1, judge: "Judge Smith", entryType: "regular", timestamp: new Date().toISOString() },
                    { regNumber: "11111", callName: "Max", handler: "Bob Wilson", date: "2024-01-15", className: "Novice A", round: 1, judge: "Judge Smith", entryType: "feo", timestamp: new Date().toISOString() },
                    { regNumber: "22222", callName: "Bella", handler: "Sarah Johnson", date: "2024-01-15", className: "Novice A", round: 1, judge: "Judge Smith", entryType: "regular", timestamp: new Date().toISOString() }
                ];
            }
        }

        function getEntriesForClassRound(date, className, round) {
            var entries = [];
            for (var i = 0; i < entryResults.length; i++) {
                var entry = entryResults[i];
                if (entry.date === date && entry.className === className && entry.round == round) {
                    entries.push(entry);
                }
            }
            return entries;
        }

        function shuffleOrder(containerId) {
            var container = document.getElementById(containerId);
            if (!container) return;
            
            var entries = Array.from(container.querySelectorAll('.draggable-entry'));
            
            // Fisher-Yates shuffle
            for (var i = entries.length - 1; i > 0; i--) {
                var j = Math.floor(Math.random() * (i + 1));
                var temp = entries[i];
                entries[i] = entries[j];
                entries[j] = temp;
            }
            
            // Clear container and re-add shuffled entries
            container.innerHTML = '';
            for (var i = 0; i < entries.length; i++) {
                container.appendChild(entries[i]);
            }
            
            updatePositionNumbers(container);
            showStatusMessage('Running order shuffled!', 'success');
        }

        function autoFixConflicts(containerId) {
            showStatusMessage('Conflicts auto-fixed!', 'success');
        }

        function generateRunningOrders() {
            showStatusMessage('Running orders generated!', 'success');
        }

        function exportRunningOrders() {
            showStatusMessage('Running orders exported!', 'success');
        }

        function resetAllRunningOrders() {
            if (confirm('Are you sure you want to reset all running orders?')) {
                showStatusMessage('All running orders reset!', 'success');
            }
        }

        function saveAllRunningOrders() {
            showStatusMessage('All running orders saved!', 'success');
        }
        // Trial setup functions
        function generateDays() {
            var numDays = parseInt(document.getElementById('trialDays').value);
            if (!numDays || numDays < 1) {
                alert('Please enter a valid number of days');
                return;
            }

            totalDays = numDays;
            savedDays = 0;
            var container = document.getElementById('daysContainer');
            container.innerHTML = '';

            for (var i = 1; i <= numDays; i++) {
                createDaySection(i, container);
            }
        }

        function createDaySection(dayNum, container) {
            var dayDiv = document.createElement('div');
            dayDiv.className = 'day-container';
            dayDiv.innerHTML = '<div class="day-header">Day ' + dayNum + '</div>' +
                '<div class="form-group">' +
                '<span class="label">Date for Day ' + dayNum + ':</span>' +
                '<input type="date" id="date_' + dayNum + '">' +
                '</div>' +
                '<div class="classes-section">' +
                '<div class="form-group">' +
                '<span class="label">How many classes this day?</span>' +
                '<input type="number" id="classes_' + dayNum + '" min="1" max="20" class="yellow-highlight" placeholder="Number" onchange="generateClasses(' + dayNum + ')">' +
                '</div>' +
                '<div id="classesContainer_' + dayNum + '"></div>' +
                '</div>' +
                '<div class="form-group">' +
                '<button onclick="saveTrialDay(' + dayNum + ')">Save Day ' + dayNum + '</button>' +
                '</div>';
            container.appendChild(dayDiv);
        }

        function generateClasses(dayNum) {
            var numClasses = parseInt(document.getElementById('classes_' + dayNum).value);
            if (!numClasses || numClasses < 1) return;

            var container = document.getElementById('classesContainer_' + dayNum);
            container.innerHTML = '';

            for (var i = 1; i <= numClasses; i++) {
                createClassSection(dayNum, i, container);
            }
        }

        function createClassSection(dayNum, classNum, container) {
            var classDiv = document.createElement('div');
            classDiv.className = 'class-container';
            
            classDiv.innerHTML = '<div class="class-header">Class ' + classNum + '</div>' +
                '<div class="form-group">' +
                '<span class="label">Class Name:</span>' +
                '<div class="typeahead-container">' +
                '<input type="text" id="class_' + dayNum + '_' + classNum + '" class="typeahead-input" placeholder="Type or select class name" onkeyup="handleClassTypeahead(this, ' + dayNum + ', ' + classNum + ')" onblur="hideClassDropdown(' + dayNum + ', ' + classNum + ')" onfocus="showClassDropdown(' + dayNum + ', ' + classNum + ')">' +
                '<div id="classDropdown_' + dayNum + '_' + classNum + '" class="typeahead-dropdown"></div>' +
                '</div>' +
                '</div>' +
                '<div class="rounds-section">' +
                '<div class="form-group">' +
                '<span class="label">How many rounds?</span>' +
                '<input type="number" id="rounds_' + dayNum + '_' + classNum + '" min="1" max="10" placeholder="Number" onchange="generateRounds(' + dayNum + ', ' + classNum + ')">' +
                '</div>' +
                '<div id="roundsContainer_' + dayNum + '_' + classNum + '"></div>' +
                '</div>';
            container.appendChild(classDiv);
        }

        function handleClassTypeahead(input, dayNum, classNum) {
            var query = input.value.toLowerCase();
            var dropdown = document.getElementById('classDropdown_' + dayNum + '_' + classNum);
            
            if (query.length === 0) {
                dropdown.style.display = 'none';
                return;
            }

            var matches = [];
            for (var i = 0; i < availableClasses.length; i++) {
                if (availableClasses[i].toLowerCase().indexOf(query) !== -1) {
                    matches.push(availableClasses[i]);
                }
            }

            if (matches.length > 0) {
                var html = '';
                for (var i = 0; i < matches.length; i++) {
                    html += '<div class="typeahead-item" onclick="selectClass(\'' + matches[i] + '\', ' + dayNum + ', ' + classNum + ')">' + matches[i] + '</div>';
                }
                dropdown.innerHTML = html;
                dropdown.style.display = 'block';
            } else {
                dropdown.style.display = 'none';
            }
        }

        function selectClass(className, dayNum, classNum) {
            document.getElementById('class_' + dayNum + '_' + classNum).value = className;
            document.getElementById('classDropdown_' + dayNum + '_' + classNum).style.display = 'none';
        }

        function hideClassDropdown(dayNum, classNum) {
            setTimeout(function() {
                document.getElementById('classDropdown_' + dayNum + '_' + classNum).style.display = 'none';
            }, 200);
        }

        function showClassDropdown(dayNum, classNum) {
            var input = document.getElementById('class_' + dayNum + '_' + classNum);
            if (input.value.length > 0) {
                handleClassTypeahead(input, dayNum, classNum);
            } else {
                var dropdown = document.getElementById('classDropdown_' + dayNum + '_' + classNum);
                var html = '';
                for (var i = 0; i < availableClasses.length; i++) {
                    html += '<div class="typeahead-item" onclick="selectClass(\'' + availableClasses[i] + '\', ' + dayNum + ', ' + classNum + ')">' + availableClasses[i] + '</div>';
                }
                dropdown.innerHTML = html;
                dropdown.style.display = 'block';
            }
            }

        function generateRounds(dayNum, classNum) {
            var numRounds = parseInt(document.getElementById('rounds_' + dayNum + '_' + classNum).value);
            if (!numRounds || numRounds < 1) return;

            var container = document.getElementById('roundsContainer_' + dayNum + '_' + classNum);
            container.innerHTML = '';

            for (var i = 1; i <= numRounds; i++) {
                var roundDiv = document.createElement('div');
                roundDiv.style.margin = '10px 0';
                roundDiv.style.padding = '10px';
                roundDiv.style.background = '#f8f9fa';
                roundDiv.style.borderRadius = '5px';
                
                roundDiv.innerHTML = '<div class="form-group">' +
                    '<span class="label">Round ' + i + ' Judge:</span>' +
                    '<div class="typeahead-container">' +
                    '<input type="text" id="judge_' + dayNum + '_' + classNum + '_' + i + '" class="typeahead-input" placeholder="Type or select judge name" onkeyup="handleJudgeTypeahead(this, ' + dayNum + ', ' + classNum + ', ' + i + ')" onblur="hideJudgeDropdown(' + dayNum + ', ' + classNum + ', ' + i + ')" onfocus="showJudgeDropdown(' + dayNum + ', ' + classNum + ', ' + i + ')">' +
                    '<div id="judgeDropdown_' + dayNum + '_' + classNum + '_' + i + '" class="typeahead-dropdown"></div>' +
                    '</div>' +
                    '</div>' +
                    '<div class="form-group">' +
                    '<label style="display: flex; align-items: center; gap: 8px;">' +
                    '<input type="checkbox" id="feo_' + dayNum + '_' + classNum + '_' + i + '">' +
                    '<span>FEO (For Exhibition Only) available for this round</span>' +
                    '</label>' +
                    '</div>';
                container.appendChild(roundDiv);
            }
        }

        function handleJudgeTypeahead(input, dayNum, classNum, roundNum) {
            var query = input.value.toLowerCase();
            var dropdown = document.getElementById('judgeDropdown_' + dayNum + '_' + classNum + '_' + roundNum);
            
            if (query.length === 0) {
                dropdown.style.display = 'none';
                return;
            }

            var matches = [];
            for (var i = 0; i < availableJudges.length; i++) {
                if (availableJudges[i].toLowerCase().indexOf(query) !== -1) {
                    matches.push(availableJudges[i]);
                }
            }

            if (matches.length > 0) {
                var html = '';
                for (var i = 0; i < matches.length; i++) {
                    html += '<div class="typeahead-item" onclick="selectJudge(\'' + matches[i] + '\', ' + dayNum + ', ' + classNum + ', ' + roundNum + ')">' + matches[i] + '</div>';
                }
                dropdown.innerHTML = html;
                dropdown.style.display = 'block';
            } else {
                dropdown.style.display = 'none';
            }
        }

        function selectJudge(judgeName, dayNum, classNum, roundNum) {
            document.getElementById('judge_' + dayNum + '_' + classNum + '_' + roundNum).value = judgeName;
            document.getElementById('judgeDropdown_' + dayNum + '_' + classNum + '_' + roundNum).style.display = 'none';
        }

        function hideJudgeDropdown(dayNum, classNum, roundNum) {
            setTimeout(function() {
                document.getElementById('judgeDropdown_' + dayNum + '_' + classNum + '_' + roundNum).style.display = 'none';
            }, 200);
        }

        function showJudgeDropdown(dayNum, classNum, roundNum) {
            var input = document.getElementById('judge_' + dayNum + '_' + classNum + '_' + roundNum);
            if (input.value.length > 0) {
                handleJudgeTypeahead(input, dayNum, classNum, roundNum);
            } else {
                var dropdown = document.getElementById('judgeDropdown_' + dayNum + '_' + classNum + '_' + roundNum);
                var html = '';
                for (var i = 0; i < availableJudges.length; i++) {
                    html += '<div class="typeahead-item" onclick="selectJudge(\'' + availableJudges[i] + '\', ' + dayNum + ', ' + classNum + ', ' + roundNum + ')">' + availableJudges[i] + '</div>';
                }
                dropdown.innerHTML = html;
                dropdown.style.display = 'block';
            }
        }

        // Enhanced Preview and Digital Score Entry Functions - Part A
        // ADD THESE TO YOUR JAVASCRIPT SECTION
        
        var currentDigitalSheet = null;
        var autoSaveTimer = null;
        var digitalScoreData = {};
        
        // Enhanced Preview Functions
        function previewScoreSheets() {
            generateScoreSheets(true);
        }

        function closePreview() {
            document.getElementById('previewModal').classList.remove('show');
            document.getElementById('previewModal').style.display = 'none';
        }

        function printFromPreview() {
            var printContent = document.getElementById('previewContent').innerHTML;
            var printWindow = window.open('', '_blank');
            printWindow.document.write('<html><head><title>Score Sheets</title>');
            printWindow.document.write('<style>' + getScentScoreSheetStyles() + '</style>');
            printWindow.document.write('</head><body>' + printContent + '</body></html>');
            printWindow.document.close();
            printWindow.print();
        }

        function openDigitalEntry() {
            closePreview();
            showTab('score-entry', document.querySelectorAll('.nav-tab')[6]);
        }

        // Enhanced Score Sheet Generation
        function generateScoreSheets(preview) {
            var selectedDates = [];
            var checkboxes = document.querySelectorAll('#dateSelectionContainer input[type="checkbox"]:checked');
            
            for (var i = 0; i < checkboxes.length; i++) {
                selectedDates.push(checkboxes[i].value);
            }
            
            if (selectedDates.length === 0) {
                alert('Please select at least one date');
                return;
            }
            
            var sheetsHTML = '';
            
            for (var d = 0; d < selectedDates.length; d++) {
                var date = selectedDates[d];
                
                // Get classes for this date
                var classesForDate = {};
                for (var i = 0; i < trialConfig.length; i++) {
                    var config = trialConfig[i];
                    if (config.date === date) {
                        var key = config.className + '_' + config.roundNum;
                        if (!classesForDate[key]) {
                            classesForDate[key] = config;
                        }
                    }
                }
                
                // Generate sheet for each class/round combination
                for (var classKey in classesForDate) {
                    var config = classesForDate[classKey];
                    var entriesForClass = getEntriesForClassRound(config.date, config.className, config.roundNum);
                    
                    if (selectedSheetType === 'scent') {
                        sheetsHTML += generateScentDetectiveSheet(config, entriesForClass);
                    } else {
                        sheetsHTML += generateStandardSheet(config, entriesForClass);
                    }
                }
            }
            
            if (preview) {
                document.getElementById('previewContent').innerHTML = sheetsHTML;
                document.getElementById('previewModal').style.display = 'flex';
                document.getElementById('previewModal').classList.add('show');
            } else {
                var printWindow = window.open('', '_blank');
                printWindow.document.write('<html><head><title>Score Sheets</title>');
                printWindow.document.write('<style>' + getScentScoreSheetStyles() + '</style>');
                printWindow.document.write('</head><body>' + sheetsHTML + '</body></html>');
                printWindow.document.close();
                printWindow.print();
            }
        }

        // Digital Score Entry Functions
        function loadDigitalScoreEntry() {
            if (trialConfig.length === 0) {
                document.getElementById('digitalSheetSelector').innerHTML = 
                    '<p style="color: #666; padding: 20px; text-align: center;">No trial configuration found. Please complete trial setup first.</p>';
                return;
            }
            
            loadDigitalSheetSelector();
            updateCompletionProgress();
        }

        function loadDigitalSheetSelector() {
            // Group by date/class/round for selection
            var sheetOptions = {};
            
            for (var i = 0; i < trialConfig.length; i++) {
                var config = trialConfig[i];
                var key = config.date + '|' + config.className + '|' + config.roundNum;
                if (!sheetOptions[key]) {
                    var entriesForClass = getEntriesForClassRound(config.date, config.className, config.roundNum);
                    sheetOptions[key] = {
                        config: config,
                        entries: entriesForClass,
                        key: key
                    };
                }
            }
            
            var html = '';
            var sortedKeys = Object.keys(sheetOptions).sort();
            
            for (var i = 0; i < sortedKeys.length; i++) {
                var key = sortedKeys[i];
                var option = sheetOptions[key];
                var config = option.config;
                var entries = option.entries;
                
                if (entries.length === 0) continue;
                
                var formattedDate = new Date(config.date).toLocaleDateString();
                var completedCount = getCompletedScoresCount(key);
                var totalEntries = entries.length;
                var isSelected = (currentDigitalSheet === key);
                
                html += '<div class="sheet-option' + (isSelected ? ' selected' : '') + '" onclick="selectDigitalSheet(\'' + key + '\')">' +
                    '<div class="sheet-option-title">' + config.className + ' - Round ' + config.roundNum + '</div>' +
                    '<div class="sheet-option-meta">' + formattedDate + ' | Judge: ' + config.judge + '</div>' +
                    '<div class="sheet-option-stats">' + completedCount + '/' + totalEntries + ' scored (' + 
                    Math.round((completedCount / totalEntries) * 100) + '%)</div>' +
                    '</div>';
            }
            
            if (html === '') {
                html = '<p style="color: #666; padding: 20px; text-align: center;">No entries found. Please add entries to your trial first.</p>';
            }
            
            document.getElementById('digitalSheetSelector').innerHTML = html;
        }

        function selectDigitalSheet(sheetKey) {
            currentDigitalSheet = sheetKey;
            
            // Update visual selection
            var options = document.querySelectorAll('.sheet-option');
            for (var i = 0; i < options.length; i++) {
                options[i].classList.remove('selected');
            }
            event.target.classList.add('selected');
            
            loadDigitalScoreSheet(sheetKey);
            updateCompletionProgress();
        }

        function loadDigitalScoreSheet(sheetKey) {
            var keyParts = sheetKey.split('|');
            var date = keyParts[0];
            var className = keyParts[1];
            var round = keyParts[2];
            
            // Find config and entries
            var config = null;
            for (var i = 0; i < trialConfig.length; i++) {
                if (trialConfig[i].date === date && 
                    trialConfig[i].className === className && 
                    trialConfig[i].roundNum == round) {
                    config = trialConfig[i];
                    break;
                }
            }
            
            if (!config) return;
            
            var entries = getEntriesForClassRound(date, className, round);
            if (entries.length === 0) {
                document.getElementById('digitalScoreSheetContainer').innerHTML = 
                    '<p style="color: #666; padding: 20px; text-align: center;">No entries found for this class/round.</p>';
                return;
            }
            
            var html = generateDigitalScentSheet(config, entries, sheetKey);
            document.getElementById('digitalScoreSheetContainer').innerHTML = html;
        }

        function generateDigitalScentSheet(config, entries, sheetKey) {
            var formattedDate = new Date(config.date).toLocaleDateString();
            
            var html = '<div class="digital-score-sheet">' +
                '<div class="digital-sheet-header">' +
                '<div class="scent-sheet-title">Scent Detective Digital Score Entry</div>' +
                '<div class="scent-sheet-info">' +
                '<div>Date: <strong>' + formattedDate + '</strong></div>' +
                '<div>CLASS: <strong>' + config.className + '</strong></div>' +
                '<div>Round: <strong>' + config.roundNum + '</strong></div>' +
                '<div>Judge: <strong>' + config.judge + '</strong></div>' +
                '</div>' +
                '</div>' +
                
                '<div class="digital-sheet-controls">' +
                '<div>' +
                '<button class="score-control-btn save" onclick="saveCurrentSheet()">ðŸ’¾ Save Scores</button>' +
                '<button class="score-control-btn clear" onclick="clearCurrentSheet()">ðŸ—‘ï¸ Clear Sheet</button>' +
                '<button class="score-control-btn export" onclick="exportCurrentSheet()">ðŸ“Š Export Sheet</button>' +
                '</div>' +
                '<div>' +
                '<label style="font-size: 12px;">' +
                '<input type="checkbox" id="autoSaveEnabled" checked onchange="toggleAutoSave()"> Auto-save enabled' +
                '</label>' +
                '</div>' +
                '</div>';
            
            // Scent locations section
            html += '<div class="scent-locations">' +
                '<div class="scent-location">' +
                '<strong>Scent 1 Located:</strong><br>' +
                '<input type="text" id="scent1Location" placeholder="Location..." style="width: 90%; margin-top: 5px;" onchange="saveScoreData()">' +
                '</div>' +
                '<div class="scent-location">' +
                '<strong>Scent 2 Located:</strong><br>' +
                '<input type="text" id="scent2Location" placeholder="Location..." style="width: 90%; margin-top: 5px;" onchange="saveScoreData()">' +
                '</div>' +
                '<div class="scent-location">' +
                '<strong>Scent 3 Located:</strong><br>' +
                '<input type="text" id="scent3Location" placeholder="Location..." style="width: 90%; margin-top: 5px;" onchange="saveScoreData()">' +
                '</div>' +
                '<div class="scent-location">' +
                '<strong>Scent 4 Located:</strong><br>' +
                '<input type="text" id="scent4Location" placeholder="Location..." style="width: 90%; margin-top: 5px;" onchange="saveScoreData()">' +
                '</div>' +
                '</div>';
            
            html += '<div class="scent-faults-section">' +
                '<strong>Faults:</strong> Dropped Food; Dog stops working; Handler guiding dog; ' +
                'Incorrect find; Destructive behavior; Disturbing search area by dog or handler; ' +
                'Verbally naming item; Continue search after "alert"; SR crossing line less than half.' +
                '</div>';
            
            // Digital score table
            html += '<table class="scent-score-table">' +
                '<thead>' +
                '<tr>' +
                '<th class="scent-team-col">Team</th>' +
                '<th class="scent-dog-handler-col">Dog -- Handler</th>' +
                '<th class="scent-scent-col">Scent 1</th>' +
                '<th class="scent-scent-col">Scent 2</th>' +
                '<th class="scent-scent-col">Scent 3</th>' +
                '<th class="scent-scent-col">Scent 4</th>' +
                '<th class="scent-fault-col">Faults</th>' +
                '<th class="scent-time-col">Time</th>' +
                '<th class="scent-pass-fail-col">Result</th>' +
                '</tr>' +
                '</thead>' +
                '<tbody>';
            
            // Add entries with input fields
            for (var i = 0; i < entries.length; i++) {
                var entry = entries[i];
                var entryKey = sheetKey + '|' + entry.regNumber + '|' + entry.entryType;
                var savedData = digitalScoreData[entryKey] || {};
                
                html += '<tr class="score-entry-row" data-entry-key="' + entryKey + '">' +
                    '<td class="scent-team-col">' + (i + 1) + '</td>' +
                    '<td class="scent-dog-handler-col" style="text-align: left;">' + 
                    '<strong>' + entry.regNumber + ' - ' + entry.callName + '</strong><br>' +
                    '<small>' + entry.handler + ' (' + entry.entryType.toUpperCase() + ')</small></td>';
                
                // Scent checkboxes
                for (var s = 1; s <= 4; s++) {
                    var checked = savedData['scent' + s] ? 'checked' : '';
                    html += '<td class="scent-scent-col">' +
                        '<input type="checkbox" class="scent-checkbox" ' + checked + ' ' +
                        'onchange="updateScentScore(\'' + entryKey + '\', \'scent' + s + '\', this.checked)">' +
                        '</td>';
                }
                
                html += '<td class="scent-fault-col">' +
                    '<input type="text" class="digital-fault-input" value="' + (savedData.faults || '') + '" ' +
                    'onchange="updateScentScore(\'' + entryKey + '\', \'faults\', this.value)" placeholder="Faults">' +
                    '</td>' +
                    '<td class="scent-time-col">' +
                    '<input type="text" class="digital-time-input" value="' + (savedData.time || '') + '" ' +
                    'onchange="updateScentScore(\'' + entryKey + '\', \'time\', this.value)" placeholder="mm:ss">' +
                    '</td>' +
                    '<td class="scent-pass-fail-col">' +
                    '<select class="digital-pass-fail-select" onchange="updateScentScore(\'' + entryKey + '\', \'result\', this.value)">' +
                    '<option value="">-</option>' +
                    '<option value="Pass"' + (savedData.result === 'Pass' ? ' selected' : '') + '>Pass</option>' +
                    '<option value="Fail"' + (savedData.result === 'Fail' ? ' selected' : '') + '>Fail</option>' +
                    '</select>' +
                    '</td>' +
                    '</tr>';
            }
            
            html += '</tbody></table></div>';
            
            // Load saved location data
            setTimeout(function() {
                loadSavedLocationData(sheetKey);
            }, 100);
            
            return html;
        }
        // Enhanced Preview and Digital Score Entry Functions - Part B
        // CONTINUE ADDING THESE TO YOUR JAVASCRIPT SECTION
        
        function updateScentScore(entryKey, field, value) {
            if (!digitalScoreData[entryKey]) {
                digitalScoreData[entryKey] = {};
            }
            digitalScoreData[entryKey][field] = value;
            
            // Update row styling based on completion
            var row = document.querySelector('[data-entry-key="' + entryKey + '"]');
            if (row) {
                var isCompleted = checkEntryCompletion(entryKey);
                if (isCompleted) {
                    row.classList.add('completed');
                } else {
                    row.classList.remove('completed');
                }
            }
            
            // Trigger auto-save
            if (document.getElementById('autoSaveEnabled') && document.getElementById('autoSaveEnabled').checked) {
                scheduleAutoSave();
            }
            
            updateCompletionProgress();
        }

        function checkEntryCompletion(entryKey) {
            function checkEntryCompletion(entryKey) {
            var data = digitalScoreData[entryKey];
            if (!data) return false;
            
            // Check if at least one scent is found and result is set
            var hasScent = data.scent1 || data.scent2 || data.scent3 || data.scent4;
            var hasResult = data.result && data.result !== '';
            
            return hasScent && hasResult;
        }

        function getCompletedScoresCount(sheetKey) {
            var count = 0;
            for (var entryKey in digitalScoreData) {
                if (entryKey.startsWith(sheetKey + '|')) {
                    if (checkEntryCompletion(entryKey)) {
                        count++;
                    }
                }
            }
            return count;
        }

        function updateCompletionProgress() {
            if (!currentDigitalSheet) return;
            
            var keyParts = currentDigitalSheet.split('|');
            var entries = getEntriesForClassRound(keyParts[0], keyParts[1], keyParts[2]);
            var completed = getCompletedScoresCount(currentDigitalSheet);
            var total = entries.length;
            
            if (total === 0) return;
            
            var percentage = Math.round((completed / total) * 100);
            
            var progressBar = document.getElementById('completionBar');
            var progressText = document.getElementById('completionText');
            
            if (progressBar) {
                progressBar.style.width = percentage + '%';
            }
            if (progressText) {
                progressText.textContent = percentage + '% Complete (' + completed + '/' + total + ' entries)';
            }
        }

        function scheduleAutoSave() {
            if (autoSaveTimer) {
                clearTimeout(autoSaveTimer);
            }
            
            showAutoSaveStatus('saving');
            
            autoSaveTimer = setTimeout(function() {
                saveScoreData();
                showAutoSaveStatus('saved');
                
                setTimeout(function() {
                    hideAutoSaveStatus();
                }, 2000);
            }, 1000);
        }

        function showAutoSaveStatus(status) {
            var statusDiv = document.getElementById('autoSaveStatus');
            statusDiv.style.display = 'block';
            statusDiv.className = 'auto-save-status ' + status;
            
            switch(status) {
                case 'saving':
                    statusDiv.textContent = 'ðŸ’¾ Saving...';
                    break;
                case 'saved':
                    statusDiv.textContent = 'âœ… Saved';
                    break;
                case 'error':
                    statusDiv.textContent = 'âŒ Save Error';
                    break;
            }
        }

        function hideAutoSaveStatus() {
            var statusDiv = document.getElementById('autoSaveStatus');
            statusDiv.style.display = 'none';
        }

        function toggleAutoSave() {
            var checkbox = document.getElementById('autoSaveEnabled');
            if (checkbox.checked) {
                showStatusMessage('Auto-save enabled', 'success');
            } else {
                showStatusMessage('Auto-save disabled', 'info');
            }
        }

        function saveCurrentSheet() {
            if (!currentDigitalSheet) {
                alert('No sheet selected');
                return;
            }
            
            saveScoreData();
            showStatusMessage('Score sheet saved successfully!', 'success');
            updateCompletionProgress();
            loadDigitalSheetSelector(); // Refresh the selector to show updated progress
        }

        function clearCurrentSheet() {
            if (!currentDigitalSheet) {
                alert('No sheet selected');
                return;
            }
            
            if (confirm('Are you sure you want to clear all scores for this sheet? This action cannot be undone.')) {
                // Clear all scores for current sheet
                for (var entryKey in digitalScoreData) {
                    if (entryKey.startsWith(currentDigitalSheet + '|')) {
                        delete digitalScoreData[entryKey];
                    }
                }
                
                // Clear location data
                var locationKeys = [currentDigitalSheet + '|scent1Location', 
                                  currentDigitalSheet + '|scent2Location',
                                  currentDigitalSheet + '|scent3Location', 
                                  currentDigitalSheet + '|scent4Location'];
                
                for (var i = 0; i < locationKeys.length; i++) {
                    delete digitalScoreData[locationKeys[i]];
                }
                
                saveScoreData();
                loadDigitalScoreSheet(currentDigitalSheet); // Reload the sheet
                updateCompletionProgress();
                loadDigitalSheetSelector(); // Refresh selector
                showStatusMessage('Score sheet cleared!', 'success');
            }
        }

        function exportCurrentSheet() {
            if (!currentDigitalSheet) {
                alert('No sheet selected');
                return;
            }
            
            var keyParts = currentDigitalSheet.split('|');
            var date = keyParts[0];
            var className = keyParts[1];
            var round = keyParts[2];
            var entries = getEntriesForClassRound(date, className, round);
            
            var csv = 'Team,Registration,Call Name,Handler,Entry Type,Scent 1,Scent 2,Scent 3,Scent 4,Faults,Time,Result\n';
            
            for (var i = 0; i < entries.length; i++) {
                var entry = entries[i];
                var entryKey = currentDigitalSheet + '|' + entry.regNumber + '|' + entry.entryType;
                var data = digitalScoreData[entryKey] || {};
                
                csv += (i + 1) + ',' + 
                       entry.regNumber + ',' + 
                       entry.callName + ',' + 
                       entry.handler + ',' + 
                       entry.entryType + ',' + 
                       (data.scent1 ? 'Found' : 'Not Found') + ',' + 
                       (data.scent2 ? 'Found' : 'Not Found') + ',' + 
                       (data.scent3 ? 'Found' : 'Not Found') + ',' + 
                       (data.scent4 ? 'Found' : 'Not Found') + ',' + 
                       (data.faults || '') + ',' + 
                       (data.time || '') + ',' + 
                       (data.result || '') + '\n';
            }
            
            var filename = 'scent_scores_' + className.replace(/\s+/g, '_') + '_round_' + round + '_' + date + '.csv';
            downloadFile(csv, filename, 'text/csv');
            showStatusMessage('Score sheet exported successfully!', 'success');
        }

        function printCurrentSheet() {
            if (!currentDigitalSheet) {
                alert('No sheet selected');
                return;
            }
            
            var sheetContent = document.getElementById('digitalScoreSheetContainer').innerHTML;
            var printWindow = window.open('', '_blank');
            printWindow.document.write('<html><head><title>Digital Score Sheet</title>');
            printWindow.document.write('<style>' + getDigitalScoreSheetStyles() + '</style>');
            printWindow.document.write('</head><body>' + sheetContent + '</body></html>');
            printWindow.document.close();
            printWindow.print();
        }

        function loadSavedLocationData(sheetKey) {
            var locationInputs = ['scent1Location', 'scent2Location', 'scent3Location', 'scent4Location'];
            
            for (var i = 0; i < locationInputs.length; i++) {
                var inputId = locationInputs[i];
                var dataKey = sheetKey + '|' + inputId;
                var input = document.getElementById(inputId);
                
                if (input && digitalScoreData[dataKey]) {
                    input.value = digitalScoreData[dataKey];
                }
            }
        }

        function saveScoreData() {
            // Save location data
            if (currentDigitalSheet) {
                var locationInputs = ['scent1Location', 'scent2Location', 'scent3Location', 'scent4Location'];
                
                for (var i = 0; i < locationInputs.length; i++) {
                    var inputId = locationInputs[i];
                    var input = document.getElementById(inputId);
                    var dataKey = currentDigitalSheet + '|' + inputId;
                    
                    if (input) {
                        digitalScoreData[dataKey] = input.value;
                    }
                }
            }
            
            // Save all digital score data to storage
            if (currentUser && currentTrialId) {
                var userTrials = JSON.parse(localStorage.getItem('trials_' + currentUser.username) || '{}');
                if (userTrials[currentTrialId]) {
                    userTrials[currentTrialId].digitalScoreData = digitalScoreData;
                    userTrials[currentTrialId].updated = new Date().toISOString();
                    localStorage.setItem('trials_' + currentUser.username, JSON.stringify(userTrials));
                }
                
                var publicTrials = JSON.parse(localStorage.getItem('publicTrials') || '{}');
                if (publicTrials[currentTrialId]) {
                    publicTrials[currentTrialId].digitalScoreData = digitalScoreData;
                    publicTrials[currentTrialId].updated = new Date().toISOString();
                    localStorage.setItem('publicTrials', JSON.stringify(publicTrials));
                }
            }
        }

        function exportAllScores() {
            if (Object.keys(digitalScoreData).length === 0) {
                alert('No scores to export');
                return;
            }

            var csv = 'Date,Class,Round,Judge,Team,Registration,Call Name,Handler,Entry Type,Scent 1,Scent 2,Scent 3,Scent 4,Faults,Time,Result\n';
            
            // Group scores by sheet
            var sheetGroups = {};
            for (var entryKey in digitalScoreData) {
                var keyParts = entryKey.split('|');
                if (keyParts.length >= 5) {
                    var sheetKey = keyParts[0] + '|' + keyParts[1] + '|' + keyParts[2];
                    if (!sheetGroups[sheetKey]) {
                        sheetGroups[sheetKey] = [];
                    }
                    sheetGroups[sheetKey].push(entryKey);
                }
            }
            
            for (var sheetKey in sheetGroups) {
                var keyParts = sheetKey.split('|');
                var date = keyParts[0];
                var className = keyParts[1];
                var round = keyParts[2];
                
                // Find config for judge info
                var config = null;
                for (var i = 0; i < trialConfig.length; i++) {
                    if (trialConfig[i].date === date && 
                        trialConfig[i].className === className && 
                        trialConfig[i].roundNum == round) {
                        config = trialConfig[i];
                        break;
                    }
                }
                
                var judge = config ? config.judge : 'Unknown';
                var entries = getEntriesForClassRound(date, className, round);
                
                for (var i = 0; i < entries.length; i++) {
                    var entry = entries[i];
                    var entryKey = sheetKey + '|' + entry.regNumber + '|' + entry.entryType;
                    var data = digitalScoreData[entryKey];
                    
                    if (data && Object.keys(data).length > 0) {
                        csv += date + ',' + 
                               className + ',' + 
                               round + ',' + 
                               judge + ',' + 
                               (i + 1) + ',' + 
                               entry.regNumber + ',' + 
                               entry.callName + ',' + 
                               entry.handler + ',' + 
                               entry.entryType + ',' + 
                               (data.scent1 ? 'Found' : 'Not Found') + ',' + 
                               (data.scent2 ? 'Found' : 'Not Found') + ',' + 
                               (data.scent3 ? 'Found' : 'Not Found') + ',' + 
                               (data.scent4 ? 'Found' : 'Not Found') + ',' + 
                               (data.faults || '') + ',' + 
                               (data.time || '') + ',' + 
                               (data.result || '') + '\n';
                    }
                }
            }

            downloadFile(csv, 'all_digital_scores.csv', 'text/csv');
            showStatusMessage('All digital scores exported successfully!', 'success');
        }

        function clearAllScores() {
            if (confirm('Are you sure you want to clear ALL digital scores? This action cannot be undone.')) {
                digitalScoreData = {};
                saveScoreData();
                
                if (currentDigitalSheet) {
                    loadDigitalScoreSheet(currentDigitalSheet);
                }
                updateCompletionProgress();
                loadDigitalSheetSelector();
                showStatusMessage('All digital scores cleared!', 'success');
            }
        }

        function getDigitalScoreSheetStyles() {
            return `
                .digital-score-sheet { background: white; margin: 20px 0; border: 2px solid #333; padding: 15px; font-family: 'Times New Roman', serif; }
                .digital-sheet-header { background: #f8f9fa; padding: 15px 20px; border-bottom: 2px solid #333; text-align: center; }
                .scent-sheet-title { font-size: 18px; font-weight: bold; margin-bottom: 10px; }
                .scent-sheet-info { display: flex; justify-content: space-between; margin-bottom: 15px; font-weight: bold; }
                .scent-locations { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin: 15px 0; border: 2px solid #000; padding: 10px; }
                .scent-location { text-align: center; border: 1px solid #000; padding: 8px; min-height: 40px; }
                .scent-faults-section { border: 1px solid #000; padding: 10px; margin: 15px 0; font-size: 11px; }
                .scent-score-table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 10px; }
                .scent-score-table th, .scent-score-table td { border: 1px solid #000; padding: 4px; text-align: center; }
                .scent-score-table th { background: #f0f0f0; font-weight: bold; }
                .digital-sheet-controls { display: none; }
                .digital-score-input, .digital-fault-input, .digital-time-input, .digital-pass-fail-select { border: none; background: transparent; font-weight: bold; }
            `;
        }

        // Load digital score data when editing existing trial
        function loadExistingDigitalScores() {
            if (currentUser && currentTrialId) {
                var userTrials = JSON.parse(localStorage.getItem('trials_' + currentUser.username) || '{}');
                if (userTrials[currentTrialId] && userTrials[currentTrialId].digitalScoreData) {
                    digitalScoreData = userTrials[currentTrialId].digitalScoreData;
                }
            }
        }

        // Score Sheets Functions - ADD THESE TO YOUR JAVASCRIPT SECTION (Part 8 or 9)
        
        var selectedSheetType = 'scent';
        
        function selectSheetType(type, element) {
            selectedSheetType = type;
            
            // Update visual selection
            var options = document.querySelectorAll('.sheet-type-option');
            for (var i = 0; i < options.length; i++) {
                options[i].classList.remove('selected');
            }
            element.classList.add('selected');
            
            // Show/hide scent options
            var scentOptions = document.getElementById('scentOptions');
            if (type === 'scent') {
                scentOptions.style.display = 'block';
            } else {
                scentOptions.style.display = 'none';
            }
        }

        function loadScoreSheetsManagement() {
            if (trialConfig.length === 0) {
                document.getElementById('dateSelectionContainer').innerHTML = 
                    '<p style="color: #666; padding: 20px;">No trial configuration found. Please complete trial setup first.</p>';
                return;
            }
            
            // Get unique dates from trial config
            var dates = [];
            var dateMap = {};
            
            for (var i = 0; i < trialConfig.length; i++) {
                var config = trialConfig[i];
                if (!dateMap[config.date]) {
                    dateMap[config.date] = {
                        date: config.date,
                        classes: [],
                        judges: []
                    };
                    dates.push(config.date);
                }
                
                if (dateMap[config.date].classes.indexOf(config.className) === -1) {
                    dateMap[config.date].classes.push(config.className);
                }
                if (dateMap[config.date].judges.indexOf(config.judge) === -1) {
                    dateMap[config.date].judges.push(config.judge);
                }
            }
            
            dates.sort();
            
            var html = '';
            for (var i = 0; i < dates.length; i++) {
                var date = dates[i];
                var dateInfo = dateMap[date];
                var formattedDate = new Date(date).toLocaleDateString();
                
                html += '<div class="date-checkbox">' +
                    '<input type="checkbox" id="date_' + date + '" value="' + date + '" onchange="updateSelectedDatesCount()">' +
                    '<div class="date-info">' +
                    '<div class="date-name">' + formattedDate + '</div>' +
                    '<div class="date-meta">' + dateInfo.classes.length + ' classes, ' + dateInfo.judges.length + ' judges</div>' +
                    '</div>' +
                    '</div>';
            }
            
            document.getElementById('dateSelectionContainer').innerHTML = html;
            updateSelectedDatesCount();
        }

        function updateSelectedDatesCount() {
            var checkboxes = document.querySelectorAll('#dateSelectionContainer input[type="checkbox"]:checked');
            document.getElementById('selectedDatesCount').textContent = checkboxes.length + ' dates selected';
        }

        function selectAllDates() {
            var checkboxes = document.querySelectorAll('#dateSelectionContainer input[type="checkbox"]');
            for (var i = 0; i < checkboxes.length; i++) {
                checkboxes[i].checked = true;
            }
            updateSelectedDatesCount();
        }

        function clearAllDates() {
            var checkboxes = document.querySelectorAll('#dateSelectionContainer input[type="checkbox"]');
            for (var i = 0; i < checkboxes.length; i++) {
                checkboxes[i].checked = false;
            }
            updateSelectedDatesCount();
        }

        function previewScoreSheets() {
            generateScoreSheets(true);
        }

        function printScoreSheets() {
            generateScoreSheets(false);
        }

        function generateScoreSheets(preview) {
            var selectedDates = [];
            var checkboxes = document.querySelectorAll('#dateSelectionContainer input[type="checkbox"]:checked');
            
            for (var i = 0; i < checkboxes.length; i++) {
                selectedDates.push(checkboxes[i].value);
            }
            
            if (selectedDates.length === 0) {
                alert('Please select at least one date');
                return;
            }
            
            var sheetsHTML = '';
            
            for (var d = 0; d < selectedDates.length; d++) {
                var date = selectedDates[d];
                
                // Get classes for this date
                var classesForDate = {};
                for (var i = 0; i < trialConfig.length; i++) {
                    var config = trialConfig[i];
                    if (config.date === date) {
                        var key = config.className + '_' + config.roundNum;
                        if (!classesForDate[key]) {
                            classesForDate[key] = config;
                        }
                    }
                }
                
                // Generate sheet for each class/round combination
                for (var classKey in classesForDate) {
                    var config = classesForDate[classKey];
                    var entriesForClass = getEntriesForClassRound(config.date, config.className, config.roundNum);
                    
                    if (selectedSheetType === 'scent') {
                        sheetsHTML += generateScentDetectiveSheet(config, entriesForClass);
                    } else {
                        sheetsHTML += generateStandardSheet(config, entriesForClass);
                    }
                }
            }
            
            if (preview) {
                document.getElementById('previewContent').innerHTML = sheetsHTML;
                document.getElementById('previewModal').style.display = 'flex';
            } else {
                var printWindow = window.open('', '_blank');
                printWindow.document.write('<html><head><title>Score Sheets</title>');
                printWindow.document.write('<style>' + getScentScoreSheetStyles() + '</style>');
                printWindow.document.write('</head><body>' + sheetsHTML + '</body></html>');
                printWindow.document.close();
                printWindow.print();
            }
        }

        function generateScentDetectiveSheet(config, entries) {
            var round = document.getElementById('scentRoundSelect') ? document.getElementById('scentRoundSelect').value : '1';
            var formattedDate = new Date(config.date).toLocaleDateString();
            
            var html = '<div class="scent-score-sheet">' +
                '<div class="scent-sheet-header">' +
                '<div class="scent-sheet-title">Scent Detective Master Score Sheet</div>' +
                '</div>' +
                
                '<div class="scent-sheet-info">' +
                '<div>Date: <u>' + formattedDate + '</u></div>' +
                '<div>CLASS: <u>' + config.className + '</u></div>' +
                '</div>' +
                
                '<div class="scent-round-boxes">' +
                '<span style="margin-right: 20px;">Round</span>';
            
            for (var i = 1; i <= 4; i++) {
                var isSelected = (i == round);
                html += '<span class="scent-round-box' + (isSelected ? ' selected' : '') + '">' + 
                        (isSelected ? 'X' : i) + '</span>';
            }
            html += '</div>';
            
            html += '<div class="scent-locations">' +
                '<div class="scent-location"><strong>Scent 1</strong><br>Located in/on:<br>_______________</div>' +
                '<div class="scent-location"><strong>Scent 2</strong><br>Located in/on:<br>_______________</div>' +
                '<div class="scent-location"><strong>Scent 3</strong><br>Located in/on:<br>_______________</div>' +
                '<div class="scent-location"><strong>Scent 4</strong><br>Located in/on:<br>_______________</div>' +
                '</div>';
            
            html += '<div class="scent-faults-section">' +
                '<strong>Faults:</strong> Dropped Food; Dog stops working; Handler guiding dog; ' +
                'Incorrect find; Destructive behavior; Disturbing search area by dog or handler; ' +
                'Verbally naming item; Continue search after "alert"; SR crossing line less than half.' +
                '</div>';
            
            html += '<table class="scent-score-table">' +
                '<thead>' +
                '<tr>' +
                '<th class="scent-team-col">Team</th>' +
                '<th class="scent-dog-handler-col">Dog -- Handler</th>' +
                '<th class="scent-scent-col">Scent 1</th>' +
                '<th class="scent-scent-col">Scent 2</th>' +
                '<th class="scent-scent-col">Scent 3</th>' +
                '<th class="scent-scent-col">Scent 4</th>' +
                '<th class="scent-fault-col">Fault</th>' +
                '<th class="scent-fault-col">Fault</th>' +
                '<th class="scent-time-col">Time</th>' +
                '<th class="scent-pass-fail-col">Pass/Fail</th>' +
                '</tr>' +
                '</thead>' +
                '<tbody>';
            
            // Add entries
            for (var i = 0; i < entries.length && i < 8; i++) {
                var entry = entries[i];
                html += '<tr>' +
                    '<td class="scent-team-col">' + (i + 1) + '</td>' +
                    '<td class="scent-dog-handler-col" style="text-align: left;">' + 
                    '<strong>' + entry.regNumber + ' - ' + entry.callName + '</strong><br>' +
                    entry.handler + '</td>' +
                    '<td class="scent-scent-col">Scent 1</td>' +
                    '<td class="scent-scent-col">Scent 2</td>' +
                    '<td class="scent-scent-col">Scent 3</td>' +
                    '<td class="scent-scent-col">Scent 4</td>' +
                    '<td class="scent-fault-col">&nbsp;</td>' +
                    '<td class="scent-fault-col">&nbsp;</td>' +
                    '<td class="scent-time-col">&nbsp;</td>' +
                    '<td class="scent-pass-fail-col">&nbsp;</td>' +
                    '</tr>';
            }
            
            // Add empty rows if needed
            for (var i = entries.length; i < 8; i++) {
                html += '<tr>' +
                    '<td class="scent-team-col">&nbsp;</td>' +
                    '<td class="scent-dog-handler-col">&nbsp;</td>' +
                    '<td class="scent-scent-col">Scent 1</td>' +
                    '<td class="scent-scent-col">Scent 2</td>' +
                    '<td class="scent-scent-col">Scent 3</td>' +
                    '<td class="scent-scent-col">Scent 4</td>' +
                    '<td class="scent-fault-col">&nbsp;</td>' +
                    '<td class="scent-fault-col">&nbsp;</td>' +
                    '<td class="scent-time-col">&nbsp;</td>' +
                    '<td class="scent-pass-fail-col">&nbsp;</td>' +
                    '</tr>';
            }
            
            html += '</tbody></table></div>';
            return html;
        }

        function generateStandardSheet(config, entries) {
            // Standard score sheet format (simplified)
            var formattedDate = new Date(config.date).toLocaleDateString();
            
            var html = '<div class="score-sheet">' +
                '<div class="score-sheet-header">' +
                '<div class="trial-info">' +
                '<div class="info-block">' +
                '<div class="info-label">Date</div>' +
                '<div class="info-value">' + formattedDate + '</div>' +
                '</div>' +
                '<div class="info-block">' +
                '<div class="info-label">Class</div>' +
                '<div class="info-value">' + config.className + '</div>' +
                '</div>' +
                '<div class="info-block">' +
                '<div class="info-label">Judge</div>' +
                '<div class="info-value">' + config.judge + '</div>' +
                '</div>' +
                '</div>' +
                '</div>' +
                
                '<table class="running-order-table">' +
                '<thead>' +
                '<tr>' +
                '<th class="position-col">Position</th>' +
                '<th class="reg-col">Registration</th>' +
                '<th class="name-col">Call Name</th>' +
                '<th class="handler-col">Handler</th>' +
                '<th class="score-col">Score</th>' +
                '<th class="placement-col">Placement</th>' +
                '</tr>' +
                '</thead>' +
                '<tbody>';
            
            for (var i = 0; i < entries.length; i++) {
                var entry = entries[i];
                html += '<tr>' +
                    '<td class="position-col">' + (i + 1) + '</td>' +
                    '<td class="reg-col">' + entry.regNumber + '</td>' +
                    '<td class="name-col">' + entry.callName + '</td>' +
                    '<td class="handler-col">' + entry.handler + '</td>' +
                    '<td class="score-col">&nbsp;</td>' +
                    '<td class="placement-col">&nbsp;</td>' +
                    '</tr>';
            }
            
            html += '</tbody></table></div>';
            return html;
        }

        function getScentScoreSheetStyles() {
            return `
                .scent-score-sheet { background: white; margin: 20px 0; page-break-after: always; border: 2px solid #000; padding: 15px; font-family: 'Times New Roman', serif; }
                .scent-sheet-header { text-align: center; margin-bottom: 20px; }
                .scent-sheet-title { font-size: 18px; font-weight: bold; margin-bottom: 10px; }
                .scent-sheet-info { display: flex; justify-content: space-between; margin-bottom: 15px; font-weight: bold; }
                .scent-round-boxes { text-align: center; margin: 15px 0; }
                .scent-round-box { display: inline-block; width: 30px; height: 30px; border: 2px solid #000; margin: 0 10px; line-height: 26px; font-weight: bold; font-size: 16px; }
                .scent-round-box.selected { background: #000; color: white; }
                .scent-locations { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin: 15px 0; border: 2px solid #000; padding: 10px; }
                .scent-location { text-align: center; border: 1px solid #000; padding: 8px; min-height: 40px; }
                .scent-faults-section { border: 1px solid #000; padding: 10px; margin: 15px 0; font-size: 11px; }
                .scent-score-table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 10px; }
                .scent-score-table th, .scent-score-table td { border: 1px solid #000; padding: 4px; text-align: center; }
                .scent-score-table th { background: #f0f0f0; font-weight: bold; }
                .scent-team-col { width: 60px; } .scent-dog-handler-col { width: 120px; text-align: left; }
                .scent-scent-col { width: 50px; } .scent-fault-col { width: 80px; }
                .scent-time-col { width: 60px; } .scent-pass-fail-col { width: 60px; }
            `;
        }
        function saveTrialDay(dayNum) {
            var date = document.getElementById('date_' + dayNum).value;
            if (!date) {
                alert('Please set the date for Day ' + dayNum);
                return;
            }

            var numClasses = parseInt(document.getElementById('classes_' + dayNum).value);
            if (!numClasses) {
                alert('Please set the number of classes for Day ' + dayNum);
                return;
            }

            trialConfig = trialConfig.filter(function(config) {
                return config.day !== dayNum;
            });

            for (var classNum = 1; classNum <= numClasses; classNum++) {
                var className = document.getElementById('class_' + dayNum + '_' + classNum).value.trim();
                if (!className) {
                    alert('Please enter a class name for Day ' + dayNum + ', Class ' + classNum);
                    return;
                }

                var numRounds = parseInt(document.getElementById('rounds_' + dayNum + '_' + classNum).value);
                if (!numRounds) {
                    alert('Please set the number of rounds for Day ' + dayNum + ', Class ' + classNum);
                    return;
                }

                for (var roundNum = 1; roundNum <= numRounds; roundNum++) {
                    var judge = document.getElementById('judge_' + dayNum + '_' + classNum + '_' + roundNum).value.trim();
                    if (!judge) {
                        alert('Please enter a judge name for Day ' + dayNum + ', Class ' + classNum + ', Round ' + roundNum);
                        return;
                    }

                    var feoOffered = document.getElementById('feo_' + dayNum + '_' + classNum + '_' + roundNum).checked;

                    trialConfig.push({
                        day: dayNum,
                        date: date,
                        classNum: classNum,
                        className: className,
                        roundNum: roundNum,
                        judge: judge,
                        feoOffered: feoOffered
                    });
                }
            }

            savedDays++;
            updateTrialOptions();
            showStatusMessage('Day ' + dayNum + ' configuration saved!', 'success');

            // Check if all days are saved and show save trial button
            if (savedDays === totalDays) {
                document.getElementById('saveTrialSection').style.display = 'block';
                showStatusMessage('All days configured! Please review and save your trial.', 'info');
            }
        }

        function updateTrialOptions() {
            var container = document.getElementById('trialOptions');
            
            if (trialConfig.length === 0) {
                container.innerHTML = '<p style="color: #666; font-style: italic;">Please complete trial setup first.</p>';
                return;
            }
            
            var groupedByDay = {};
            for (var i = 0; i < trialConfig.length; i++) {
                var config = trialConfig[i];
                if (!groupedByDay[config.day]) {
                    groupedByDay[config.day] = {};
                }
                if (!groupedByDay[config.day][config.className]) {
                    groupedByDay[config.day][config.className] = [];
                }
                groupedByDay[config.day][config.className].push(config);
            }

            for (var day in groupedByDay) {
                for (var className in groupedByDay[day]) {
                    groupedByDay[day][className].sort(function(a, b) {
                        return a.roundNum - b.roundNum;
                    });
                }
            }

            var html = '';
            var sortedDays = Object.keys(groupedByDay).sort(function(a, b) {
                return parseInt(a) - parseInt(b);
            });
            
            for (var d = 0; d < sortedDays.length; d++) {
                var day = sortedDays[d];
                var firstClass = Object.keys(groupedByDay[day])[0];
                var firstConfig = groupedByDay[day][firstClass][0];
                
                html += '<div class="day-group">';
                html += '<div class="day-group-header">Day ' + day + ' - ' + firstConfig.date + '</div>';
                
                var sortedClasses = Object.keys(groupedByDay[day]).sort();
                
                for (var c = 0; c < sortedClasses.length; c++) {
                    var className = sortedClasses[c];
                    html += '<div class="class-group">';
                    html += '<div class="class-group-header">' + className + '</div>';
                    
                    var configs = groupedByDay[day][className];
                    for (var i = 0; i < configs.length; i++) {
                        var config = configs[i];
                        var configIndex = -1;
                        for (var j = 0; j < trialConfig.length; j++) {
                            if (trialConfig[j].day === config.day && 
                                trialConfig[j].classNum === config.classNum && 
                                trialConfig[j].roundNum === config.roundNum) {
                                configIndex = j;
                                break;
                            }
                        }
                        
                        html += '<div class="trial-option">' +
                            '<div style="font-weight: bold; margin-bottom: 8px;">' +
                            'Round ' + config.roundNum + ' - ' + config.judge +
                            '</div>' +
                            '<div style="margin-bottom: 10px;">' +
                            '<label style="margin-right: 15px;">' +
                            '<input type="checkbox" name="trialSelection" value="' + configIndex + '-regular"> Regular Entry' +
                            '</label>';
                        
                        if (config.feoOffered) {
                            html += '<label>' +
                                '<input type="checkbox" name="trialSelection" value="' + configIndex + '-feo"> FEO Entry' +
                                '</label>';
                        }
                        
                        html += '</div></div>';
                    }
                    html += '</div>';
                }
                html += '</div>';
            }
            container.innerHTML = html;
        }

        // Entry form functions
        function handleRegNumberTypeahead(input) {
            var query = input.value.toLowerCase();
            var dropdown = document.getElementById('regNumberDropdown');
            
            if (query.length === 0) {
                dropdown.style.display = 'none';
                document.getElementById('callName').textContent = 'Call Name will appear here';
                document.getElementById('callName').style.color = '#666';
                return;
            }

            var matches = [];
            for (var i = 0; i < dogData.length; i++) {
                var dog = dogData[i];
                if (dog.regNumber.toLowerCase().indexOf(query) !== -1 || 
                    dog.callName.toLowerCase().indexOf(query) !== -1) {
                    matches.push(dog);
                }
            }

            if (matches.length > 0) {
                var html = '';
                for (var i = 0; i < matches.length; i++) {
                    var dog = matches[i];
                    html += '<div class="typeahead-item" onclick="selectRegNumber(\'' + dog.regNumber + '\', \'' + dog.callName + '\')">' + dog.regNumber + ' - ' + dog.callName + '</div>';
                }
                dropdown.innerHTML = html;
                dropdown.style.display = 'block';

                for (var i = 0; i < matches.length; i++) {
                    if (matches[i].regNumber.toLowerCase() === query) {
                        document.getElementById('callName').textContent = matches[i].callName;
                        document.getElementById('callName').style.color = '#28a745';
                        break;
                    }
                }
            } else {
                dropdown.style.display = 'none';
                document.getElementById('callName').textContent = 'Not found';
                document.getElementById('callName').style.color = '#dc3545';
            }
        }

        function selectRegNumber(regNumber, callName) {
            document.getElementById('regNumber').value = regNumber;
            document.getElementById('callName').textContent = callName;
            document.getElementById('callName').style.color = '#28a745';
            document.getElementById('regNumberDropdown').style.display = 'none';
        }

        function hideRegNumberDropdown() {
            setTimeout(function() {
                document.getElementById('regNumberDropdown').style.display = 'none';
            }, 200);
        }

        function showRegNumberDropdown() {
            var input = document.getElementById('regNumber');
            if (input.value.length > 0) {
                handleRegNumberTypeahead(input);
            }
        }

        function submitEntry() {
            var regNumber = document.getElementById('regNumber').value.trim();
            var handlerName = document.getElementById('handlerName').value.trim();
            var selectedTrials = document.querySelectorAll('input[name="trialSelection"]:checked');

            if (!regNumber) {
                alert('Please enter a registration number');
                return;
            }

            if (!handlerName) {
                alert('Please enter handler name');
                return;
            }

            if (selectedTrials.length === 0) {
                alert('Please select at least one trial');
                return;
            }

            var dog = null;
            for (var i = 0; i < dogData.length; i++) {
                if (dogData[i].regNumber === regNumber) {
                    dog = dogData[i];
                    break;
                }
            }
            var callName = dog ? dog.callName : 'Unknown';

            for (var i = 0; i < selectedTrials.length; i++) {
                var selectionValue = selectedTrials[i].value;
                var parts = selectionValue.split('-');
                var configIndex = parseInt(parts[0]);
                var entryType = parts[1];
                var config = trialConfig[configIndex];

                var entry = {
                    regNumber: regNumber,
                    callName: callName,
                    handler: handlerName,
                    day: config.day,
                    date: config.date,
                    className: config.className,
                    round: config.roundNum,
                    judge: config.judge,
                    entryType: entryType,
                    timestamp: new Date().toISOString()
                };

                entryResults.push(entry);
            }

            // Save entries back to trial data immediately
            saveEntriesToTrial();
            updateResultsDisplay();
            updateCrossReferenceDisplay();
            
            document.getElementById('regNumber').value = '';
            document.getElementById('handlerName').value = '';
            document.getElementById('callName').textContent = 'Call Name will appear here';
            document.getElementById('callName').style.color = '#666';
            clearSelections();

            showStatusMessage('Entry(s) submitted successfully! (' + selectedTrials.length + ' trial(s))', 'success');
        }

        function saveEntriesToTrial() {
            if (!currentTrialId) return;
            
            // Save to user's trials if logged in
            if (currentUser) {
                var userTrials = JSON.parse(localStorage.getItem('trials_' + currentUser.username) || '{}');
                if (userTrials[currentTrialId]) {
                    userTrials[currentTrialId].results = entryResults;
                    userTrials[currentTrialId].updated = new Date().toISOString();
                    localStorage.setItem('trials_' + currentUser.username, JSON.stringify(userTrials));
                }
            }
            
            // Always save to public trials for entry form access
            var publicTrials = JSON.parse(localStorage.getItem('publicTrials') || '{}');
            if (publicTrials[currentTrialId]) {
                publicTrials[currentTrialId].results = entryResults;
                publicTrials[currentTrialId].updated = new Date().toISOString();
                localStorage.setItem('publicTrials', JSON.stringify(publicTrials));
            }
        }

        function clearSelections() {
            var checkboxes = document.querySelectorAll('input[name="trialSelection"]');
            for (var i = 0; i < checkboxes.length; i++) {
                checkboxes[i].checked = false;
            }
        }
        // URL Generation and sharing functions
        function generateShareableURL() {
            if (!currentTrialId) return;
            
            var baseURL = window.location.origin + window.location.pathname;
            var shareableURL = baseURL + '?trial=' + currentTrialId + '&mode=entry';
            
            var urlInput = document.getElementById('shareableURL');
            if (urlInput) {
                urlInput.value = shareableURL;
            }
        }

        function copyURL() {
            var urlInput = document.getElementById('shareableURL');
            urlInput.select();
            urlInput.setSelectionRange(0, 99999);
            
            try {
                document.execCommand('copy');
                showStatusMessage('URL copied to clipboard!', 'success');
            } catch (err) {
                showStatusMessage('Could not copy URL. Please copy manually.', 'warning');
            }
        }

        function openEntryForm() {
            var urlInput = document.getElementById('shareableURL');
            if (urlInput.value) {
                window.open(urlInput.value, '_blank');
            }
        }

        // Handle URL parameters for direct entry form access
        function handleURLParameters() {
            var urlParams = new URLSearchParams(window.location.search);
            var trialId = urlParams.get('trial');
            var mode = urlParams.get('mode');
            
            if (trialId && mode === 'entry') {
                loadTrialForEntry(trialId);
                return true;
            }
            return false;
        }

        function loadTrialForEntry(trialId) {
            var publicTrials = JSON.parse(localStorage.getItem('publicTrials') || '{}');
            var trial = publicTrials[trialId];
            
            if (!trial) {
                alert('Trial not found or no longer available');
                return;
            }
            
            currentTrialId = trialId;
            trialConfig = trial.config || [];
            entryResults = trial.results || [];
            runningOrders = trial.runningOrders || {};
            digitalScores = trial.digitalScores || {};
            
            document.getElementById('authOverlay').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            document.getElementById('userInfo').textContent = 'Entry Form: ' + (trial.name || 'Trial');
            
            document.querySelector('.my-trials').style.display = 'none';
            document.querySelector('.logout-btn').style.display = 'none';
            
            updateTrialOptions();
            showTab('entry', document.querySelectorAll('.nav-tab')[1]);
            
            // Hide other tabs for public entry form
            var tabs = document.querySelectorAll('.nav-tab');
            for (var i = 0; i < tabs.length; i++) {
                if (i !== 1) { // Keep only entry tab visible
                    tabs[i].style.display = 'none';
                }
            }
        }

        // Results functions
        function updateResultsDisplay() {
            var container = document.getElementById('resultsContainer');
            
            if (entryResults.length === 0) {
                container.innerHTML = '<p style="color: #666; font-style: italic;">No entries yet.</p>';
                return;
            }

            var groupedResults = {};
            for (var i = 0; i < entryResults.length; i++) {
                var entry = entryResults[i];
                var key = entry.date + '-' + entry.className + '-' + entry.round;
                if (!groupedResults[key]) {
                    groupedResults[key] = {
                        date: entry.date,
                        className: entry.className,
                        round: entry.round,
                        judge: entry.judge,
                        entries: []
                    };
                }
                groupedResults[key].entries.push(entry);
            }

            var html = '<div class="results-grid">';
            
            var sortedGroups = [];
            for (var key in groupedResults) {
                sortedGroups.push(groupedResults[key]);
            }
            
            sortedGroups.sort(function(a, b) {
                if (a.date !== b.date) return new Date(a.date) - new Date(b.date);
                if (a.className !== b.className) return a.className.localeCompare(b.className);
                return a.round - b.round;
            });

            for (var g = 0; g < sortedGroups.length; g++) {
                var group = sortedGroups[g];
                html += '<div class="result-column">' +
                    '<div class="column-header">' +
                    '<div class="column-date">' + group.date + '</div>' +
                    '<div class="column-judge">' + group.judge + '</div>' +
                    '<div class="column-class-round">' + group.className + ' - Round ' + group.round + '</div>' +
                    '</div>' +
                    '<div class="column-entries">';

                group.entries.sort(function(a, b) {
                    return a.handler.localeCompare(b.handler);
                });

                for (var e = 0; e < group.entries.length; e++) {
                    var entry = group.entries[e];
                    html += '<div class="entry-item">' +
                        entry.handler + ' - ' + entry.callName +
                        '<span class="entry-type-badge badge-' + entry.entryType + '">' + entry.entryType.toUpperCase() + '</span>' +
                        '</div>';
                }

                html += '</div></div>';
            }

            html += '</div>';
            container.innerHTML = html;
        }

        // Cross-Reference functions (simplified)
        function loadCrossReferenceTab() {
            if (trialConfig.length === 0) {
                document.getElementById('crossReferenceGrid').innerHTML = 
                    '<p style="text-align: center; color: #666; padding: 40px;">No trial data available. Please complete trial setup first.</p>';
                return;
            }
            updateCrossReferenceDisplay();
        }

        function updateCrossReferenceDisplay() {
            // Simplified cross-reference display
            var container = document.getElementById('crossReferenceGrid');
            container.innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">Cross-reference grid will display trial entries and conflicts here.</p>';
        }

        function applyFilters() { updateCrossReferenceDisplay(); }
        function clearFilters() { updateCrossReferenceDisplay(); }
        function refreshCrossReference() { showStatusMessage('Cross-reference refreshed!', 'success'); }
        function exportCrossReference() { showStatusMessage('Cross-reference exported!', 'success'); }

        // Export functions
        function exportToCSV() {
            if (entryResults.length === 0) {
                alert('No data to export');
                return;
            }

            var csv = 'Registration,Call Name,Handler,Date,Class,Round,Judge,Entry Type,Timestamp\n';
            
            for (var i = 0; i < entryResults.length; i++) {
                var entry = entryResults[i];
                csv += entry.regNumber + ',' + entry.callName + ',' + entry.handler + ',' + entry.date + ',' + entry.className + ',' + entry.round + ',' + entry.judge + ',' + entry.entryType + ',' + entry.timestamp + '\n';
            }

            downloadFile(csv, 'trial_entries.csv', 'text/csv');
            showStatusMessage('CSV exported successfully!', 'success');
        }

        function exportAllScores() {
            showStatusMessage('Score export feature - implementation in progress', 'info');
        }

        function clearAllScores() {
            if (confirm('Are you sure you want to clear ALL scores?')) {
                digitalScores = {};
                showStatusMessage('All scores cleared!', 'success');
            }
        }

        // Placeholder functions for features
        function loadScoreSheetsManagement() {
            var container = document.getElementById('dateSelectionContainer');
            container.innerHTML = '<p style="color: #666; padding: 20px;">Score Sheets Management - Implementation in progress</p>';
        }

        function loadDigitalScoreEntry() {
            var container = document.getElementById('classRoundSelector');
            container.innerHTML = '<p style="color: #666; padding: 20px;">Digital Score Entry - Implementation in progress</p>';
        }

        function selectAllDates() { showStatusMessage('Select All Dates - Implementation in progress', 'info'); }
        function clearAllDates() { showStatusMessage('Clear All Dates - Implementation in progress', 'info'); }
        function previewScoreSheets() { showStatusMessage('Preview Score Sheets - Implementation in progress', 'info'); }
        function printScoreSheets() { showStatusMessage('Print Score Sheets - Implementation in progress', 'info'); }
        function closePreview() { document.getElementById('previewModal').style.display = 'none'; }
        function printFromPreview() { window.print(); }

        // Helper functions
        function downloadFile(content, filename, contentType) {
            var blob = new Blob([content], { type: contentType });
            var url = URL.createObjectURL(blob);
            var a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }

        function showStatusMessage(message, type) {
            var statusDiv = document.createElement('div');
            statusDiv.className = 'alert alert-' + type;
            statusDiv.textContent = message;
            statusDiv.style.position = 'fixed';
            statusDiv.style.top = '20px';
            statusDiv.style.right = '20px';
            statusDiv.style.zIndex = '10000';
            statusDiv.style.maxWidth = '300px';
            
            document.body.appendChild(statusDiv);
            
            setTimeout(function() {
                if (statusDiv.parentNode) {
                    document.body.removeChild(statusDiv);
                }
            }, 3000);
        }

        // Initialize the application
        window.onload = function() {
            console.log('Initializing Enhanced Trial Management System...');
            
            if (handleURLParameters()) {
                loadDogData();
                return;
            }
            
            loadDogData();
initializeDigitalScoring();
console.log('Application ready with all functionality');

            
            // Check if there are any stored users for testing
            var users = JSON.parse(localStorage.getItem('trialUsers') || '{}');
            if (Object.keys(users).length === 0) {
                console.log('No users found. You can register a new account.');
            } else {
                console.log('Found existing users:', Object.keys(users));
            }
            // Digital Scoring Initialization
function initializeDigitalScoring() {
    digitalScoreData = {};
    setInterval(function() {
        if (Object.keys(digitalScoreData).length > 0) {
            saveScoreData();
        }
    }, 30000);
    console.log('Digital scoring system initialized');
}
function debugRegistration() {
    console.log('=== REGISTRATION DEBUG ===');
    
    // Check if form exists
    var form = document.getElementById('registerForm');
    console.log('Register form exists:', !!form);
    
    // Check if all input fields exist
    var fields = ['regUsername', 'regPassword', 'regConfirmPassword', 'regFullName', 'regEmail'];
    for (var i = 0; i < fields.length; i++) {
        var field = document.getElementById(fields[i]);
        console.log(fields[i] + ' exists:', !!field);
        if (field) {
            console.log(fields[i] + ' value:', field.value);
        }
    }
    
    // Check if handleRegister function exists
    console.log('handleRegister function exists:', typeof handleRegister);
    
    // Check localStorage
    var users = JSON.parse(localStorage.getItem('trialUsers') || '{}');
    console.log('Current users in storage:', Object.keys(users));
    
    // Test registration manually
    console.log('Attempting manual registration...');
    try {
        // Fill test data
        document.getElementById('regUsername').value = 'testuser123';
        document.getElementById('regPassword').value = 'testpass123';
        document.getElementById('regConfirmPassword').value = 'testpass123';
        document.getElementById('regFullName').value = 'Test User';
        document.getElementById('regEmail').value = 'test@example.com';
        
        // Create fake event
        var fakeEvent = { preventDefault: function() { console.log('preventDefault called'); } };
        
        // Call registration function
        handleRegister(fakeEvent);
        
        console.log('Registration function completed');
    } catch (error) {
        console.error('Registration error:', error);
    }
}
function loadExistingDigitalScores() {
    if (currentUser && currentTrialId) {
        var userTrials = JSON.parse(localStorage.getItem('trials_' + currentUser.username) || '{}');
        if (userTrials[currentTrialId] && userTrials[currentTrialId].digitalScoreData) {
            digitalScoreData = userTrials[currentTrialId].digitalScoreData;
        }
    }
}
        };
            
    </script>
</html>
