<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dog Scent Work Trial Secretary System</title>
    
    <!-- External Dependencies -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- CSS Files -->
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/forms.css">
    <link rel="stylesheet" href="css/tables.css">
    <link rel="stylesheet" href="css/print.css">
</head>
<body>
    <!-- Authentication Overlay -->
    <div id="authOverlay" class="auth-overlay">
        <div class="auth-modal">
            <h2>🐕 Trial Secretary System</h2>
            
            <div class="auth-tabs">
                <button class="auth-tab active" onclick="showAuthTab('login', this)">Login</button>
                <button class="auth-tab" onclick="showAuthTab('register', this)">Register</button>
            </div>

            <!-- Login Form -->
            <form id="loginForm" class="auth-form active" onsubmit="handleLogin(event)">
                <input type="text" id="loginUsername" class="auth-input" placeholder="Username" required>
                <input type="password" id="loginPassword" class="auth-input" placeholder="Password" required>
                <button type="submit" class="auth-button">Login</button>
            </form>

            <!-- Register Form -->
            <form id="registerForm" class="auth-form" onsubmit="handleRegister(event)">
                <input type="text" id="regUsername" class="auth-input" placeholder="Choose Username" required>
                <input type="password" id="regPassword" class="auth-input" placeholder="Choose Password" required>
                <input type="password" id="regConfirmPassword" class="auth-input" placeholder="Confirm Password" required>
                <input type="text" id="regFullName" class="auth-input" placeholder="Full Name" required>
                <input type="email" id="regEmail" class="auth-input" placeholder="Email Address" required>
                <button type="submit" class="auth-button">Register</button>
            </form>
        </div>
    </div>

    <!-- Main Application -->
    <div id="mainApp" class="main-app">
        <!-- User Bar -->
        <div class="user-bar no-print">
            <div class="user-info" id="userInfo">Welcome to Trial Management</div>
            <div class="user-actions">
                <button class="my-trials-btn" onclick="showMyTrials()">My Trials</button>
                <button class="logout-btn" onclick="logout()">Logout</button>
            </div>
        </div>

        <div class="container">
            <div class="header no-print">
                <h1>🐕 Dog Scent Work Trial Secretary System</h1>
                <p>Complete trial management from setup to score sheets</p>
            </div>

            <!-- Status indicator for background data loading -->
            <div id="dataLoadStatus" class="data-load-status" style="display: none;">
                <span class="status-icon">⏳</span>
                <span class="status-text">Loading registration data...</span>
            </div>

            <!-- My Trials Section -->
            <div class="my-trials no-print">
                <div class="trials-header">
                    <h3>📋 My Trials</h3>
                    <button class="btn btn-primary" onclick="createNewTrial()">➕ Create New Trial</button>
                </div>
                <div id="myTrialsList">
                    <p style="color: #666; font-style: italic;">No trials yet. Create your first trial!</p>
                </div>
            </div>

            <!-- Navigation Tabs -->
            <div class="nav-tabs no-print">
                <button class="nav-tab active" onclick="showTab('setup', this)">🔧 Trial Setup</button>
                <button class="nav-tab" onclick="showTab('entry', this)">📝 Entry Form</button>
                <button class="nav-tab" onclick="showTab('results', this)">📋 Results</button>
                <button class="nav-tab" onclick="showTab('cross-reference', this)">🔍 Cross Reference</button>
                <button class="nav-tab" onclick="showTab('running-order', this)">🏃 Running Order</button>
                <button class="nav-tab" onclick="showTab('score-sheets', this)">📄 Score Sheets</button>
                <button class="nav-tab" onclick="showTab('score-entry', this)">💻 Digital Scoring</button>
                <button class="nav-tab" onclick="showTab('reports', this)">📊 Reports</button>
            </div>

            <!-- Trial Setup Tab -->
            <div id="setup" class="tab-content active">
                <div class="form-section">
                    <h3 class="section-title" id="trialTitle">New Trial Setup</h3>
                    
                    <div class="form-group">
                        <label class="label">Trial Name:</label>
                        <input type="text" id="trialName" placeholder="Enter trial name" style="width: 300px;">
                    </div>
                    
                    <div class="form-group">
                        <label class="label">Number of Days:</label>
                        <input type="number" id="trialDays" min="1" max="30" placeholder="Enter number">
                        <button type="button" class="btn btn-primary" onclick="generateDays()">Generate Days</button>
                    </div>
                </div>

                <div id="daysContainer"></div>
                
                <!-- Save Trial Section -->
                <div id="saveTrialSection" style="display: none;" class="form-section">
                    <h3 class="section-title">✅ Ready to Save Your Trial?</h3>
                    <p>All days have been configured. Review your trial setup and save to generate the entry form link.</p>
                    
                    <div class="form-group">
                        <button type="button" class="btn btn-success" onclick="saveTrialData()">💾 Save Trial & Generate Entry Link</button>
                        <button type="button" class="btn btn-warning" onclick="exportTrialConfig()">📤 Export Config</button>
                        <input type="file" id="importTrialConfig" accept=".json" onchange="importTrialConfig(this)" style="display: none;">
                        <button type="button" class="btn btn-secondary" onclick="document.getElementById('importTrialConfig').click()">📥 Import Config</button>
                    </div>
                </div>

                <!-- Entry Form Link Section -->
                <div id="entryFormLink" style="display: none;" class="form-section">
                    <h3 class="section-title">🎉 Trial Setup Complete!</h3>
                    <p><strong>Share this URL for participants to register:</strong></p>
                    <div class="form-group">
                        <input type="text" id="shareableURL" readonly class="shareable-url">
                    </div>
                    <div class="form-group">
                        <button class="btn btn-primary" onclick="copyURL()">📋 Copy URL</button>
                        <button class="btn btn-success" onclick="openEntryForm()">🧪 Test Entry Form</button>
                    </div>
                </div>
            </div>

            <!-- Entry Form Tab -->
            <div id="entry" class="tab-content">
                <div class="form-section">
                    <h3 class="section-title">📝 Entry Form</h3>
                    <p>Add participants to your trial. Dog data is automatically loaded from the database.</p>
                    
                    <div id="trialOptions">
                        <p style="color: #666; font-style: italic;">Please complete trial setup first.</p>
                    </div>
                </div>
            </div>

            <!-- Results Tab -->
            <div id="results" class="tab-content">
                <div class="results-header">
                    <h3 class="section-title">📋 Trial Results</h3>
                    <div class="results-actions">
                        <button type="button" class="btn btn-primary" onclick="exportToCSV()">📤 Export CSV</button>
                        <button type="button" class="btn btn-success" onclick="exportToExcel()">📊 Export Excel</button>
                    </div>
                </div>
                <div class="results-container">
                    <div id="resultsContainer">
                        <p class="no-data">No entries yet. Use the Entry Form to add participants.</p>
                    </div>
                </div>
            </div>

            <!-- Cross Reference Tab -->
            <div id="cross-reference" class="tab-content">
                <div class="form-section">
                    <h3 class="section-title">🔍 Cross Reference & Search</h3>
                    <p>Search and cross-reference entries across all classes and rounds.</p>
                    
                    <div class="search-controls">
                        <div class="search-group">
                            <label>Search by Registration:</label>
                            <input type="text" id="searchReg" placeholder="Enter registration number">
                        </div>
                        <div class="search-group">
                            <label>Search by Handler:</label>
                            <input type="text" id="searchHandler" placeholder="Enter handler name">
                        </div>
                        <div class="search-group">
                            <label>Search by Dog Name:</label>
                            <input type="text" id="searchDog" placeholder="Enter dog name">
                        </div>
                        <div class="search-actions">
                            <button class="btn btn-primary" onclick="performCrossReference()">🔍 Search</button>
                            <button class="btn btn-secondary" onclick="clearCrossReference()">🗑️ Clear</button>
                        </div>
                    </div>
                </div>
                
                <div id="crossReferenceResults" class="results-container">
                    <p class="no-data">Enter search criteria above to find entries.</p>
                </div>
            </div>

            <!-- Running Order Tab -->
            <div id="running-order" class="tab-content">
                <div class="running-order-header">
                    <h3 class="section-title">🏃 Running Order Management</h3>
                    <div class="running-order-actions">
                        <button class="btn btn-primary" onclick="generateRunningOrder()">🎲 Generate Running Order</button>
                        <button class="btn btn-warning" onclick="shuffleRunningOrder()">🔀 Shuffle Order</button>
                        <button class="btn btn-success" onclick="printRunningOrder()">🖨️ Print Running Order</button>
                    </div>
                </div>
                
                <div id="runningOrderContainer" class="results-container">
                    <p class="no-data">Generate running order from your trial entries.</p>
                </div>
            </div>

            <!-- Score Sheets Tab -->
            <div id="score-sheets" class="tab-content">
                <div class="score-sheets-header">
                    <h3 class="section-title">📄 Score Sheets Generation</h3>
                    <div class="score-sheets-actions">
                        <button class="btn btn-primary" onclick="previewScoreSheets()">👁️ Preview Score Sheets</button>
                        <button class="btn btn-success" onclick="printScoreSheets()">🖨️ Print Score Sheets</button>
                        <button class="btn btn-warning" onclick="generatePDFScoreSheets()">📄 Export as PDF</button>
                    </div>
                </div>
                
                <div id="scoreSheetsContainer" class="results-container">
                    <p class="no-data">Generate score sheets from your running order.</p>
                </div>
            </div>

            <!-- Digital Score Entry Tab -->
            <div id="score-entry" class="tab-content">
                <div class="score-entry-header">
                    <h3 class="section-title">💻 Digital Score Entry</h3>
                    <div class="score-entry-actions">
                        <button class="btn btn-primary" onclick="loadDigitalScoreEntry()">📱 Load Digital Sheets</button>
                        <button class="btn btn-success" onclick="saveAllDigitalScores()">💾 Save All Scores</button>
                        <button class="btn btn-warning" onclick="syncDigitalScores()">🔄 Sync with Physical</button>
                    </div>
                </div>
                
                <div id="digitalSheetSelector" class="digital-sheet-selector">
                    <p class="no-data">Load digital scoring interface from your trial configuration.</p>
                </div>
                
                <div id="digitalScoreSheetContainer" class="digital-score-container">
                    <!-- Digital score sheets will be loaded here -->
                </div>
            </div>

            <!-- Reports Tab -->
            <div id="reports" class="tab-content">
                <div class="form-section">
                    <h3 class="section-title">📊 Trial Reports & Export</h3>
                    <p>Generate comprehensive reports and export trial data.</p>
                    
                    <div class="report-cards">
                        <div class="report-card">
                            <h4>📈 Summary Report</h4>
                            <p>Complete overview of trial statistics</p>
                            <button class="btn btn-primary" onclick="generateSummaryReport()">Generate</button>
                        </div>
                        <div class="report-card">
                            <h4>🏆 Placement Report</h4>
                            <p>Winners and placement results</p>
                            <button class="btn btn-success" onclick="generatePlacementReport()">Generate</button>
                        </div>
                        <div class="report-card">
                            <h4>📦 Export All Data</h4>
                            <p>Download complete trial data</p>
                            <button class="btn btn-warning" onclick="exportAllData()">Export</button>
                        </div>
                        <div class="report-card">
                            <h4>📄 Complete PDF</h4>
                            <p>Full trial documentation</p>
                            <button class="btn btn-danger" onclick="generateFullTrialPDF()">Generate PDF</button>
                        </div>
                    </div>
                </div>
                
                <div id="reportsContainer" class="results-container">
                    <p class="no-data">Select a report type above to get started.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Preview Modal -->
    <div id="previewModal" class="modal-overlay" style="display: none;">
        <div class="modal-container">
            <div class="modal-header">
                <h3>📄 Score Sheets Preview</h3>
                <div class="modal-actions">
                    <button class="btn btn-primary" onclick="printFromPreview()">🖨️ Print</button>
                    <button class="btn btn-success" onclick="openDigitalEntryFromPreview()">💻 Digital Entry</button>
                    <button class="btn btn-danger" onclick="closePreview()">❌ Close</button>
                </div>
            </div>
            <div id="previewContent" class="modal-content"></div>
        </div>
    </div>

    <!-- Auto-save Status -->
    <div id="autoSaveStatus" class="auto-save-status" style="display: none;"></div>

    <!-- JavaScript Files -->
    <script src="js/utils.js"></script>
    <script src="js/database.js"></script>
    <script src="js/trial-manager.js"></script>
    <script src="js/entry-form.js"></script>
    <script src="js/running-order.js"></script>
    <script src="js/score-sheets.js"></script>
    <script src="js/admin-dashboard.js"></script>
    <script src="js/waiver-system.js"></script>
</body>
</html>
