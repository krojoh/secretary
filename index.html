<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dog Trial Management System</title>
    
    <!-- CSS Files -->
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/forms.css">
    <link rel="stylesheet" href="css/tables.css">
    <link rel="stylesheet" href="css/print.css">
</head>
<body>
    <!-- Authentication Modal -->
    <div id="authOverlay" class="auth-overlay">
        <div class="auth-modal">
            <h2>Welcome to Dog Trial Management System</h2>
            
            <div class="auth-tabs">
                <button class="auth-tab active" onclick="showAuthTab('login', this)">Login</button>
                <button class="auth-tab" onclick="showAuthTab('register', this)">Register</button>
            </div>

            <!-- Login Form -->
            <form id="loginForm" class="auth-form active" onsubmit="handleLogin(event)">
                <input type="text" id="loginUsername" class="auth-input" placeholder="Username" required>
                <input type="password" id="loginPassword" class="auth-input" placeholder="Password" required>
                <button type="submit" class="auth-button">Login</button>
            </form>

            <!-- Register Form -->
            <form id="registerForm" class="auth-form" onsubmit="handleRegister(event)">
                <input type="text" id="regUsername" class="auth-input" placeholder="Choose Username" required>
                <input type="password" id="regPassword" class="auth-input" placeholder="Choose Password" required>
                <input type="password" id="regConfirmPassword" class="auth-input" placeholder="Confirm Password" required>
                <input type="text" id="regFullName" class="auth-input" placeholder="Full Name" required>
                <input type="email" id="regEmail" class="auth-input" placeholder="Email Address" required>
                <button type="submit" class="auth-button">Register</button>
            </form>
        </div>
    </div>

    <!-- Main Application -->
    <div id="mainApp" class="hidden">
        <!-- User Bar -->
        <div class="user-bar">
            <div class="user-info" id="userInfo"></div>
            <button class="logout-btn" onclick="logout()">Logout</button>
        </div>

        <div class="container">
            <div class="header">
                <h1>🐕 Dog Trial Management System</h1>
                <p>Complete trial management with waiver system and electronic scoresheets</p>
            </div>

            <!-- My Trials Section -->
            <div class="my-trials">
                <h3>My Trials</h3>
                <div id="myTrialsList"></div>
                <button onclick="createNewTrial()">Create New Trial</button>
            </div>

            <!-- Quick Tools Section -->
            <div class="tool-links">
                <h3>📋 Quick Access Tools</h3>
                <div class="tool-grid">
                    <a href="pages/waiver-entry.html" class="tool-card" target="_blank">
                        <div class="tool-icon">📝</div>
                        <h4>Waiver & Entry Form</h4>
                        <p>Digital waiver and entry system for participants</p>
                    </a>
                    <a href="pages/scent-scoresheet.html" class="tool-card" target="_blank">
                        <div class="tool-icon">🔍</div>
                        <h4>Scent Detective Scoresheet</h4>
                        <p>Electronic scoresheet for scent work trials</p>
                    </a>
                    <div class="tool-card" onclick="showTab('score-sheets', document.querySelectorAll('.nav-tab')[5])">
                        <div class="tool-icon">📄</div>
                        <h4>Traditional Scoresheets</h4>
                        <p>Generate printable scoresheets for obedience trials</p>
                    </div>
                    <div class="tool-card" onclick="showTab('reports', document.querySelectorAll('.nav-tab')[6])">
                        <div class="tool-icon">📊</div>
                        <h4>Reports & Analytics</h4>
                        <p>Generate trial reports and entry statistics</p>
                    </div>
                </div>
            </div>

            <div class="nav-tabs">
                <button class="nav-tab active" onclick="showTab('setup', this)">Trial Setup</button>
                <button class="nav-tab" onclick="showTab('entry', this)">Entry Form</button>
                <button class="nav-tab" onclick="showTab('results', this)">Results</button>
                <button class="nav-tab" onclick="showTab('cross-reference', this)">Cross-Reference</button>
                <button class="nav-tab" onclick="showTab('running-order', this)">Running Order</button>
                <button class="nav-tab" onclick="showTab('score-sheets', this)">Score Sheets</button>
                <button class="nav-tab" onclick="showTab('reports', this)">Reports</button>
                <button class="nav-tab" onclick="showTab('score-entry', this)">Score Entry</button>
            </div>

            <!-- Setup Tab -->
            <div id="setup" class="tab-content active">
                <div class="initial-question">
                    <h3 id="trialTitle">New Trial Setup</h3>
                    
                    <!-- Basic Trial Information -->
                    <div class="form-group">
                        <span class="label">Trial Name:</span>
                        <input type="text" id="trialName" placeholder="Enter trial name" style="width: 300px;">
                    </div>
                    
                    <div class="form-group">
                        <span class="label">Club Name:</span>
                        <input type="text" id="clubName" placeholder="Enter club name" style="width: 300px;">
                    </div>
                    
                    <div class="form-group">
                        <span class="label">Location:</span>
                        <input type="text" id="trialLocation" placeholder="Enter venue location" style="width: 300px;">
                    </div>
                    
                    <!-- Contact Information -->
                    <div class="form-group">
                        <span class="label">Secretary Email:</span>
                        <input type="email" id="contactEmail" placeholder="secretary@club.com" style="width: 300px;">
                    </div>
                    
                    <div class="form-group">
                        <span class="label">Contact Phone:</span>
                        <input type="tel" id="contactPhone" placeholder="(555) 123-4567" style="width: 200px;">
                    </div>
                    
                    <!-- Waiver Configuration -->
                    <div class="waiver-config-section">
                        <h4>📋 Waiver Requirements</h4>
                        <div class="checkbox-group">
                            <label>
                                <input type="checkbox" id="requiresVetCertificate" checked>
                                Require Veterinary Certificate
                            </label>
                            <label>
                                <input type="checkbox" id="requiresInsurance">
                                Require Insurance Documentation
                            </label>
                        </div>
                        
                        <div class="form-group">
                            <span class="label">Additional Requirements:</span>
                            <textarea id="additionalRequirements" rows="3" 
                                      placeholder="e.g., All dogs must be at least 6 months old and spayed/neutered if over 1 year old."
                                      style="width: 100%; max-width: 500px;"></textarea>
                        </div>
                    </div>
                    
                    <!-- Trial Days Setup -->
                    <div class="form-group">
                        <span class="label">How many days in trial?</span>
                        <input type="number" id="trialDays" min="1" max="30" placeholder="Enter number">
                        <button type="button" onclick="generateDays()">Generate Days</button>
                    </div>
                </div>

                <div id="daysContainer"></div>
                
                <!-- Save Trial Section -->
                <div id="saveTrialSection" style="display: none;" class="save-trial-section">
                    <h3>🎯 Ready to Save Your Trial?</h3>
                    <p>All days have been configured. Review your trial setup and save to generate entry form links.</p>
                    
                    <div class="form-group">
                        <button type="button" onclick="saveTrialDataWithWaiver()">💾 Save Trial & Generate Entry Links</button>
                    </div>
                    
                    <p>Once saved, you'll receive shareable links for participant registration and trial management.</p>
                </div>

                <!-- Entry Form Link Section -->
                <div id="entryFormLink" style="display: none;" class="entry-form-link">
                    <h3>🎉 Trial Setup Complete!</h3>
                    <p><strong>Share these URLs for your trial:</strong></p>
                    
                    <!-- Traditional Entry Form Link -->
                    <div class="link-section">
                        <h4>📝 Traditional Entry Form:</h4>
                        <div class="url-container">
                            <input type="text" id="shareableURL" readonly class="shareable-url">
                            <button onclick="copyURL()">📋 Copy</button>
                        </div>
                    </div>
                    
                    <!-- Additional Tool Links -->
                    <div id="additionalLinks" class="additional-links">
                        <h4>📋 Additional Tools:</h4>
                        <div class="tool-link-buttons">
                            <a href="#" id="waiverFormLink" target="_blank" class="tool-link-btn">
                                📝 Waiver & Entry Form
                            </a>
                            <a href="#" id="scentScoresheetLink" target="_blank" class="tool-link-btn">
                                🔍 Scent Detective Scoresheet
                            </a>
                        </div>
                    </div>
                    
                    <div class="test-buttons">
                        <button onclick="openEntryForm()">🔗 Test Traditional Form</button>
                        <button onclick="testWaiverForm()">📝 Test Waiver Form</button>
                    </div>
                    
                    <p>Participants can use these links to register for your trial.</p>
                </div>
            </div>

            <!-- Entry Form Tab -->
            <div id="entry" class="tab-content">
                <div class="initial-question">
                    <h3>Dog Entry Form</h3>
                    <form id="entryForm">
                        <div class="form-group">
                            <span class="label">Registration Number:</span>
                            <div class="typeahead-container">
                                <input type="text" id="regNumber" class="typeahead-input" 
                                       placeholder="Type registration number" 
                                       onkeyup="handleRegNumberTypeahead(this)" 
                                       onblur="hideRegNumberDropdown()" 
                                       onfocus="showRegNumberDropdown()">
                                <div id="regNumberDropdown" class="typeahead-dropdown"></div>
                            </div>
                            <span id="callName" class="call-name-display">Call Name will appear here</span>
                        </div>

                        <div class="form-group">
                            <span class="label">Handler Name:</span>
                            <input type="text" id="handlerName" placeholder="Enter handler name">
                        </div>

                        <div class="form-group">
                            <span class="label">Select Trial(s):</span>
                            <div class="trial-selection-note">You can select multiple trials for the same dog</div>
                        </div>

                        <div id="trialOptions"></div>

                        <div class="form-group">
                            <button type="button" onclick="submitEntry()">Submit Entry</button>
                            <button type="button" onclick="clearEntryForm()">Clear Form</button>
                        </div>
                    </form>

                    <!-- Import/Export Section -->
                    <div class="import-export-section">
                        <h4>📁 Import/Export Entries</h4>
                        <div>
                            <input type="file" id="csvFileInput" accept=".csv" onchange="importEntriesFromCSV()" style="display: none;">
                            <button onclick="document.getElementById('csvFileInput').click()">📥 Import CSV</button>
                            <button onclick="exportEntriesToCSV()">📤 Export CSV</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Results Tab -->
            <div id="results" class="tab-content">
                <div class="initial-question">
                    <h3>Entry Results</h3>
                    <div id="resultsContainer">
                        <p style="text-align: center; color: #666; padding: 40px;">No entries yet. Please add some entries first.</p>
                    </div>
                </div>
            </div>

            <!-- Cross-Reference Tab -->
            <div id="cross-reference" class="tab-content">
                <div class="initial-question">
                    <h3>Cross-Reference Grid</h3>
                    <div id="crossReferenceGrid">
                        <p style="text-align: center; color: #666; padding: 40px;">Please complete trial setup first.</p>
                    </div>
                </div>
            </div>

            <!-- Running Order Tab -->
            <div id="running-order" class="tab-content">
                <div class="initial-question">
                    <h3>Running Order</h3>
                    <div class="running-order-controls">
                        <button onclick="generateRunningOrder()">🔄 Generate Running Order</button>
                        <button onclick="randomizeRunningOrder()">🎲 Randomize Order</button>
                        <button onclick="printRunningOrder()">🖨️ Print Running Order</button>
                    </div>
                    <div id="runningOrderContainer">
                        <p style="text-align: center; color: #666; padding: 40px;">Please complete trial setup and add entries first.</p>
                    </div>
                </div>
            </div>

            <!-- Score Sheets Tab -->
            <div id="score-sheets" class="tab-content">
                <div class="initial-question">
                    <h3>Score Sheets</h3>
                    <div class="scoresheet-controls">
                        <button onclick="generateScoreSheets()">📄 Generate Score Sheets</button>
                        <button onclick="previewScoreSheets()">👁️ Preview All</button>
                        <button onclick="printAllScoreSheets()">🖨️ Print All</button>
                    </div>
                    <div id="scoreSheetsContainer">
                        <p style="text-align: center; color: #666; padding: 40px;">Please complete trial setup first.</p>
                    </div>
                </div>
            </div>

            <!-- Reports Tab -->
            <div id="reports" class="tab-content">
                <div class="initial-question">
                    <h3>Reports & Analytics</h3>
                    <div class="report-controls">
                        <button onclick="generateTrialSummaryReport()">📊 Trial Summary</button>
                        <button onclick="generateEntryReport()">📋 Entry Report</button>
                        <button onclick="generateJudgeReport()">👨‍⚖️ Judge Report</button>
                        <button onclick="generateFinancialReport()">💰 Financial Report</button>
                    </div>
                    <div id="reportsContainer">
                        <p style="text-align: center; color: #666; padding: 40px;">Generate reports using the buttons above.</p>
                    </div>
                </div>
            </div>

            <!-- Score Entry Tab -->
            <div id="score-entry" class="tab-content">
                <div class="initial-question">
                    <h3>Digital Score Entry</h3>
                    <div id="digitalSheetSelector">
                        <p style="text-align: center; color: #666; padding: 40px;">Please complete trial setup first.</p>
                    </div>
                    <div id="digitalScoreSheetContainer"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Preview Modal -->
    <div id="previewModal" class="preview-modal">
        <div class="preview-content">
            <div class="preview-header">
                <h4>📄 Score Sheets Preview</h4>
                <div>
                    <button onclick="printFromPreview()" class="print-btn">🖨️ Print All</button>
                    <button onclick="openDigitalEntry()" class="save-btn">✏️ Digital Entry</button>
                    <button onclick="closePreview()" class="secondary-btn">✖ Close</button>
                </div>
            </div>
            <div class="preview-body">
                <div id="previewContent" class="score-sheets-container"></div>
            </div>
        </div>
    </div>

    <!-- JavaScript Files -->
    <script src="js/utils.js"></script>
    <script src="js/database.js"></script>
    <script src="js/trial-manager.js"></script>
    <script src="js/entry-form.js"></script>
    <script src="js/running-order.js"></script>
    <script src="js/score-sheets.js"></script>
    <script src="js/reports.js"></script>
    
    <!-- Integration Script for Waiver and Scoresheet Features -->
    <script>
        // Enhanced trial saving with waiver configuration
        function saveTrialDataWithWaiver() {
            // Collect waiver configuration
            const waiverConfig = {
                clubName: document.getElementById('clubName').value || 'Dog Trial Club',
                location: document.getElementById('trialLocation').value || 'Training Center',
                contactEmail: document.getElementById('contactEmail').value || 'secretary@dogtrial.com',
                contactPhone: document.getElementById('contactPhone').value || '(555) 123-4567',
                requiresVetCertificate: document.getElementById('requiresVetCertificate').checked,
                requiresInsurance: document.getElementById('requiresInsurance').checked,
                additionalRequirements: document.getElementById('additionalRequirements').value || ''
            };
            
            // Add waiver config to each trial in trialConfig
            if (typeof trialConfig !== 'undefined') {
                trialConfig.forEach(trial => {
                    trial.waiverConfig = waiverConfig;
                    trial.clubName = waiverConfig.clubName;
                    trial.location = waiverConfig.location;
                    trial.contactEmail = waiverConfig.contactEmail;
                    trial.contactPhone = waiverConfig.contactPhone;
                });
            }
            
            // Call existing save function
            saveTrialData();
            
            // Generate and display enhanced links
            setTimeout(() => {
                generateEnhancedTrialLinks();
            }, 500);
        }
        
        // Generate enhanced trial links with waiver and scoresheet options
        function generateEnhancedTrialLinks() {
            if (typeof trialConfig === 'undefined' || trialConfig.length === 0) return;
            
            const baseUrl = window.location.origin + window.location.pathname.replace('index.html', '');
            const firstTrial = trialConfig[0];
            
            // Update waiver form link
            const waiverParams = new URLSearchParams({
                trial: encodeURIComponent(firstTrial.trialName || 'Trial'),
                class: firstTrial.className || 'Novice',
                date: firstTrial.date || new Date().toISOString().split('T')[0]
            });
            const waiverLink = `${baseUrl}pages/waiver-entry.html?${waiverParams.toString()}`;
            document.getElementById('waiverFormLink').href = waiverLink;
            
            // Update scoresheet link
            const scoresheetParams = new URLSearchParams({
                trial: encodeURIComponent(firstTrial.trialName || 'Trial'),
                class: firstTrial.className || 'Novice',
                date: firstTrial.date || new Date().toISOString().split('T')[0]
            });
            const scoresheetLink = `${baseUrl}pages/scent-scoresheet.html?${scoresheetParams.toString()}`;
            document.getElementById('scentScoresheetLink').href = scoresheetLink;
        }
        
        // Test waiver form function
        function testWaiverForm() {
            const waiverLink = document.getElementById('waiverFormLink').href;
            if (waiverLink && waiverLink !== '#') {
                window.open(waiverLink, '_blank');
            } else {
                alert('Please save your trial first to generate the waiver form link.');
            }
        }
        
        // Process waiver entries into existing system
        function processWaiverEntry(entryData) {
            if (typeof entryResults === 'undefined') {
                window.entryResults = [];
            }
            
            const standardEntry = {
                regNumber: entryData.confirmationNumber,
                callName: entryData.dogName,
                handler: entryData.handlerName,
                date: entryData.trialDate,
                className: entryData.trialClass,
                round: 1,
                judge: 'TBD',
                entryType: 'regular',
                timestamp: entryData.timestamp,
                breed: entryData.breed,
                birthDate: entryData.birthDate,
                email: entryData.handlerEmail,
                phone: entryData.handlerPhone,
                emergencyContact: entryData.emergencyContact,
                specialNeeds: entryData.specialNeeds,
                waiverAccepted: true
            };
            
            entryResults.push(standardEntry);
            
            if (typeof saveEntriesToTrial === 'function') {
                saveEntriesToTrial();
            }
            if (typeof updateResultsDisplay === 'function') {
                updateResultsDisplay();
            }
            if (typeof updateCrossReferenceDisplay === 'function') {
                updateCrossReferenceDisplay();
            }
            
            return standardEntry;
        }
        
        // Enhanced initialization
        window.onload = function() {
            console.log('Initializing Enhanced Dog Trial Management System...');
            
            // Check for URL parameters
            if (handleURLParameters && handleURLParameters()) {
                loadDogData && loadDogData();
                return;
            }
            
            // Initialize all systems
            loadDogData && loadDogData();
            if (typeof initializeDigitalScoring === 'function') {
                initializeDigitalScoring();
            }
            
            console.log('Application ready with waiver and scoresheet integration');
        };
    </script>
</body>
</html>
