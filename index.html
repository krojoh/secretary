<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dog Trial Management System</title>
    
    <!-- CSS Files -->
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/forms.css">
    <link rel="stylesheet" href="css/tables.css">
    <link rel="stylesheet" href="css/print.css">
    
    <style>
        /* Enhanced Entry Form Styles */
        .entry-form-header {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }

        .entry-form-container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .trial-selection-section {
            margin: 30px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }

        .trial-options-grid {
            display: grid;
            gap: 20px;
        }

        .trial-class-group {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #d0d0d0;
        }

        .trial-class-group h5 {
            color: #2c5aa0;
            margin: 0 0 15px 0;
            font-weight: bold;
            border-bottom: 1px solid #e0e0e0;
            padding-bottom: 8px;
        }

        .round-options {
            display: grid;
            gap: 10px;
        }

        .round-option {
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
            border: 1px solid #e0e0e0;
        }

        .round-label, .feo-label {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 5px 0;
            cursor: pointer;
            font-size: 14px;
        }

        .feo-label {
            color: #666;
            font-style: italic;
        }

        .round-label input, .feo-label input {
            margin: 0;
        }

        .form-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #e0e0e0;
        }

        .management-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .no-trial-message {
            text-align: center;
            padding: 60px 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border: 2px dashed #d0d0d0;
        }

        .no-trial-message h3 {
            color: #dc2626;
            margin-bottom: 15px;
        }

        .results-summary {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 1px solid #e0e0e0;
        }

        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .stat-item {
            text-align: center;
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #d0d0d0;
        }

        .stat-number {
            display: block;
            font-size: 24px;
            font-weight: bold;
            color: #2c5aa0;
        }

        .stat-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
        }

        .class-group {
            margin-bottom: 30px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .class-group h4 {
            background: #2c5aa0;
            color: white;
            margin: 0;
            padding: 15px 20px;
            font-size: 16px;
        }

        .entry-count {
            color: #e0e7ff;
            font-weight: normal;
        }

        .entry-type {
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .entry-type.regular {
            background: #10b981;
            color: white;
        }

        .entry-type.feo {
            background: #f59e0b;
            color: white;
        }

        .btn-delete {
            background: #dc2626;
            color: white;
            border: none;
            padding: 5px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .btn-delete:hover {
            background: #b91c1c;
        }

        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .form-actions {
                flex-direction: column;
            }
            
            .management-actions {
                justify-content: center;
            }

            .summary-stats {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Authentication Modal -->
    <div id="authOverlay" class="auth-overlay">
        <div class="auth-modal">
            <h2>Welcome to Dog Trial Management System</h2>
            
            <div class="auth-tabs">
                <button class="auth-tab active" onclick="showAuthTab('login', this)">Login</button>
                <button class="auth-tab" onclick="showAuthTab('register', this)">Register</button>
            </div>

            <!-- Login Form -->
            <form id="loginForm" class="auth-form active" onsubmit="handleLogin(event)">
                <input type="text" id="loginUsername" class="auth-input" placeholder="Username" required>
                <input type="password" id="loginPassword" class="auth-input" placeholder="Password" required>
                <button type="submit" class="auth-button">Login</button>
            </form>

            <!-- Register Form -->
            <form id="registerForm" class="auth-form" onsubmit="handleRegister(event)">
                <input type="text" id="regUsername" class="auth-input" placeholder="Choose Username" required>
                <input type="password" id="regPassword" class="auth-input" placeholder="Choose Password" required>
                <input type="password" id="regConfirmPassword" class="auth-input" placeholder="Confirm Password" required>
                <input type="text" id="regFullName" class="auth-input" placeholder="Full Name" required>
                <input type="email" id="regEmail" class="auth-input" placeholder="Email Address" required>
                <button type="submit" class="auth-button">Register</button>
            </form>
        </div>
    </div>

    <!-- Main Application -->
    <div id="mainApp" class="hidden">
        <!-- User Bar -->
        <div class="user-bar">
            <div class="user-info" id="userInfo"></div>
            <button class="logout-btn" onclick="logout()">Logout</button>
        </div>

        <div class="container">
            <div class="header">
                <h1>üêï Dog Trial Management System</h1>
                <p>Complete trial management with waiver system and electronic scoresheets</p>
            </div>

            <!-- My Trials Section -->
            <div class="my-trials">
                <h3>My Trials</h3>
                <div id="myTrialsList"></div>
                <button onclick="createNewTrial()">Create New Trial</button>
            </div>

            <!-- Quick Access Tools Section -->
            <div class="tool-links">
                <h3>üìã Quick Access Tools</h3>
                <div class="tool-grid">
                    <div class="tool-card" onclick="openMainEntryForm()">
                        <div class="tool-icon">üìù</div>
                        <h4>Entry Form</h4>
                        <p>Main entry form integrated with current trial setup</p>
                    </div>
                    <a href="pages/waiver-entry.html" class="tool-card" target="_blank">
                        <div class="tool-icon">üìÑ</div>
                        <h4>Waiver & Entry Form</h4>
                        <p>Digital waiver and entry system for participants</p>
                    </a>
                    <a href="pages/scent-scoresheet.html" class="tool-card" target="_blank">
                        <div class="tool-icon">üîç</div>
                        <h4>Scent Detective Scoresheet</h4>
                        <p>Electronic scoresheet for scent work trials</p>
                    </a>
                    <div class="tool-card" onclick="showTab('score-sheets', document.querySelectorAll('.nav-tab')[5])">
                        <div class="tool-icon">üìÑ</div>
                        <h4>Traditional Scoresheets</h4>
                        <p>Generate printable scoresheets for obedience trials</p>
                    </div>
                    <div class="tool-card" onclick="showTab('reports', document.querySelectorAll('.nav-tab')[6])">
                        <div class="tool-icon">üìä</div>
                        <h4>Reports & Analytics</h4>
                        <p>Generate trial reports and entry statistics</p>
                    </div>
                </div>
            </div>

            <div class="nav-tabs">
                <button class="nav-tab active" onclick="showTab('setup', this)">Trial Setup</button>
                <button class="nav-tab" onclick="showTab('entry', this)">Entry Form</button>
                <button class="nav-tab" onclick="showTab('results', this)">Results</button>
                <button class="nav-tab" onclick="showTab('cross-reference', this)">Cross-Reference</button>
                <button class="nav-tab" onclick="showTab('running-order', this)">Running Order</button>
                <button class="nav-tab" onclick="showTab('score-sheets', this)">Score Sheets</button>
                <button class="nav-tab" onclick="showTab('reports', this)">Reports</button>
                <button class="nav-tab" onclick="showTab('score-entry', this)">Score Entry</button>
            </div>

            <!-- Setup Tab -->
            <div id="setup" class="tab-content active">
                <div class="initial-question">
                    <h3 id="trialTitle">New Trial Setup</h3>
                    
                    <!-- Basic Trial Information -->
                    <div class="form-group">
                        <span class="label">Trial Name:</span>
                        <input type="text" id="trialName" placeholder="Enter trial name" style="width: 300px;">
                    </div>
                    
                    <div class="form-group">
                        <span class="label">Club Name:</span>
                        <input type="text" id="clubName" placeholder="Enter club name" style="width: 300px;">
                    </div>
                    
                    <div class="form-group">
                        <span class="label">Location:</span>
                        <input type="text" id="trialLocation" placeholder="Enter trial location" style="width: 300px;">
                    </div>
                    
                    <div class="form-group">
                        <span class="label">Contact Email:</span>
                        <input type="email" id="contactEmail" placeholder="secretary@club.com" style="width: 300px;">
                    </div>
                    
                    <div class="form-group">
                        <span class="label">Contact Phone:</span>
                        <input type="tel" id="contactPhone" placeholder="(555) 123-4567" style="width: 300px;">
                    </div>
                    
                    <!-- Waiver Requirements -->
                    <div class="form-group">
                        <span class="label">Waiver Requirements:</span>
                        <div class="checkbox-group">
                            <label>
                                <input type="checkbox" id="requiresVetCertificate" checked>
                                Require Veterinary Certificate
                            </label>
                            <label>
                                <input type="checkbox" id="requiresInsurance">
                                Require Insurance Documentation
                            </label>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <span class="label">Additional Requirements:</span>
                        <textarea id="additionalRequirements" placeholder="e.g., All dogs must be at least 6 months old and spayed/neutered if over 1 year old" style="width: 100%; height: 60px;"></textarea>
                    </div>
                    
                    <!-- Trial Configuration -->
                    <div class="form-group">
                        <span class="label">Number of trial days:</span>
                        <input type="number" id="trialDays" min="1" max="10" style="width: 100px;">
                        <button type="button" onclick="generateDays()">Generate Days</button>
                    </div>
                    
                    <div id="daysContainer"></div>
                    
                    <p>Review your trial setup and save to generate entry form links.</p>
                    
                    <div class="form-group">
                        <button type="button" onclick="saveTrialDataWithWaiver()">üíæ Save Trial & Generate Entry Links</button>
                    </div>
                    
                    <p>Once saved, you'll receive shareable links for participant registration and trial management.</p>
                </div>

                <!-- Entry Form Link Section -->
                <div id="entryFormLink" style="display: none;" class="entry-form-link">
                    <h3>üéâ Trial Setup Complete!</h3>
                    <p><strong>Share these URLs for your trial:</strong></p>
                    
                    <!-- Traditional Entry Form Link -->
                    <div class="link-section">
                        <h4>üìù Traditional Entry Form:</h4>
                        <div class="url-container">
                            <input type="text" id="shareableURL" readonly class="shareable-url">
                            <button onclick="copyURL()">üìã Copy</button>
                        </div>
                    </div>
                    
                    <!-- Additional Tool Links -->
                    <div id="additionalLinks" class="additional-links">
                        <h4>üìã Additional Tools:</h4>
                        <div class="tool-link-buttons">
                            <a href="#" id="waiverFormLink" target="_blank" class="tool-link-btn">
                                üìù Waiver & Entry Form
                            </a>
                            <a href="#" id="scentScoresheetLink" target="_blank" class="tool-link-btn">
                                üîç Scent Detective Scoresheet
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Entry Form Tab -->
            <div id="entry" class="tab-content">
                <div id="entryFormContainer">
                    <!-- Entry form content will be loaded here -->
                </div>
            </div>

            <!-- Results Tab -->
            <div id="results" class="tab-content">
                <div class="initial-question">
                    <h3>üìä Trial Results</h3>
                    <div class="results-header">
                        <div class="results-controls">
                            <button onclick="exportEntriesToCSV()">üì§ Export CSV</button>
                            <button onclick="importEntriesFromCSV(document.getElementById('csvImportInput'))">üì• Import CSV</button>
                            <input type="file" id="csvImportInput" accept=".csv" style="display: none;" onchange="importEntriesFromCSV(this)">
                            <button onclick="showEntryStatistics()">üìä Statistics</button>
                            <button onclick="clearAllEntries()">üóëÔ∏è Clear All</button>
                        </div>
                    </div>
                    <div id="resultsContainer">
                        <p style="text-align: center; color: #666; padding: 40px;">Complete trial setup and add entries to see results here.</p>
                    </div>
                </div>
            </div>

            <!-- Cross Reference Tab -->
            <div id="cross-reference" class="tab-content">
                <div class="initial-question">
                    <h3>üîÑ Cross Reference</h3>
                    <p>View entries organized by handler and dog combinations</p>
                    <div id="crossReferenceContainer">
                        <p style="text-align: center; color: #666; padding: 40px;">Add entries to see cross-reference data here.</p>
                    </div>
                </div>
            </div>

            <!-- Running Order Tab -->
            <div id="running-order" class="tab-content">
                <div class="initial-question">
                    <h3>üèÉ‚Äç‚ôÇÔ∏è Running Order</h3>
                    <div class="running-order-header">
                        <div class="running-order-controls">
                            <select id="runningOrderSelect" onchange="generateRunningOrder()">
                                <option value="">Select a trial to generate running order...</option>
                            </select>
                            <button onclick="shuffleRunningOrder()">üîÄ Shuffle</button>
                            <button onclick="printRunningOrder()">üñ®Ô∏è Print</button>
                        </div>
                    </div>
                    <div id="runningOrderContainer">
                        <p style="text-align: center; color: #666; padding: 40px;">Please complete trial setup first.</p>
                    </div>
                </div>
            </div>

            <!-- Score Sheets Tab -->
            <div id="score-sheets" class="tab-content">
                <div class="initial-question">
                    <h3>üìÑ Score Sheets</h3>
                    <div class="score-sheets-header">
                        <div class="score-sheets-controls">
                            <select id="scoreSheetSelect" multiple>
                                <option value="">Select trials for score sheets...</option>
                            </select>
                            <select id="scoreSheetType">
                                <option value="obedience">Obedience</option>
                                <option value="rally">Rally</option>
                                <option value="agility">Agility</option>
                                <option value="scent">Scent Work</option>
                            </select>
                            <button onclick="generateScoreSheets()">üìÑ Generate</button>
                            <button onclick="previewScoreSheets()">üëÅÔ∏è Preview</button>
                        </div>
                    </div>
                    <div id="scoreSheetsContainer">
                        <p style="text-align: center; color: #666; padding: 40px;">Please complete trial setup first.</p>
                    </div>
                </div>
            </div>

            <!-- Reports Tab -->
            <div id="reports" class="tab-content">
                <div class="initial-question">
                    <h3>Reports & Analytics</h3>
                    <div class="report-controls">
                        <button onclick="generateTrialSummaryReport()">üìä Trial Summary</button>
                        <button onclick="generateEntryReport()">üìã Entry Report</button>
                        <button onclick="generateJudgeReport()">üë®‚Äç‚öñÔ∏è Judge Report</button>
                        <button onclick="generateFinancialReport()">üí∞ Financial Report</button>
                    </div>
                    <div id="reportsContainer">
                        <p style="text-align: center; color: #666; padding: 40px;">Generate reports using the buttons above.</p>
                    </div>
                </div>
            </div>

            <!-- Score Entry Tab -->
            <div id="score-entry" class="tab-content">
                <div class="initial-question">
                    <h3>Digital Score Entry</h3>
                    <div id="digitalSheetSelector">
                        <p style="text-align: center; color: #666; padding: 40px;">Please complete trial setup first.</p>
                    </div>
                    <div id="digitalScoreSheetContainer"></div>
                    <div id="scoreResultsContainer">
                        <!-- Score results will be displayed here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Preview Modal -->
    <div id="previewModal" class="preview-modal">
        <div class="preview-content">
            <div class="preview-header">
                <h4>üìÑ Score Sheets Preview</h4>
                <div>
                    <button onclick="printFromPreview()" class="print-btn">üñ®Ô∏è Print All</button>
                    <button onclick="openDigitalEntry()" class="save-btn">‚úèÔ∏è Digital Entry</button>
                    <button onclick="closePreview()" class="secondary-btn">‚úñ Close</button>
                </div>
            </div>
            <div class="preview-body">
                <div id="previewContent" class="score-sheets-container"></div>
            </div>
        </div>
    </div>

    <!-- JavaScript Files -->
    <script src="js/utils.js"></script>
    <script src="js/database.js"></script>
    <script src="js/trial-manager.js"></script>
    <script src="js/entry-form.js"></script>
    <script src="js/running-order.js"></script>
    <script src="js/score-sheets.js"></script>
    <script src="js/reports.js"></script>
    
    <!-- Enhanced Integration Script -->
    <script>
        // Initialize the application when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize entry form when tab is opened
            const entryTab = document.querySelector('.nav-tab[onclick*="entry"]');
            if (entryTab) {
                entryTab.addEventListener('click', loadEntryFormTab);
            }
        });

        // Enhanced trial saving with waiver configuration
        function saveTrialDataWithWaiver() {
            // Validate minimum required data
            const trialName = document.getElementById('trialName').value;
            if (!trialName || trialName.trim() === '') {
                showStatusMessage('Please enter a trial name before saving', 'warning');
                document.getElementById('trialName').focus();
                return;
            }
            
            if (trialConfig.length === 0) {
                showStatusMessage('Please configure at least one trial day before saving', 'warning');
                return;
            }
            
            // Collect waiver configuration
            const waiverConfig = {
                clubName: document.getElementById('clubName').value || 'Dog Trial Club',
                location: document.getElementById('trialLocation').value || 'Training Center',
                contactEmail: document.getElementById('contactEmail').value || 'secretary@dogtrial.com',
                contactPhone: document.getElementById('contactPhone').value || '(555) 123-4567',
                requiresVetCertificate: document.getElementById('requiresVetCertificate')?.checked || false,
                requiresInsurance: document.getElementById('requiresInsurance')?.checked || false,
                additionalRequirements: document.getElementById('additionalRequirements')?.value || ''
            };
            
            // Add waiver config to each trial configuration
            trialConfig.forEach(trial => {
                trial.waiverConfig = waiverConfig;
                trial.clubName = waiverConfig.clubName;
                trial.location = waiverConfig.location;
                trial.contactEmail = waiverConfig.contactEmail;
                trial.contactPhone = waiverConfig.contactPhone;
            });
            
            // Save the trial
            if (saveTrialUpdates()) {
                generateEntryFormLinks();
                showStatusMessage('Trial saved successfully! Entry links generated.', 'success');
            }
        }

        // Generate entry form links after successful save
        function generateEntryFormLinks() {
            if (!currentTrialId || trialConfig.length === 0) {
                return;
            }
            
            // Show the entry form links section
            const entryFormLinkDiv = document.getElementById('entryFormLink');
            if (entryFormLinkDiv) {
                entryFormLinkDiv.style.display = 'block';
                
                // Generate the main entry form URL
                const baseURL = window.location.origin + window.location.pathname.replace('/index.html', '');
                const entryFormURL = `${baseURL}/pages/entry-form.html?trial=${currentTrialId}`;
                const waiverFormURL = `${baseURL}/pages/waiver-entry.html?trial=${currentTrialId}`;
                
                // Update the URLs in the interface
                const shareableURLInput = document.getElementById('shareableURL');
                if (shareableURLInput) {
                    shareableURLInput.value = entryFormURL;
                }
                
                const waiverFormLink = document.getElementById('waiverFormLink');
                if (waiverFormLink) {
                    waiverFormLink.href = waiverFormURL;
                }
                
                // Update additional tool links
                updateAdditionalToolLinks();
            }
        }

        // Update tool links with trial-specific URLs
        function updateAdditionalToolLinks() {
            if (!currentTrialId) return;
            
            const baseURL = window.location.origin + window.location.pathname.replace('/index.html', '');
            
            // Update scent scoresheet link
            const scentScoresheetLink = document.getElementById('scentScoresheetLink');
            if (scentScoresheetLink) {
                scentScoresheetLink.href = `${baseURL}/pages/scent-scoresheet.html?trial=${currentTrialId}`;
            }
        }

        // Handle main entry form access
        function openMainEntryForm() {
            if (!currentTrialId || trialConfig.length === 0) {
                if (confirm('No trial is currently configured. Would you like to create a new trial first?')) {
                    createNewTrial();
                    showTab('setup', document.querySelector('.nav-tab'));
                }
                return;
            }
            
            // Switch to the entry form tab
            showTab('entry', document.querySelectorAll('.nav-tab')[1]);
        }

        // Load entry form tab content
        function loadEntryFormTab() {
            const container = document.getElementById('entryFormContainer');
            if (!container) return;
            
            if (trialConfig.length === 0) {
                container.innerHTML = `
                    <div class="no-trial-message">
                        <h3>‚ö†Ô∏è No Trial Configured</h3>
                        <p>Please complete the trial setup before using the entry form.</p>
                        <button onclick="showTab('setup', document.querySelector('.nav-tab'))" class="btn btn-primary">
                            Go to Trial Setup
                        </button>
                    </div>
                `;
                return;
            }
            
            // Generate entry form interface
            let html = `
                <div class="entry-form-header">
                    <h3>üìù Trial Entry Form</h3>
                    <p>Enter participants for: <strong>${document.getElementById('trialName').value || 'Current Trial'}</strong></p>
                </div>
                
                <div class="entry-form-container">
                    <form id="mainEntryForm" onsubmit="handleMainEntrySubmission(event)">
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="entryRegNumber">Registration Number *</label>
                                <input type="text" id="entryRegNumber" required placeholder="Enter registration number">
                            </div>
                            
                            <div class="form-group">
                                <label for="entryHandler">Handler Name *</label>
                                <input type="text" id="entryHandler" required placeholder="Enter handler name">
                            </div>
                            
                            <div class="form-group">
                                <label for="entryCallName">Call Name</label>
                                <input type="text" id="entryCallName" placeholder="Enter dog's call name">
                            </div>
                            
                            <div class="form-group">
                                <label for="entryEmail">Email Address</label>
                                <input type="email" id="entryEmail" placeholder="Enter email address">
                            </div>
                        </div>
                        
                        <div class="trial-selection-section">
                            <h4>Select Trial Entries</h4>
                            <div id="trialSelectionOptions">
                                <!-- Will be populated by JavaScript -->
                            </div>
                        </div>
                        
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary">üíæ Submit Entry</button>
                            <button type="button" onclick="clearMainEntryForm()" class="btn btn-secondary">üóëÔ∏è Clear Form</button>
                        </div>
                    </form>
                </div>
                
                <div class="entry-management">
                    <h4>Entry Management</h4>
                    <div class="management-actions">
                        <button onclick="importEntriesCSV()" class="btn btn-info">üì• Import CSV</button>
                        <button onclick="exportEntriesCSV()" class="btn btn-info">üì§ Export CSV</button>
                        <button onclick="showEntryStatistics()" class="btn btn-info">üìä Statistics</button>
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
            populateTrialSelectionOptions();
        }

        // Function to populate trial selection options
        function populateTrialSelectionOptions() {
            const container = document.getElementById('trialSelectionOptions');
            if (!container || trialConfig.length === 0) return;
            
            let html = '<div class="trial-options-grid">';
            
            // Group by date and class
            const groupedTrials = {};
            trialConfig.forEach((config, index) => {
                const key = `${config.date}_${config.className}`;
                if (!groupedTrials[key]) {
                    groupedTrials[key] = {
                        date: config.date,
                        className: config.className,
                        rounds: []
                    };
                }
                groupedTrials[key].rounds.push({
                    index: index,
                    roundNum: config.roundNum,
                    judge: config.judge,
                    feoOffered: config.feoOffered
                });
            });
            
            // Sort by date
            const sortedKeys = Object.keys(groupedTrials).sort((a, b) => {
                const dateA = groupedTrials[a].date;
                const dateB = groupedTrials[b].date;
                return dateA.localeCompare(dateB);
            });
            
            sortedKeys.forEach(key => {
                const group = groupedTrials[key];
                html += `
                    <div class="trial-class-group">
                        <h5>${group.className} - ${formatDate(group.date)}</h5>
                        <div class="round-options">
                `;
                
                group.rounds.forEach(round => {
                    html += `
                        <div class="round-option">
                            <label class="round-label">
                                <input type="checkbox" name="trialSelection" value="${round.index}-regular">
                                Round ${round.roundNum} - ${round.judge}
                            </label>
                    `;
                    
                    if (round.feoOffered) {
                        html += `
                            <label class="feo-label">
                                <input type="checkbox" name="trialSelection" value="${round.index}-feo">
                                Round ${round.roundNum} - FEO
                            </label>
                        `;
                    }
                    
                    html += '</div>';
                });
                
                html += '</div></div>';
            });
            
            html += '</div>';
            container.innerHTML = html;
        }

        // Handle main entry form submission
        function handleMainEntrySubmission(event) {
            event.preventDefault();
            
            const regNumber = document.getElementById('entryRegNumber').value.trim();
            const handler = document.getElementById('entryHandler').value.trim();
            const callName = document.getElementById('entryCallName').value.trim() || 'Unknown';
            const email = document.getElementById('entryEmail').value.trim();
            
            // Get selected trials
            const selectedTrials = Array.from(document.querySelectorAll('input[name="trialSelection"]:checked'));
            
            // Validate
            if (!regNumber || !handler) {
                showStatusMessage('Please fill in registration number and handler name', 'error');
                return;
            }
            
            if (selectedTrials.length === 0) {
                showStatusMessage('Please select at least one trial entry', 'error');
                return;
            }
            
            // Process entries
            const newEntries = [];
            selectedTrials.forEach(checkbox => {
                const [configIndex, entryType] = checkbox.value.split('-');
                const config = trialConfig[parseInt(configIndex)];
                
                const entry = {
                    regNumber: regNumber,
                    registration: regNumber, // For compatibility
                    handler: handler,
                    callName: callName,
                    email: email,
                    date: config.date,
                    className: config.className,
                    round: config.roundNum,
                    judge: config.judge,
                    entryType: entryType,
                    timestamp: new Date().toISOString()
                };
                
                newEntries.push(entry);
            });
            
            // Add to results
            entryResults.push(...newEntries);
            
            // Save and update displays
            saveTrialUpdates();
            updateResultsDisplay();
            updateCrossReferenceDisplay();
            
            // Clear form
            clearMainEntryForm();
            
            showStatusMessage(`Successfully entered ${newEntries.length} entries for ${handler}`, 'success');
        }

        // Clear the main entry form
        function clearMainEntryForm() {
            document.getElementById('entryRegNumber').value = '';
            document.getElementById('entryHandler').value = '';
            document.getElementById('entryCallName').value = '';
            document.getElementById('entryEmail').value = '';
            
            // Uncheck all trial selections
            document.querySelectorAll('input[name="trialSelection"]').forEach(checkbox => {
                checkbox.checked = false;
            });
        }

        // CSV Import function
        function importEntriesCSV() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.csv';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    importEntriesFromCSV(input);
                }
            };
            input.click();
        }

        // CSV Export function  
        function exportEntriesCSV() {
            if (entryResults.length === 0) {
                showStatusMessage('No entries to export', 'warning');
                return;
            }
            
            exportEntriesToCSV();
        }

        // Copy URL function
        function copyURL() {
            const urlInput = document.getElementById('shareableURL');
            if (urlInput) {
                urlInput.select();
                urlInput.setSelectionRange(0, 99999); // For mobile devices
                
                try {
                    document.execCommand('copy');
                    showStatusMessage('Entry form URL copied to clipboard!', 'success');
                } catch (err) {
                    showStatusMessage('Could not copy URL automatically. Please copy manually.', 'warning');
                }
            }
        }

        // Initialize when page loads
        window.addEventListener('load', function() {
            // Check if user is logged in
            if (typeof currentUser !== 'undefined' && currentUser) {
                showMainApp();
                loadUserTrials();
            }
        });
    </script>
</body>
</html>
